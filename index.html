<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServeAuto SmartCount CTRL</title>
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg">
    <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --success-color: #10b981;
            --success-bg: #dcfce7;
            --danger: #ef4444;
            --error-color: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --light: #f8fafc;
            --dark: #0f172a;
            --background: #f1f5f9;
            --bg-secondary: #f8fafc;
            --surface: #ffffff;
            --card-bg: #ffffff;
            --text: #334155;
            --text-primary: #334155;
            --text-light: #64748b;
            --border: #e2e8f0;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 0.5rem;
            --sidebar-width: 280px;
            --header-height: 64px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark theme variables */
        [data-theme="dark"] {
            --background: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
            --dark: #f8fafc;
        }

        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition);
        }

        /* ===== LAYOUT STRUCTURE ===== */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--surface);
            border-right: 1px solid var(--border);
            transform: translateX(-100%);
            transition: var(--transition);
            z-index: 1000;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--primary);
            color: white;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }

        .sidebar-brand i {
            font-size: 2rem;
            color: var(--primary);
            min-width: 2rem;
        }

        .brand-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            line-height: 1.2;
            align-items: center;
        }

        .company-name {
            font-size: 1rem;
            font-weight: 700;
            color: #dc3545;
            background: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .app-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            background: #007bff;
            margin: 0.125rem 0;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
        }

        .app-description {
            font-size: 0.625rem;
            font-weight: 400;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.125rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
            flex: 1;
        }

        .nav-group {
            margin-bottom: 2rem;
        }

        .nav-group-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--text);
            text-decoration: none;
            transition: var(--transition);
            position: relative;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--light);
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: white;
        }

        .nav-item i {
            width: 20px;
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            min-width: 1.5rem;
            text-align: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
        }

        .copyright-info {
            text-align: center;
        }

        .copyright-info p {
            margin: 0.25rem 0;
            font-size: 0.75rem;
            color: var(--text-light);
            line-height: 1.2;
        }

        .copyright-info p:first-child {
            font-weight: 600;
            color: var(--text);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: var(--transition);
        }

        .main-content.sidebar-open {
            margin-left: var(--sidebar-width);
        }

        /* ===== HEADER ===== */
        .header {
            position: sticky;
            top: 0;
            height: var(--header-height);
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background: var(--light);
        }

        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breadcrumb-separator {
            color: var(--text-light);
        }

        .header-center {
            flex: 1;
            max-width: 500px;
            margin: 0 2rem;
        }

        .customer-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
        }

        .customer-info i {
            color: var(--primary);
            font-size: 1rem;
        }

        .customer-name {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--text);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--light);
        }

        .notifications {
            position: relative;
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--text);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .notifications:hover {
            background: var(--light);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-right: 1rem;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
        }
        .role-badge {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.125rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 999px;
            background: var(--primary);
            color: #fff;
        }

        /* ===== TABS ===== */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            background: var(--light);
            border: 1px solid var(--border);
            border-bottom: none;
            padding: 1rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 8px 8px 0 0;
            margin-right: 2px;
            position: relative;
            opacity: 0.7;
        }

        .tab-btn:hover {
            color: var(--primary);
            background: var(--white);
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-btn.active {
            color: var(--primary);
            background: var(--white);
            border-color: var(--primary);
            opacity: 1;
            font-weight: 600;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.2);
            z-index: 10;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--white);
            z-index: 11;
        }

        .tab-btn.active i {
            color: var(--primary);
            transform: scale(1.1);
        }

        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--light);
            padding: 0 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 8px 8px 0 0;
        }

        .tab-content {
            display: block;
            background: var(--white);
            border-radius: 0 0 8px 8px;
            position: relative;
        }

        .tab-content.hidden {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.hidden {
            display: none;
        }

        /* ===== EXPORT STYLES ===== */
        .export-section h4 {
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .export-section p {
            margin-bottom: 2rem;
            color: var(--text-light);
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .export-group h5 {
            margin-bottom: 1rem;
            color: var(--text);
            font-size: 1rem;
        }

        .export-group .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .export-info {
            background: var(--light);
            padding: 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .info-item {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text);
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        /* ===== CONTAGEM PAGE STYLES ===== */
        .page-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filters-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .search-group {
            position: relative;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .search-input-wrapper .form-input {
            padding-left: 2.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        /* ===== DATA TABLE ===== */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg);
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--text);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table td {
            color: var(--text);
            font-size: 0.875rem;
        }

        .data-table tbody tr:hover {
            background: var(--light);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-badge.active {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.completed {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.paused {
            background: #fef3c7;
            color: #92400e;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container {
            width: 100px;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.75rem;
        }

        .action-btn.edit {
            background: #dbeafe;
            color: #1e40af;
        }

        .action-btn.edit:hover {
            background: #bfdbfe;
        }

        .action-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .action-btn.delete:hover {
            background: #fecaca;
        }

        .action-btn.status {
            background: #fef3c7;
            color: #92400e;
        }

        .action-btn.status:hover {
            background: #fde68a;
        }

        /* ===== LOADING AND EMPTY STATES ===== */
        .loading-state,
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
        }

        .loading-state i,
        .empty-state i {
            font-size: 3rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .loading-state span,
        .empty-state h3 {
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-light);
            margin: 0;
        }

        .loading-state.hidden,
        .empty-state.hidden {
            display: none;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .filters-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .page-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .data-table {
                font-size: 0.75rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
            }
        }

        /* ===== CONTENT AREA ===== */
        .content {
            padding: 2rem;
            min-height: calc(100vh - var(--header-height));
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-light);
            font-size: 1rem;
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-footer {
            padding: 1rem 1.5rem;
            background: var(--light);
            border-top: 1px solid var(--border);
        }

        /* ===== GRID SYSTEM ===== */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: var(--transition);
            background: var(--surface);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: var(--surface);
            cursor: pointer;
        }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.primary {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .stat-icon.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-icon.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .stat-icon.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .stat-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* ===== PROGRESS BAR ===== */
        .progress {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .alert-info {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        /* ===== OVERLAY ===== */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }

        /* ===== RESPONSIVE ===== */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .sidebar-toggle {
                display: none;
            }

            .header-center {
                display: block;
            }

            .grid-md-2 { grid-template-columns: repeat(2, 1fr); }
            .grid-md-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-md-4 { grid-template-columns: repeat(4, 1fr); }
        }

        @media (max-width: 767px) {
            .content {
                padding: 1rem;
            }

            .header {
                padding: 0 1rem;
            }

            .header-center {
                display: none;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== SKELETON LOADING ===== */
        .skeleton {
            background: linear-gradient(90deg, var(--light) 25%, rgba(255,255,255,0.5) 50%, var(--light) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            padding: 1rem;
            min-width: 300px;
            transform: translateX(100%);
            transition: var(--transition);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .toast-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .toast-body {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* ===== AUTH STYLES ===== */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1rem;
        }

        .auth-card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo {
            width: 60px;
            height: 60px;
            background: transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
        }
        .auth-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: block;
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-weight: 500;
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        /* ===== PRODUCT LIST ===== */
        .product-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .product-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .product-item:hover {
            background: var(--light);
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-info {
            flex: 1;
        }

        .product-code {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .product-desc {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .product-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.counted {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .count-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ===== SESSION LIST ===== */
        .session-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .session-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .session-item:hover {
            background: var(--light);
        }

        .session-item:last-child {
            border-bottom: none;
        }

        .session-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .session-name {
            font-weight: 600;
            color: var(--text);
        }

        .session-type {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .session-type.normal {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .session-type.avulsa {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .session-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .session-action-btn {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .empty-state-desc {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* ===== SCAN HISTORY ===== */
        .scan-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .scan-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .scan-item:last-child {
            border-bottom: none;
        }

        .scan-code {
            font-weight: 600;
            color: var(--text);
        }

        .scan-qty {
            background: var(--secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ===== COUNT TYPE INDICATOR ===== */
        .count-type-indicator {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--info);
        }

        .count-type-indicator.arquivo {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-color: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .count-type-indicator.avulsa {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border-color: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        /* ===== SYNC CONTROLS ===== */
        .sync-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .sync-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .sync-btn:hover {
            background: #059669;
        }

        .sync-btn:disabled {
            background: var(--secondary);
            cursor: not-allowed;
        }

        .sync-btn.syncing {
            background: var(--warning);
            color: var(--dark);
        }

        .sync-btn.syncing i {
            animation: spin 1s linear infinite;
        }

        .sync-status {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .sync-status.success {
            color: var(--success);
        }

        .sync-status.error {
            color: var(--danger);
        }

        /* ===== EXPORT FIELDS ===== */
        .export-fields-group {
            margin-top: 1.5rem;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--light);
        }

        .export-fields-group legend {
            font-weight: 600;
            padding: 0 0.5rem;
            color: var(--text);
        }

        .checkbox-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
        }

        /* Sidebar Styles */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            transition: right 0.3s ease-in-out;
            backdrop-filter: blur(4px);
        }

        .sidebar-overlay.active {
            right: 0;
        }

        .sidebar-content {
            position: absolute;
            right: 0;
            top: 0;
            width: 480px;
            max-width: 90vw;
            height: 100vh;
            background: var(--card-bg);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-overlay.active .sidebar-content {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            color: white;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sidebar-header h3 i {
            margin-right: 0.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-body {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            background: var(--bg-secondary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-control:required:invalid {
            border-color: var(--error-color);
        }

        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .file-upload-content i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .file-upload-content p {
            margin: 0.5rem 0;
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-upload-content small {
            color: var(--text-light);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--success-bg);
            border: 1px solid var(--success-color);
            border-radius: 6px;
            margin-top: 1rem;
        }

        .file-info i {
            color: var(--success-color);
        }

        .import-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--success-bg);
            border: 1px solid var(--success-color);
            border-radius: 6px;
            margin-top: 1rem;
            color: var(--success-color);
        }

        .form-info {
            background: #e0f2fe;
            border: 1px solid #0288d1;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            color: #01579b;
        }

        .form-info i {
            color: #0288d1;
            margin-right: 0.5rem;
        }

        .form-info code {
            background: #ffffff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            border: 1px solid #b3e5fc;
        }

        .form-info small {
            color: #0277bd;
            font-style: italic;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar-content {
                width: 100vw;
                max-width: 100vw;
            }
            
            .sidebar-header,
            .sidebar-body,
            .sidebar-footer {
                padding: 1rem;
            }
            
            .sidebar-footer {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* ===== CONFIGURATION FORMS STYLES ===== */
        .config-form {
            max-width: 100%;
            margin: 0;
        }

        .config-form .form-group {
            margin-bottom: 2rem;
        }

        .config-form .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .config-form .form-label i {
            color: var(--primary);
            font-size: 1.1rem;
        }

        .layout-config {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 0.5rem;
        }

        .field-group {
            margin-bottom: 1.5rem;
        }

        .field-group:last-child {
            margin-bottom: 0;
        }

        .field-group h4 {
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary);
            display: inline-block;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: var(--transition);
            position: relative;
        }

        .checkbox-item:hover:not(.disabled) {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .checkbox-item.disabled {
            background: var(--light);
            opacity: 0.8;
            cursor: not-allowed;
        }

        .checkbox-item input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .checkbox-item.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }

        .checkbox-item label {
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            flex: 1;
        }

        .checkbox-item.disabled label {
            cursor: not-allowed;
            color: var(--text-light);
        }

        .required-badge {
            background: var(--success);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .form-actions .btn {
            flex: 1;
            max-width: 200px;
        }

        .message-area {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--radius);
            display: none;
        }

        .message-area.success {
            background: var(--success-bg);
            border: 1px solid var(--success);
            color: var(--success);
            display: block;
        }

        .message-area.error {
            background: #fef2f2;
            border: 1px solid var(--danger);
            color: var(--danger);
            display: block;
        }

        .message-area.info {
            background: #f0f9ff;
            border: 1px solid var(--info);
            color: var(--info);
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                max-width: none;
            }
        }

        /* Messages Styles */
        .message-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-time {
            font-size: 0.75rem;
            color: #6c757d;
            min-width: 3rem;
            margin-right: 0.75rem;
        }

        .message-content {
            flex: 1;
        }

        .message-user {
            font-weight: 600;
            font-size: 0.875rem;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .message-text {
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* Chart Styles */
        .chart-container {
            position: relative;
            height: 200px;
            margin-bottom: 1rem;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* ===== STATISTICS PAGE STYLES ===== */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-card.success .stat-value {
            color: #28a745;
        }

        .stat-card.warning .stat-value {
            color: #ffc107;
        }

        .stat-card.danger .stat-value {
            color: #dc3545;
        }

        .stats-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .stats-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .stats-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 600;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .stats-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        .stats-table tr:hover {
            background: var(--bg-hover);
        }

        .variance-positive {
            color: #28a745;
            font-weight: 600;
        }

        .variance-negative {
            color: #dc3545;
            font-weight: 600;
        }

        .variance-zero {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.contado {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.pendente {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.divergente {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .stats-summary {
                grid-template-columns: 1fr;
            }
            
            .stats-filters {
                flex-direction: column;
            }
            
            .stats-table {
                overflow-x: auto;
            }
            
            .stats-table table {
                min-width: 800px;
            }
        }
        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
            color: #fff;
        }
        .badge-success {
            background-color: var(--success);
            color: white;
        }
        .badge-warning {
            background-color: var(--warning);
            color: #212529;
        }
        .badge-danger {
            background-color: var(--danger);
            color: white;
        }

    </style>
</head>
<body>
    <div id="app">
        <!-- Auth Section -->
        <div id="auth-section" class="auth-container">
                <div class="auth-card">
                    <div class="auth-header">
                        <div class="auth-logo">
                            <img src="LogoMarca-web-app-manifest-192x192.png" alt="Logo ServeAuto" />
                        </div>
                        <h1 class="auth-title">SmartCount CTRL</h1>
                        <p class="auth-subtitle">Sistema Inteligente de Contagem de Estoque</p>
                    </div>

                <div class="auth-tabs">
                    <div class="auth-tab active" id="login-tab">Login</div>
                </div>

                <div id="login-form">
                    <div class="form-group">
                        <label class="form-label" for="usuario-email">E-mail do Usurio</label>
                        <input type="email" id="usuario-email" class="form-input" placeholder="Seu e-mail de usurio" />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">Senha</label>
                        <input type="password" id="password" class="form-input" placeholder="Sua senha" />
                    </div>
                    <button id="login-btn" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </div>

                <div id="auth-message" class="alert hidden"></div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="app-layout hidden">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-brand">
                        <i class="fas fa-boxes"></i>
                        <div class="brand-info">
                            <div class="company-name">ServeAuto</div>
                            <div class="app-name">SmartCount CTRL</div>
                            <div class="app-description">Contagem Inteligente de Estoque</div>
                        </div>
                    </div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-group">
                        <div class="nav-group-title">Dashboard</div>
                        <a href="#" class="nav-item active" data-page="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Viso Geral</span>
                        </a>
                    </div>
                    <div class="nav-group">
                        <div class="nav-group-title">Operaes</div>
                        <a href="#" class="nav-item" data-page="contagem">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Contagem</span>
                            <span class="nav-badge" id="counting-badge" style="display: none;">1</span>
                        </a>

                        <a href="#" class="nav-item" data-page="produtos">
                            <i class="fas fa-boxes"></i>
                            <span>Produtos</span>
                            <span class="nav-badge" id="products-badge" style="display: none;">0</span>
                        </a>
                    </div>
                    <div class="nav-group">
                        <div class="nav-group-title">Estatsticas</div>

                        <a href="#" class="nav-item" data-page="estatisticas">
                            <i class="fas fa-chart-bar"></i>
                            <span>Estatsticas</span>
                        </a>
                    </div>
                    <div class="nav-group">
                        <div class="nav-group-title">Sistema</div>
                        <a href="#" class="nav-item" data-page="configuracao">
                            <i class="fas fa-cog"></i>
                            <span>Configurao</span>
                        </a>
                        <a href="#" class="nav-item" id="logout-nav">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sair</span>
                        </a>
                    </div>
                </nav>
                <div class="sidebar-footer">
                    <div class="copyright-info">
                        <p>ServeAuto SmartCount  2026</p>
                        <p>Contagem Inteligente de Estoque</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content" id="main-content">
                <!-- Header -->
                <header class="header">
                    <div class="header-left">
                        <button class="sidebar-toggle" id="sidebar-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="breadcrumbs" id="breadcrumbs">
                            <div class="breadcrumb-item">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard</span>
                            </div>
                        </div>
                    </div>
                    <div class="header-center">
                        <div class="customer-info">
                            <i class="fas fa-building"></i>
                            <span class="customer-name" id="customer-name">Cliente</span>
                        </div>
                    </div>
                    <div class="header-right">
                        <div class="user-info">
                            <span class="user-name" id="user-name">Usurio</span>
                            <span class="role-badge" id="role-badge" style="display: none;">Admin</span>
                        </div>
                        <button class="theme-toggle" id="theme-toggle" title="Alternar tema">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button class="notifications" id="notifications" title="Notificaes">
                            <i class="fas fa-bell"></i>
                            <div class="notification-badge" id="notification-badge" style="display: none;"></div>
                        </button>
                        <div class="user-menu">
                            <div class="user-avatar" id="user-avatar" title="Menu do usurio">
                                <span id="user-initials">U</span>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Content Area -->
                <div class="content">
                    <!-- Dashboard Page -->
                    <div id="dashboard-page" class="page active">
                        <div class="page-header">
                            <h1 class="page-title">Dashboard</h1>
                            <p class="page-subtitle">Viso geral do sistema de contagem</p>
                        </div>

                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Total de Produtos</div>
                                    <div class="stat-icon primary">
                                        <i class="fas fa-boxes"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="dashboard-total-items">0</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Produtos importados</span>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Produtos Contados</div>
                                    <div class="stat-icon success">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="dashboard-counted-items">0</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Contagem realizada</span>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Itens Bipados</div>
                                    <div class="stat-icon warning">
                                        <i class="fas fa-barcode"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="dashboard-scanned-items">0</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Bipagens realizadas</span>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Progresso</div>
                                    <div class="stat-icon primary">
                                        <i class="fas fa-chart-pie"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="dashboard-progress">0%</div>
                                <div class="progress">
                                    <div class="progress-bar" id="dashboard-progress-bar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="grid grid-cols-1 grid-md-2">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-comments"></i>
                                        ltimas Mensagens
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div id="latest-messages">
                                        <div class="message-item">
                                            <div class="message-time">14:30</div>
                                            <div class="message-content">
                                                <div class="message-user">Sistema</div>
                                                <div class="message-text">Sesso de contagem iniciada</div>
                                            </div>
                                        </div>
                                        <div class="message-item">
                                            <div class="message-time">14:25</div>
                                            <div class="message-content">
                                                <div class="message-user">Joo Silva</div>
                                                <div class="message-text">Produto ABC123 contado</div>
                                            </div>
                                        </div>
                                        <div class="message-item">
                                            <div class="message-time">14:20</div>
                                            <div class="message-content">
                                                <div class="message-user">Maria Santos</div>
                                                <div class="message-text">Arquivo CSV importado com sucesso</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-chart-bar"></i>
                                        Descrio da mensagem
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div id="sessions-users-chart">
                                        <div class="chart-container">
                                            <canvas id="sessionsUsersCanvas" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other pages will be added here -->
                    <div id="configuracao-page" class="page hidden">
                        <div class="page-header">
                            <h1 class="page-title">Configurao</h1>
                            <p class="page-subtitle">Configure sua sesso de contagem e exportaes</p>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="tab-nav">
                                    <button class="tab-btn active" data-tab="contagens">
                                        <i class="fas fa-cog"></i> Configurar Contagens
                                    </button>
                                    <button class="tab-btn" data-tab="exportacoes">
                                        <i class="fas fa-file-export"></i> Configurar Exportaes
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Tab: Configurar Contagens -->
                                <div id="contagens-tab" class="tab-content active">
                                    <form id="form-configurar-contagens" class="config-form">
                                        <!-- Tipo de Contagem Padro -->
                                        <div class="form-group">
                                            <label for="tipo-contagem-padrao" class="form-label">
                                                <i class="fas fa-list-alt"></i> Tipo de Contagem Padro
                                            </label>
                                            <select id="tipo-contagem-padrao" name="tipo_contagem_padrao" class="form-select" required>
                                                <option value="normal">Normal</option>
                                                <option value="avulsa">Avulsa</option>
                                            </select>
                                        </div>

                                        <!-- Layout do Arquivo de Importao -->
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-file-import"></i> Layout do Arquivo de Importao
                                            </label>
                                            <div class="layout-config">
                                                <div class="field-group">
                                                    <h4>Campos Obrigatrios</h4>
                                                    <div class="checkbox-group">
                                                        <div class="checkbox-item disabled">
                                                            <input type="checkbox" id="importacao-codigo" name="importacao_incluir_codigo" checked disabled>
                                                            <label for="importacao-codigo">Cdigo</label>
                                                            <span class="required-badge">Obrigatrio</span>
                                                        </div>
                                                        <div class="checkbox-item disabled">
                                                            <input type="checkbox" id="importacao-quantidade" name="importacao_incluir_quantidade" checked disabled>
                                                            <label for="importacao-quantidade">Quantidade</label>
                                                            <span class="required-badge">Obrigatrio</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="field-group">
                                                    <h4>Campos Opcionais</h4>
                                                    <div class="checkbox-group">
                                                        <div class="checkbox-item">
                                                            <input type="checkbox" id="importacao-descricao" name="importacao_incluir_descricao">
                                                            <label for="importacao-descricao">Descrio</label>
                                                        </div>
                                                        <div class="checkbox-item">
                                                            <input type="checkbox" id="importacao-localizacao" name="importacao_incluir_localizacao">
                                                            <label for="importacao-localizacao">Localizao</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-info">
                                                <i class="fas fa-info-circle"></i>
                                                <strong>Formato esperado do CSV:</strong>
                                                <code>codigo,descricao,quantidade,localizacao</code>
                                                <br><small>Exemplo: PROD001,Produto Teste,10,A1-B2</small>
                                            </div>
                                        </div>

                                        <!-- Tipo de Arquivo de Importao Padro -->
                                        <div class="form-group">
                                            <label for="tipo-importacao-padrao" class="form-label">
                                                <i class="fas fa-file-alt"></i> Tipo de Arquivo de Importao Padro
                                            </label>
                                            <select id="tipo-importacao-padrao" name="tipo_importacao_padrao" class="form-select" required>
                                                <option value="csv">CSV</option>
                                                <option value="txt">TXT</option>
                                            </select>
                                        </div>

                                        <!-- Botes de Ao -->
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> Salvar Configuraes
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="resetFormContagens()">
                                                <i class="fas fa-undo"></i> Restaurar Padres
                                            </button>
                                        </div>

                                        <!-- rea de Mensagens -->
                                        <div id="message-contagens" class="message-area"></div>
                                    </form>
                                </div>
                                
                                <!-- Tab: Configurar Exportaes -->
                                <div id="exportacoes-tab" class="tab-content hidden">
                                    <form id="form-configurar-exportacoes" class="config-form">
                                        <!-- Tipo de Exportao -->
                                        <div class="form-group">
                                            <label for="tipo-exportacao" class="form-label">
                                                <i class="fas fa-chart-bar"></i> Tipo de Exportao
                                            </label>
                                            <select id="tipo-exportacao" name="tipo_exportacao" class="form-select" required>
                                                <option value="agrupada">Agrupada</option>
                                                <option value="detalhada">Detalhada</option>
                                            </select>
                                        </div>

                                        <!-- Layout do Arquivo de Exportao -->
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-file-export"></i> Layout do Arquivo de Exportao
                                            </label>
                                            <div class="layout-config">
                                                <div class="field-group">
                                                    <h4>Campos Obrigatrios</h4>
                                                    <div class="checkbox-group">
                                                        <div class="checkbox-item disabled">
                                                            <input type="checkbox" id="exportacao-codigo" name="exportacao_incluir_codigo" checked disabled>
                                                            <label for="exportacao-codigo">Cdigo</label>
                                                            <span class="required-badge">Obrigatrio</span>
                                                        </div>
                                                        <div class="checkbox-item disabled">
                                                            <input type="checkbox" id="exportacao-quantidade" name="exportacao_incluir_quantidade" checked disabled>
                                                            <label for="exportacao-quantidade">Quantidade</label>
                                                            <span class="required-badge">Obrigatrio</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="field-group">
                                                    <h4>Campos Opcionais</h4>
                                                    <div class="checkbox-group">
                                                        <div class="checkbox-item">
                                                            <input type="checkbox" id="exportacao-descricao" name="exportacao_incluir_descricao">
                                                            <label for="exportacao-descricao">Descrio</label>
                                                        </div>
                                                        <div class="checkbox-item">
                                                            <input type="checkbox" id="exportacao-localizacao" name="exportacao_incluir_localizacao">
                                                            <label for="exportacao-localizacao">Localizao</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tipo de Arquivo de Exportao Padro -->
                                        <div class="form-group">
                                            <label for="tipo-exportacao-padrao" class="form-label">
                                                <i class="fas fa-file-alt"></i> Tipo de Arquivo de Exportao Padro
                                            </label>
                                            <select id="tipo-exportacao-padrao" name="tipo_exportacao_padrao" class="form-select" required>
                                                <option value="csv">CSV</option>
                                                <option value="txt">TXT</option>
                                            </select>
                                        </div>

                                        <!-- Botes de Ao -->
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> Salvar Configuraes
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="resetFormExportacoes()">
                                                <i class="fas fa-undo"></i> Restaurar Padres
                                            </button>
                                        </div>

                                        <!-- rea de Mensagens -->
                                        <div id="message-exportacoes" class="message-area"></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contagem Page -->
                    <div id="contagem-page" class="page hidden" data-page="contagem">
                        <div class="page-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: baseline; gap: 1rem;">
                                <h1 class="page-title" style="margin: 0;">Gerenciar Contagens</h1>
                                <p class="page-subtitle" style="margin: 0; font-size: 0.9rem; color: var(--text-light);">Gerencie suas sesses de contagem</p>
                            </div>
                            <div class="page-actions">
                                <button id="new-session-btn" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Nova Contagem
                                </button>
                            </div>
                        </div>

                        <!-- Filters and Search -->
                        <div class="card">
                            <div class="card-body">
                                <div class="filters-row">
                                    <div class="search-group">
                                        <div class="search-input-wrapper">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="session-search" class="form-input" placeholder="Pesquisar por nome da sesso...">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <select id="status-filter" class="form-select">
                                            <option value="">Todos os Status</option>
                                            <option value="active">Ativas</option>
                                            <option value="completed">Concludas</option>
                                            <option value="waiting">Aguardando</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <select id="user-filter" class="form-select">
                                            <option value="">Todos os Usurios</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <button id="clear-filters-btn" class="btn btn-outline">
                                            <i class="fas fa-times"></i> Limpar Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sessions Grid -->
                        <div class="card">
                            <div class="card-header" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem;">
                                <h3 style="margin: 0;">Sesses de Contagem</h3>
                                <div class="card-actions">
                                    <button id="refresh-sessions-btn" class="btn btn-outline">
                                        <i class="fas fa-sync-alt"></i> Atualizar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table id="sessions-table" class="data-table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nome da Sesso</th>
                                                <th>Usurio</th>
                                                <th>Tipo</th>
                                                <th>Status</th>
                                                <th>Total Itens</th>
                                                <th>Contados</th>
                                                <th>Progresso</th>
                                                <th>Criado em</th>
                                                <th>Aes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sessions-tbody">
                                            <!-- Sessions will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="sessions-loading" class="loading-state hidden">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Carregando sesses...</span>
                                </div>
                                <div id="sessions-empty" class="empty-state hidden">
                                    <i class="fas fa-clipboard-list"></i>
                                    <h3>Nenhuma sesso encontrada</h3>
                                    <p>Crie uma nova sesso de contagem para comear</p>
                                </div>
                                
                                <!-- Pagination -->
                                <div class="pagination-container">
                                    <div class="pagination-info">
                                        <span id="sessions-pagination-info">Mostrando 0 a 0 de 0 sesses</span>
                                    </div>
                                    <div class="pagination-controls">
                                        <button id="sessions-prev-btn" class="btn btn-outline" onclick="goToSessionsPreviousPage()" disabled>
                                             <i class="fas fa-chevron-left"></i> Anterior
                                         </button>
                                         <span id="sessions-page-info" class="page-info">Pgina 1 de 1</span>
                                         <button id="sessions-next-btn" class="btn btn-outline" onclick="goToSessionsNextPage()" disabled>
                                             Prxima <i class="fas fa-chevron-right"></i>
                                         </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Produtos Page -->
                    <div id="produtos-page" class="page hidden" data-page="produtos">
                        <div class="page-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: baseline; gap: 1rem;">
                                <h1 class="page-title" style="margin: 0;">Consultar Produtos</h1>
                                <p class="page-subtitle" style="margin: 0; font-size: 0.9rem; color: var(--text-light);">Visualize e gerencie os produtos cadastrados</p>
                            </div>
                            <div class="page-actions">
                                <button id="refresh-products-btn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt"></i> Atualizar
                                </button>
                            </div>
                        </div>

                        <!-- Filters and Search -->
                        <div class="card">
                            <div class="card-body">
                                <div class="filters-row">
                                    <div class="search-group">
                                        <div class="search-input-wrapper">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="product-search" class="form-input" placeholder="Pesquisar por cdigo ou descrio...">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <select id="session-filter" class="form-select">
                                            <option value="">Todas as Sesses</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <select id="counted-filter" class="form-select">
                                            <option value="">Todos os Status</option>
                                            <option value="true">Contados</option>
                                            <option value="false">No Contados</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <button id="clear-products-filters-btn" class="btn btn-outline">
                                            <i class="fas fa-times"></i> Limpar Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Products Grid -->
                        <div class="card">
                            <div class="card-header" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem;">
                                <h3 style="margin: 0;">Lista de Produtos</h3>
                                <div class="card-actions">
                                    <button id="export-products-btn" class="btn btn-outline">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table id="products-table" class="data-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="codigo">Cdigo <i class="fas fa-sort"></i></th>
                                                <th data-sort="descricao">Descrio <i class="fas fa-sort"></i></th>
                                                <th data-sort="localizacao">Localizao <i class="fas fa-sort"></i></th>
                                                <th data-sort="quantidade_atual">Qtd. Atual <i class="fas fa-sort"></i></th>
                                                <th data-sort="quantidade_contada">Qtd. Contada <i class="fas fa-sort"></i></th>
                                                <th data-sort="scanned_qty">Qtd. Bipada <i class="fas fa-sort"></i></th>
                                                <th data-sort="is_counted">Status <i class="fas fa-sort"></i></th>
                                                <th data-sort="created_at">Data Criao <i class="fas fa-sort"></i></th>
                                                <th>Aes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="products-table-body">
                                            <!-- Products will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div class="pagination-container">
                                    <div class="pagination-info">
                                        <span id="products-pagination-info">Mostrando 0 de 0 produtos</span>
                                    </div>
                                    <div class="pagination-controls">
                                        <button id="products-prev-btn" class="btn btn-outline" disabled>
                                            <i class="fas fa-chevron-left"></i> Anterior
                                        </button>
                                        <span id="products-page-info">Pgina 1 de 1</span>
                                        <button id="products-next-btn" class="btn btn-outline" disabled>
                                            Prxima <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Empty State -->
                                <div id="products-empty-state" class="empty-state hidden">
                                    <i class="fas fa-boxes empty-state-icon"></i>
                                    <h3>Nenhum produto encontrado</h3>
                                    <p>Importe produtos ou ajuste os filtros de busca</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estatsticas Page -->
                    <div id="estatisticas-page" class="page hidden" data-page="estatisticas">
                        <div class="page-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: baseline; gap: 1rem;">
                                <h1 class="page-title" style="margin: 0;">Estatsticas de Contagem</h1>
                                <p class="page-subtitle" style="margin: 0; font-size: 0.9rem; color: var(--text-light);">Anlise detalhada das contagens por produto</p>
                            </div>
                            <div class="page-actions">
                                <button id="refresh-statistics-btn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt"></i> Atualizar
                                </button>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="card">
                            <div class="card-body">
                                <div class="filters-row">
                                    <div class="filter-group">
                                        <label for="statistics-session-filter">Sesso:</label>
                                        <select id="statistics-session-filter" class="form-select">
                                            <option value="">Todas as Sesses</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label for="statistics-status-filter">Status:</label>
                                        <select id="statistics-status-filter" class="form-select">
                                            <option value="">Todos</option>
                                            <option value="counted">Contados</option>
                                            <option value="not-counted">No Contados</option>
                                            <option value="variance">Com Variao</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <button id="clear-statistics-filters-btn" class="btn btn-outline">
                                            <i class="fas fa-times"></i> Limpar Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="card">
                                <div class="card-body">
                                    <div class="stat-item">
                                        <div class="stat-icon" style="background: var(--primary-color); color: white;">
                                            <i class="fas fa-boxes"></i>
                                        </div>
                                        <div class="stat-content">
                                            <h3 id="total-products-stat">0</h3>
                                            <p>Total de Produtos</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <div class="stat-item">
                                        <div class="stat-icon" style="background: var(--success-color); color: white;">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div class="stat-content">
                                            <h3 id="counted-products-stat">0</h3>
                                            <p>Produtos Contados</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <div class="stat-item">
                                        <div class="stat-icon" style="background: var(--warning-color); color: white;">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <div class="stat-content">
                                            <h3 id="variance-products-stat">0</h3>
                                            <p>Com Variao</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <div class="stat-item">
                                        <div class="stat-icon" style="background: var(--info-color); color: white;">
                                            <i class="fas fa-percentage"></i>
                                        </div>
                                        <div class="stat-content">
                                            <h3 id="accuracy-stat">0%</h3>
                                            <p>Preciso Geral</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Statistics Grid -->
                        <div class="card">
                            <div class="card-header" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem;">
                                <h3 style="margin: 0;">Estatsticas por Produto</h3>
                                <div class="card-actions">
                                    <button id="export-statistics-btn" class="btn btn-outline">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table id="statistics-table" class="data-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="codigo">Cdigo <i class="fas fa-sort"></i></th>
                                                <th data-sort="descricao">Descrio <i class="fas fa-sort"></i></th>
                                                <th data-sort="expected_qty">Qtd. Esperada <i class="fas fa-sort"></i></th>
                                                <th data-sort="quantidade_contada">Qtd. Contada <i class="fas fa-sort"></i></th>
                                                <th data-sort="scanned_qty">Qtd. Bipada <i class="fas fa-sort"></i></th>
                                                <th data-sort="variance">Variao <i class="fas fa-sort"></i></th>
                                                <th data-sort="variance_percent">Variao % <i class="fas fa-sort"></i></th>
                                                <th data-sort="status">Status <i class="fas fa-sort"></i></th>
                                                <th data-sort="session_name">Sesso <i class="fas fa-sort"></i></th>
                                            </tr>
                                        </thead>
                                        <tbody id="statistics-table-body">
                                            <!-- Statistics will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div class="pagination-container">
                                    <div class="pagination-info">
                                        <span id="statistics-pagination-info">Mostrando 0 de 0 produtos</span>
                                    </div>
                                    <div class="pagination-controls">
                                        <button id="statistics-prev-btn" class="btn btn-outline" disabled>
                                            <i class="fas fa-chevron-left"></i> Anterior
                                        </button>
                                        <span id="statistics-page-info">Pgina 1 de 1</span>
                                        <button id="statistics-next-btn" class="btn btn-outline" disabled>
                                            Prxima <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Empty State -->
                                <div id="statistics-empty-state" class="empty-state hidden">
                                    <i class="fas fa-chart-bar empty-state-icon"></i>
                                    <h3>Nenhuma estatstica encontrada</h3>
                                    <p>Importe produtos e realize contagens para visualizar as estatsticas</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add other pages here... -->
                </div>
            </main>
        </div>

        <!-- Overlay -->
        <div class="overlay" id="overlay"></div>

        <!-- Toast Container -->
        <div class="toast-container" id="toast-container"></div>
    </div>

    <!-- Sidebar para Auditoria de Scans -->
    <div id="scan-audit-sidebar" class="sidebar-overlay">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h3><i class="fas fa-barcode"></i> Auditoria de Scans</h3>
                <button id="close-audit-sidebar-btn" class="close-btn" onclick="closeAuditSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="sidebar-body" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div id="scan-audit-product-info" style="padding: 1rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border); flex-shrink: 0;">
                    <!-- Info do produto ser inserida aqui via JS -->
                    <div class="skeleton-line" style="width: 60%; height: 20px; margin-bottom: 8px;"></div>
                    <div class="skeleton-line" style="width: 40%; height: 16px;"></div>
                </div>
                
                <div class="table-container" style="flex-grow: 1; overflow-y: auto; padding: 0;">
                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: var(--bg-primary); z-index: 1;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border);">Data/Hora</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border);">Cdigo Lido</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border);">Qtd</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border);">Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="scan-audit-table-body">
                            <!-- Rows sero inseridas aqui via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="sidebar-footer" style="flex-shrink: 0;">
                <button type="button" onclick="closeAuditSidebar()" class="btn btn-secondary" style="width: 100%;">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://dkpqjtbrmxozynpxdurv.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrcHFqdGJybXhvenlucHhkdXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjIyNDUsImV4cCI6MjA3MjIzODI0NX0.EVXv7iH70zDNb_vrILJMVb2ccBWFWA0sAU4CoPSRh54';
        
        const supabaseClient = (window.supabase && window.supabase.createClient)
            ? window.supabase.createClient(supabaseUrl, supabaseAnonKey)
            : null;

        // App state
        let currentUser = null;
        let currentEmpresa = null;
        let currentSession = null;
        let products = [];
        let scans = [];
        let syncInterval = null;

        // DOM elements
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.getElementById('main-content');
        const themeToggle = document.getElementById('theme-toggle');

        // Initialize app
        document.addEventListener('DOMContentLoaded', initApp);

        async function initApp() {
            setupEventListeners();
            if (!supabaseClient) {
                showAuthSection();
                showToast('Falha ao carregar o SDK do Supabase', 'error');
                return;
            }
            showAuthSection();
        }

        // Funo uploadSessionFile no escopo global
        // Funo para alterar status da sesso
                 async function changeSessionStatus(sessionId, currentStatus) {
                     try {
                         // Buscar informaes da sesso
                         const session = allCountingSessions.find(s => s.id === sessionId);
                         if (!session) {
                             showToast('Sesso no encontrada', 'error');
                             return;
                         }

                         let newStatus;
                         let statusText;

                         // Definir transies de status permitidas
                         if (currentStatus === 'waiting') {
                             // De "Aguardando" para "Em andamento"
                             newStatus = 'active';
                             statusText = 'Em andamento';

                             // Validao para tipo normal: deve ter produtos importados
                             if (session.count_type === 'normal' && (!session.total_items || session.total_items === 0)) {
                                 showToast('Para iniciar uma contagem normal,  necessrio importar produtos primeiro', 'warning');
                                 return;
                             }
                         } else if (currentStatus === 'active') {
                             // De "Em andamento" para "Finalizado"
                             newStatus = 'completed';
                             statusText = 'Finalizado';
                         } else {
                             showToast('Transio de status no permitida', 'warning');
                             return;
                         }

                         if (!confirm(`Alterar status para "${statusText}"?`)) return;

                let { error } = await supabaseClient
                    .rpc('update_session_status', { p_session_id: sessionId, p_new_status: newStatus });

                if (error) {
                    const { error: fallbackError } = await supabaseClient
                        .from('counting_sessions')
                        .update({ status: newStatus })
                        .eq('id', sessionId);
                    if (fallbackError) throw fallbackError;
                }

                         showToast(`Status alterado para "${statusText}"!`, 'success');
                         loadCountingSessions();

                     } catch (error) {
                         console.error('Erro ao alterar status:', error);
                         showToast('Erro ao alterar status da sesso', 'error');
                     }
                 }

                 async function uploadSessionFile(sessionId) {
            try {
                // Buscar informaes da sesso
                const session = allCountingSessions.find(s => s.id === sessionId);
                if (!session) {
                    showToast('Sesso no encontrada', 'error');
                    return;
                }
                
                // Verificar se a sesso  do tipo "normal"
                if (session.count_type !== 'normal') {
                    showToast('Upload de arquivo s  permitido para sesses do tipo "normal"', 'warning');
                    return;
                }
                
                // Criar input de arquivo temporrio
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.csv';
                fileInput.style.display = 'none';
                
                // Adicionar ao DOM temporariamente
                document.body.appendChild(fileInput);
                
                // Criar promise para aguardar seleo do arquivo
                const fileSelected = new Promise((resolve) => {
                    fileInput.addEventListener('change', (event) => {
                        const file = event.target.files[0];
                        resolve(file);
                    });
                });
                
                // Abrir dialog de seleo
                fileInput.click();
                
                // Aguardar seleo do arquivo
                const selectedFile = await fileSelected;
                
                // Remover input temporrio
                document.body.removeChild(fileInput);
                
                if (!selectedFile) {
                    return; // Usurio cancelou
                }
                
                // Verificar se o arquivo j foi uploaded antes (PRIMEIRO)
                const fileName = selectedFile.name;
                
                // Verificar se j existe uma sesso com este arquivo (buscar em todas as sesses)
                const { data: existingSessions, error: checkError } = await supabaseClient
                    .from('counting_sessions')
                    .select('id, session_name, arquivo_uploaded, id_usuario, id_empresa')
                    .eq('arquivo_uploaded', fileName)
                    .eq('id_empresa', currentEmpresa.id);
                
                if (checkError) {
                    console.warn('Erro ao verificar arquivos duplicados:', checkError);
                } else if (existingSessions && existingSessions.length > 0) {
                    showToast(`Arquivo "${fileName}" j foi importado anteriormente na sesso "${existingSessions[0].session_name}". No  possvel importar o mesmo arquivo novamente.`, 'error');
                    return;
                }
                
                // Processar arquivo CSV
                const text = await selectedFile.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length === 0) {
                    showToast('Arquivo vazio ou invlido', 'error');
                    return;
                }

                // Formato CSV: codigo,descricao,quantidade,localizacao
                const products = [];
                for (let i = 1; i < lines.length; i++) { // Pular cabealho
                    const [codigo, descricao, quantidade, localizacao] = lines[i].split(',').map(s => s.trim());
                    if (codigo && descricao) {
                        products.push({
                            codigo,
                            descricao,
                            quantidade: quantidade ? parseInt(quantidade) || 0 : 0,
                            localizacao: localizacao || ''
                        });
                    }
                }

                if (products.length === 0) {
                    showToast('Nenhum produto vlido encontrado no arquivo', 'error');
                    return;
                }

                // Preparar dados dos produtos para insero
                const productsToInsert = products.map(p => ({
                    session_id: sessionId,
                    codigo: p.codigo,
                    descricao: p.descricao,
                    localizacao: p.localizacao || null,
                    quantidade_atual: p.quantidade,
                    quantidade_contada: 0,
                    is_counted: false,
                    expected_qty: p.quantidade
                }));

                // Inserir produtos no Supabase com fallback via RPC
                let insertData = null;
                let insertError = null;
                try {
                    const payload = productsToInsert.map(p => ({
                        codigo: p.codigo,
                        descricao: p.descricao,
                        localizacao: p.localizacao,
                        expected_qty: p.expected_qty,
                        quantidade_atual: p.quantidade_atual
                    }));
                    const { data: rpcIns, error: rpcErr } = await supabaseClient.rpc('insert_products_for_session', {
                        p_session_id: sessionId,
                        p_products: payload
                    });
                    insertData = rpcIns;
                    insertError = rpcErr;
                } catch (e) {
                    const { data: insData, error: insErr } = await supabaseClient
                        .from('products')
                        .insert(productsToInsert)
                        .select();
                    insertData = insData;
                    insertError = insErr;
                }

                if (insertError) {
                    console.error('Erro ao inserir produtos:', insertError);
                    showToast('Erro ao importar produtos: ' + insertError.message, 'error');
                    return;
                }

                // Atualizar total de itens na sesso
                let updateError = null;
                try {
                    const { error: rpcUpdErr } = await supabaseClient.rpc('update_session_total', { p_session_id: sessionId });
                    updateError = rpcUpdErr;
                } catch (e) {
                    const { error: updErr } = await supabaseClient
                        .from('counting_sessions')
                        .update({ 
                            total_items: (session.total_items || 0) + products.length
                        })
                        .eq('id', sessionId);
                    updateError = updErr;
                }

                if (updateError) {
                    console.error('Erro ao atualizar sesso:', updateError);
                }

                const insertedCount = Array.isArray(insertData) ? insertData.length : (products?.length || 0);
                showToast(`${insertedCount} produtos importados com sucesso para a sesso!`, 'success');
                
                // Atualizar nome da sesso combinando com o nome do arquivo e salvar nome do arquivo
                try {
                    const nameWithoutExtension = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
                    const currentSessionName = session.session_name || 'Sesso';
                    const newSessionName = `${currentSessionName} (${nameWithoutExtension})`;
                    
                    // Atualizar nome da sesso e arquivo_uploaded via RPC
                    const { error: nameUpdateError } = await supabaseClient.rpc('update_session_file_info', {
                        p_session_id: sessionId,
                        p_file_name: fileName,
                        p_session_name: newSessionName
                    });
                    
                    if (nameUpdateError) {
                        console.warn('Erro ao atualizar sesso:', nameUpdateError);
                    } else {
                        console.log(`Nome da sesso atualizado para: ${newSessionName}`);
                        console.log(`Arquivo salvo: ${fileName}`);
                    }
                } catch (nameError) {
                    console.warn('Erro ao processar nome da sesso:', nameError);
                }
                
                
                // Recarregar dados das sesses
                if (typeof loadCountingSessions === 'function') {
                    loadCountingSessions();
                }
                
            } catch (error) {
                console.error('Erro ao fazer upload do arquivo:', error);
                showToast('Erro ao processar arquivo: ' + error.message, 'error');
            }
        }

        function setupEventListeners() {
            // Sidebar toggle
            sidebarToggle?.addEventListener('click', toggleSidebar);
            overlay?.addEventListener('click', closeSidebar);

            // Theme toggle
            themeToggle?.addEventListener('click', toggleTheme);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;
                    if (page) {
                        navigateToPage(page);
                    } else if (item.id === 'logout-nav') {
                        handleLogout();
                    }
                });
            });

            // Auth tabs
            document.getElementById('login-tab')?.addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('register-tab')?.addEventListener('click', () => switchAuthTab('register'));

            // Auth forms
            document.getElementById('login-btn')?.addEventListener('click', handleLogin);
            document.getElementById('register-btn')?.addEventListener('click', handleRegister);

            // Enter key for auth
            document.getElementById('password')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('login-btn')?.click();
            });
            document.getElementById('reg-password')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('register-btn')?.click();
            });

            // Quick actions
            document.getElementById('quick-start-counting')?.addEventListener('click', () => navigateToPage('contagem'));
            document.getElementById('quick-import-csv')?.addEventListener('click', () => navigateToPage('configuracao'));
            document.getElementById('quick-scan-product')?.addEventListener('click', () => navigateToPage('bipagem'));

            // Configuration tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = btn.dataset.tab;
                    switchConfigTab(tabName);
                });
            });

            // Configuration
            document.getElementById('count-type')?.addEventListener('change', toggleCountType);
            
            // Sidebar count type event listener
            document.getElementById('sidebar-count-type')?.addEventListener('change', toggleSidebarCountType);
            
            // Initialize file import group visibility - hide by default since sidebar-count-type starts empty
            const fileImportGroup = document.getElementById('file-import-group');
            if (fileImportGroup) {
                fileImportGroup.style.display = 'none';
            }
            document.getElementById('import-btn')?.addEventListener('click', handleImport);
            document.getElementById('csv-file')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const fileName = file.name.replace(/\.csv$/i, '');
                    document.getElementById('session-name').value = fileName;
                }
            });

            // Export buttons
            document.getElementById('export-csv-grouped')?.addEventListener('click', () => exportData('csv', 'grouped'));
            document.getElementById('export-csv-detailed')?.addEventListener('click', () => exportData('csv', 'detailed'));
            document.getElementById('export-excel-grouped')?.addEventListener('click', () => exportData('excel', 'grouped'));
            document.getElementById('export-excel-detailed')?.addEventListener('click', () => exportData('excel', 'detailed'));
            document.getElementById('export-pdf')?.addEventListener('click', () => exportData('pdf'));
            document.getElementById('export-session')?.addEventListener('click', () => {
                const sessionSelect = document.getElementById('session-select');
                if (sessionSelect && sessionSelect.value) {
                    exportSessionData(sessionSelect.value);
                }
            });
        }

        function toggleSidebar() {
            sidebar?.classList.toggle('open');
            overlay?.classList.toggle('active');
            mainContent?.classList.toggle('sidebar-open');
        }

        function closeSidebar() {
             sidebar?.classList.remove('open');
             overlay?.classList.remove('active');
             mainContent?.classList.remove('sidebar-open');
         }

         function toggleTheme() {
             const currentTheme = document.documentElement.getAttribute('data-theme');
             const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
             document.documentElement.setAttribute('data-theme', newTheme);
             localStorage.setItem('theme', newTheme);
             
             const icon = themeToggle?.querySelector('i');
             if (icon) {
                 icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
             }
         }

         function navigateToPage(pageName) {
             // Update navigation
             document.querySelectorAll('.nav-item').forEach(item => {
                 item.classList.remove('active');
             });
             document.querySelector(`[data-page="${pageName}"]`)?.classList.add('active');

             // Update pages
             document.querySelectorAll('.page').forEach(page => {
                 page.classList.remove('active');
                 page.classList.add('hidden');
             });
             const targetPage = document.getElementById(`${pageName}-page`);
             if (targetPage) {
                 targetPage.classList.remove('hidden');
                 targetPage.classList.add('active');
             }

             // Update breadcrumbs
             updateBreadcrumbs(pageName);

             // Activate first tab for configuration page
             if (pageName === 'configuracao') {
                 switchConfigTab('contagens');
             }

             // Initialize statistics page
             if (pageName === 'estatisticas') {
                 initStatistics();
             }

             // Close sidebar on mobile
             if (window.innerWidth < 768) {
                 closeSidebar();
             }
         }

         function updateBreadcrumbs(pageName) {
             const breadcrumbs = document.getElementById('breadcrumbs');
             if (!breadcrumbs) return;

             const pageMap = {
                 'dashboard': { icon: 'fas fa-tachometer-alt', title: 'Dashboard' },
                 'configuracao': { icon: 'fas fa-cog', title: 'Configurao' },
                 'contagem': { icon: 'fas fa-clipboard-list', title: 'Contagem' },
                 'bipagem': { icon: 'fas fa-barcode', title: 'Bipagem' },
                 'produtos': { icon: 'fas fa-boxes', title: 'Produtos' },
                 'exportar': { icon: 'fas fa-file-export', title: 'Exportar' },
                 'estatisticas': { icon: 'fas fa-chart-bar', title: 'Estatsticas' }
             };

             const page = pageMap[pageName] || { icon: 'fas fa-home', title: 'Pgina' };
             breadcrumbs.innerHTML = `
                 <div class="breadcrumb-item">
                     <i class="${page.icon}"></i>
                     <span>${page.title}</span>
                 </div>
             `;
         }

         function switchAuthTab(tab) {
             const loginTab = document.getElementById('login-tab');
             const loginForm = document.getElementById('login-form');
             const authMessage = document.getElementById('auth-message');

             if (tab === 'login') {
                 loginTab?.classList.add('active');
                 loginForm?.classList.remove('hidden');
             } else {
                 loginTab?.classList.add('active');
                 loginForm?.classList.remove('hidden');
             }
             authMessage?.classList.add('hidden');
         }

         function switchConfigTab(tabName) {
             // Update tab buttons
             document.querySelectorAll('.tab-btn').forEach(btn => {
                 btn.classList.remove('active');
             });
             document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');

             // Update tab content with animation
             document.querySelectorAll('.tab-content').forEach(content => {
                 content.classList.remove('active');
                 content.classList.add('hidden');
             });
             
             const targetTab = document.getElementById(`${tabName}-tab`);
             if (targetTab) {
                 targetTab.classList.remove('hidden');
                 targetTab.classList.add('active');
             }

             // Load existing configurations when switching tabs
             if (tabName === 'contagens') {
                 loadConfiguracaoContagens();
             } else if (tabName === 'exportacoes') {
                 loadConfiguracaoExportacoes();
             }
         }

         function showAuthSection() {
             authSection?.classList.remove('hidden');
             mainApp?.classList.add('hidden');
         }

         function showMainApp() {
             authSection?.classList.add('hidden');
             mainApp?.classList.remove('hidden');
             navigateToPage('dashboard');
         }

        function updateUserInfo() {
           if (currentUser && currentEmpresa) {
               const userInitials = document.getElementById('user-initials');
               const userName = document.getElementById('user-name');
               const customerName = document.getElementById('customer-name');
               const roleBadge = document.getElementById('role-badge');
               if (userInitials) {
                   const initials = (currentUser.nome || 'Usuario')
                       .split(' ')
                       .map(n => n[0])
                       .join('')
                       .toUpperCase()
                       .substring(0, 2);
                   userInitials.textContent = initials;
               }
               if (userName) {
                   userName.textContent = currentUser.nome || 'Usurio';
               }
               if (roleBadge) {
                   if ((currentUser.role || '').toLowerCase() === 'admin') {
                       roleBadge.textContent = 'Admin';
                       roleBadge.style.display = 'inline-block';
                   } else {
                       roleBadge.style.display = 'none';
                   }
               }
               if (customerName) {
                   customerName.textContent = currentEmpresa.nome || 'Cliente';
               }
           }
       }

        async function handleLogin() {
            if (!supabaseClient) return showToast('SDK do Supabase indisponvel.', 'error');
            const usuarioEmail = document.getElementById('usuario-email')?.value.trim();
            const password = document.getElementById('password')?.value;
            if (!usuarioEmail || !password) {
                return showAuthMessage('Por favor, informe usurio e senha.', 'error');
            }
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.innerHTML = '<div class="loading"></div> Entrando...';
                loginBtn.disabled = true;
            }
            try {
                const { data: signInData, error: authError } = await supabaseClient.auth.signInWithPassword({
                    email: usuarioEmail,
                    password
                });
                if (authError || !signInData?.user) {
                    throw new Error('Falha na autenticao. Verifique e-mail e senha.');
                }
                const authUserId = signInData.user.id;
                let usuario = null;
                let usuarioError = null;
                const respPerfil = await supabaseClient
                    .from('usuarios')
                    .select('*')
                    .eq('auth_user_id', authUserId)
                    .single();
                usuario = respPerfil.data;
                usuarioError = respPerfil.error;
                if (usuarioError || !usuario) {
                    const { data: rpcData, error: rpcError } = await supabaseClient.rpc('get_usuario_perfil');
                    if (rpcError || !rpcData || (Array.isArray(rpcData) && rpcData.length === 0)) {
                        const authEmail = signInData.user.email;
                        const { data: usuarioByEmail, error: usuarioByEmailError } = await supabaseClient
                            .from('usuarios')
                            .select('*')
                            .eq('email', authEmail)
                            .single();
                        if (usuarioByEmailError || !usuarioByEmail) {
                            throw new Error('Perfil de usurio no encontrado. Vincule auth_user_id ao usurio em usuarios.');
                        }
                        usuario = usuarioByEmail;
                    } else {
                        usuario = Array.isArray(rpcData) ? rpcData[0] : rpcData;
                    }
                }
                if (!usuario) {
                    const authEmail = signInData.user.email;
                    const { data: usuarioByEmail, error: usuarioByEmailError } = await supabaseClient
                        .from('usuarios')
                        .select('*')
                        .eq('email', authEmail)
                        .single();
                    if (usuarioByEmailError || !usuarioByEmail) {
                        throw new Error('Perfil de usurio no encontrado. Vincule auth_user_id ao usurio em usuarios.');
                    }
                    usuario = usuarioByEmail;
                }
                if (usuario.ativo === false) {
                    throw new Error('Usurio inativo.');
                }
                const { data: empresa, error: empErr2 } = await supabaseClient
                    .from('empresas')
                    .select('*')
                    .eq('id', usuario.id_empresa)
                    .single();
                if (empErr2 || !empresa) {
                    const { data: empresaRpc, error: empRpcErr } = await supabaseClient.rpc('get_empresa_for_current_user');
                    if (empRpcErr || !empresaRpc || (Array.isArray(empresaRpc) && empresaRpc.length === 0)) {
                        throw new Error('Empresa no encontrada para o usurio.');
                    }
                    currentEmpresa = Array.isArray(empresaRpc) ? empresaRpc[0] : empresaRpc;
                } else {
                    currentEmpresa = empresa;
                }
                if (currentEmpresa.ativo === false) throw new Error('Empresa inativa.');
                currentUser = usuario;
                try { await supabaseClient.rpc('upsert_user_tenant'); } catch (e) {}
                showMainApp();
                updateUserInfo();
                await loadUserData();
                startAutoSync();
                setupVisibilitySync();
            } catch (err) {
                console.error(err);
                showAuthMessage(err.message || 'Erro inesperado. Tente novamente.', 'error');
            } finally {
                if (loginBtn) {
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
                    loginBtn.disabled = false;
                }
            }
        }

         async function handleRegister() {}

        async function handleLogout() {
            try { await supabaseClient.auth.signOut(); } catch (e) {}
            stopAutoSync();
            currentUser = null;
            currentEmpresa = null;
            currentSession = null;
            products = [];
            scans = [];
            showAuthSection();
        }

         function showAuthMessage(message, type) {
             const authMessage = document.getElementById('auth-message');
             if (authMessage) {
                 authMessage.textContent = message;
                 authMessage.className = `alert alert-${type}`;
                 authMessage.classList.remove('hidden');
             }
         }

        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = 'toast';
             
            const iconMap = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            toast.innerHTML = `
                <div class="toast-header">
                    <div class="toast-title">
                        <i class="${iconMap[type] || iconMap.info}"></i>
                        ${type.charAt(0).toUpperCase() + type.slice(1)}
                    </div>
                    <button class="toast-close">&times;</button>
                </div>
                <div class="toast-body"></div>
            `;

            toastContainer.appendChild(toast);
            const bodyEl = toast.querySelector('.toast-body');
            if (bodyEl) bodyEl.textContent = String(message || '');

            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);

            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);

            // Manual close
            toast.querySelector('.toast-close')?.addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            });
        }

         function toggleCountType() {
            const countType = document.getElementById('count-type')?.value;
            const fileImportSection = document.getElementById('file-import-section');
            
            // Para a seo principal de importao na janela de configurao
            if (countType === 'avulsa') {
                fileImportSection?.classList.add('hidden');
            } else {
                fileImportSection?.classList.remove('hidden');
            }
        }
        
        function toggleSidebarCountType() {
            const countType = document.getElementById('sidebar-count-type')?.value;
            const fileImportGroup = document.getElementById('file-import-group');
            
            // Para o grupo de arquivo na sidebar - s mostra se tipo for 'normal' (com arquivo)
            if (fileImportGroup) {
                if (countType === 'normal') {
                    fileImportGroup.style.display = 'block';
                } else {
                    // Ocultar para qualquer outro valor (incluindo vazio, 'avulsa', etc.)
                    fileImportGroup.style.display = 'none';
                    // Limpar arquivo selecionado quando ocultar
                    const fileInput = document.getElementById('products-file');
                    const fileInfo = document.getElementById('file-info');
                    const importStatus = document.getElementById('import-status');
                    if (fileInput) fileInput.value = '';
                    if (fileInfo) fileInfo.classList.add('hidden');
                    if (importStatus) importStatus.classList.add('hidden');
                }
            }
        }

         async function handleImport() {
             const fileInput = document.getElementById('csv-file');
             const file = fileInput?.files[0];
             
             if (!file) return showToast('Selecione um arquivo CSV para importar.', 'error');
             if (file.size > 5 * 1024 * 1024) return showToast('O arquivo deve ter no mximo 5MB.', 'error');
             if (file.type !== 'text/csv' && !file.name.toLowerCase().endsWith('.csv')) {
                 return showToast('O arquivo deve ser do tipo CSV.', 'error');
             }

             let importLimit = 1000;
             let importConfig = { importacao_incluir_localizacao: true };
            if (supabaseClient && currentEmpresa) {
                const { data: empresaConfig } = await supabaseClient
                    .from('empresas')
                    .select('import_limit')
                    .eq('id', currentEmpresa.id)
                    .single();
                importLimit = empresaConfig?.import_limit ?? 1000;
                const { data: config, error: configError } = await supabaseClient
                    .from('configuracao_estoque')
                    .select('importacao_incluir_localizacao')
                    .eq('id_empresa', currentEmpresa.id)
                    .limit(1)
                    .single();
                 if (configError) {
                     console.log('Erro ao carregar configurao:', configError);
                 }
                 if (config) {
                     importConfig = config;
                 }
             }

             console.log('Configurao final:', importConfig);

             const reader = new FileReader();
             reader.onload = (e) => {
                 const content = e.target.result;
                 const lines = content.split(/\r?\n/).filter((line) => line.trim() !== '');
                 
                 console.log('Linhas do CSV:', lines);
                 
                 if (lines.length <= 1) return showToast('Arquivo CSV sem dados.', 'error');
                 if (lines.length - 1 > importLimit) {
                     return showToast(`Seu limite de importao  de ${importLimit} linhas. Arquivo contm ${lines.length - 1} linhas.`, 'error');
                 }

                 products = [];
                 for (let i = 1; i < lines.length; i++) {
                     const cols = lines[i].split(',');
                     const codigo = (cols[0] || '').trim();
                     const descricao = (cols[1] || '').trim();
                     const quantidade_atual = parseInt(cols[2], 10) || 0;
                     const localizacao = (cols[3] || '').trim();
                     
                     console.log(`Linha ${i}:`, { codigo, descricao, quantidade_atual, localizacao });
                     
                     if (codigo && descricao) {
                         const product = { 
                             codigo, 
                             descricao, 
                             quantidade_atual, 
                             quantidade_contada: 0, 
                             is_counted: false,
                             localizacao: localizacao
                         };
                         
                         console.log('Produto criado:', product);
                         products.push(product);
                     }
                 }
                 
                 console.log('Produtos finais:', products);
                
                // Verificar se algum produto tem localizao
                const produtosComLocalizacao = products.filter(p => p.localizacao);
                console.log('Produtos com localizao:', produtosComLocalizacao.length, produtosComLocalizacao);
                 
                 const importMessage = document.getElementById('import-message-area');
                 if (importMessage) {
                     importMessage.textContent = `Produtos importados: ${products.length}`;
                     importMessage.className = 'alert alert-success';
                     importMessage.classList.remove('hidden');
                 }
                 
                 showToast(`Importao concluda! ${products.length} produtos importados.`, 'success');
                 updateDashboardStats();
             };
             reader.readAsText(file);
         }

         async function updateDashboardStats() {
             const totalItems = document.getElementById('dashboard-total-items');
             const countedItems = document.getElementById('dashboard-counted-items');
             const scannedItems = document.getElementById('dashboard-scanned-items');
             const progress = document.getElementById('dashboard-progress');
             const progressBar = document.getElementById('dashboard-progress-bar');

            let total = 0;
            let counted = 0;
            let scanned = 0;

            if (supabaseClient && currentUser && currentEmpresa) {
                const { data: stats, error: statsErr } = await supabaseClient.rpc('get_dashboard_stats_for_current_user');
                if (!statsErr && stats && (Array.isArray(stats) ? stats.length > 0 : true)) {
                    const s = Array.isArray(stats) ? stats[0] : stats;
                    total = s.total || 0;
                    counted = s.counted || 0;
                    scanned = s.scanned || 0;
                } else {
                    let query = supabaseClient
                        .from('counting_sessions')
                        .select('*')
                        .eq('id_empresa', currentEmpresa.id);
                    if (currentUser?.role !== 'admin') {
                        query = query.eq('id_usuario', currentUser.id);
                    }
                    const { data: sessions } = await query;
                    if (sessions && sessions.length > 0) {
                        for (const session of sessions) {
                            total += session.total_items || 0;
                            counted += session.counted_items || 0;
                            scanned += session.scanned_items || 0;
                        }
                    }
                }
            } else {
                total = currentSession?.total_items || products.length || 0;
                counted = currentSession?.counted_items || products.filter(p => p.is_counted).length || 0;
                scanned = currentSession?.scanned_items || 0;
            }

             const progressPercent = total > 0 ? Math.round((counted / total) * 100) : 0;

             if (totalItems) totalItems.textContent = total;
             if (countedItems) countedItems.textContent = counted;
             if (scannedItems) scannedItems.textContent = scanned;
             if (progress) progress.textContent = `${progressPercent}%`;
             if (progressBar) progressBar.style.width = `${progressPercent}%`;
         }

         async function loadUserData() {
            if (!supabaseClient || !currentUser || !currentEmpresa) return;
            const { data: activeSessions } = await supabaseClient
                .from('counting_sessions')
                .select('*')
                .eq('id_usuario', currentUser.id)
                .eq('id_empresa', currentEmpresa.id)
                .eq('status', 'active')
                .order('created_at', { ascending: false })
                .limit(1);

             if (activeSessions && activeSessions.length > 0) {
                 currentSession = activeSessions[0];
                 
                const { data: sessionProducts } = await supabaseClient
                    .from('products')
                    .select('*')
                    .eq('session_id', currentSession.id);

                 if (sessionProducts && sessionProducts.length > 0) {
                     products = sessionProducts.map(p => ({
                         codigo: p.codigo,
                         descricao: p.descricao,
                         quantidade_atual: p.quantidade_atual,
                         quantidade_contada: p.quantidade_contada,
                         is_counted: p.is_counted
                     }));
                 }
             }
             
             await updateDashboardStats();
         }

         async function syncData() {
            if (!currentUser || !supabaseClient) return;
            await loadUserData();
         }

         function startAutoSync() {
             if (syncInterval) clearInterval(syncInterval);
             syncInterval = setInterval(async () => {
                if (currentUser && supabaseClient) {
                    await syncData();
                }
             }, 30000);
         }

         function stopAutoSync() {
             if (syncInterval) {
                 clearInterval(syncInterval);
                 syncInterval = null;
             }
         }

         function setupVisibilitySync() {
             document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && currentUser && supabaseClient) {
                    await syncData();
                }
             });

             window.addEventListener('focus', async () => {
                if (currentUser && supabaseClient) {
                    await syncData();
                }
             });
         }

         // Additional functions from original app
         async function startCountingSession() {
            if (!supabaseClient || !currentUser || !currentEmpresa) return showToast('Usurio no autenticado.', 'error');
             const countType = document.getElementById('count-type')?.value || 'normal';
             try {
                const { data: existingSession } = await supabaseClient
                    .from('counting_sessions')
                    .select('*')
                    .eq('id_usuario', currentUser.id)
                    .eq('id_empresa', currentEmpresa.id)
                    .eq('status', 'active')
                    .single();
                 if (existingSession) {
                     return showToast('J existe uma sesso ativa para este usurio na empresa.', 'error');
                 }
                 const sessionData = {
                     id_usuario: currentUser.id,
                     id_empresa: currentEmpresa.id,
                     session_name: `Contagem ${countType} - ${new Date().toLocaleDateString('pt-BR')}`,
                     count_type: countType,
                     total_items: countType === 'normal' ? products.length : 0,
                     counted_items: 0,
                     scanned_items: 0,
                     status: 'waiting'
                 };
                const result = await supabaseClient
                    .from('counting_sessions')
                    .insert([sessionData])
                    .select()
                    .single();
                 if (result.error) throw result.error;
                 const newSession = result.data;
                 currentSession = newSession;
                 if (products.length > 0) {
                     const productsToInsert = products.map(p => ({
                         session_id: newSession.id,
                         codigo: p.codigo,
                         descricao: p.descricao,
                         localizacao: p.localizacao || null,
                         quantidade_atual: p.quantidade_atual,
                         quantidade_contada: 0,
                         is_counted: false
                     }));
                    const { error: productsError } = await supabaseClient
                        .from('products')
                        .insert(productsToInsert);
                     if (productsError) throw productsError;
                 }
                 showToast('Sesso de contagem iniciada com sucesso!', 'success');
                 await updateDashboardStats();
                 navigateToPage('contagem');
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao iniciar sesso: ' + err.message, 'error');
             }
         }

        async function endCountingSession() {
            if (!currentSession || !supabaseClient) return showToast('Nenhuma sesso ativa encontrada.', 'error');

             try {
                const { error } = await supabaseClient
                    .from('counting_sessions')
                    .update({ status: 'completed', ended_at: new Date().toISOString() })
                    .eq('id', currentSession.id);

                 if (error) throw error;

                 currentSession = null;
                 products = [];
                 scans = [];
                 
                 showToast('Sesso de contagem finalizada com sucesso!', 'success');
                await updateDashboardStats();
                navigateToPage('dashboard');
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao finalizar sesso: ' + err.message, 'error');
             }
         }

         async function addScan() {
             if (!currentSession) return showToast('Nenhuma sesso ativa.', 'error');
             
             const barcodeInput = document.getElementById('barcode-input');
             const quantityInput = document.getElementById('quantity-input');
             
             const barcode = barcodeInput?.value.trim();
             const quantity = parseInt(quantityInput?.value) || 1;
             
             if (!barcode) return showToast('Digite ou escaneie um cdigo de barras.', 'error');

             try {
                 let product = null;
                 
                if (currentSession.count_type === 'normal') {
                const { data: foundProduct } = await supabaseClient
                        .from('products')
                        .select('*')
                        .eq('session_id', currentSession.id)
                        .eq('codigo', barcode)
                        .single();
                     
                     if (foundProduct) {
                         product = foundProduct;
                         const newQuantity = product.quantidade_contada + quantity;
                         
                        const { error } = await supabaseClient
                            .from('products')
                            .update({ 
                                quantidade_contada: newQuantity, 
                                is_counted: true 
                            })
                            .eq('id', product.id);
                         
                         if (error) {
                            console.error('Erro detalhado do Supabase:', error);
                            console.error('Cdigo do erro:', error.code);
                            console.error('Mensagem do erro:', error.message);
                            console.error('Detalhes do erro:', error.details);
                            throw error;
                        }

                        console.log('Dados inseridos com sucesso:', data);
                         
                         // Update local products array
                         const localProduct = products.find(p => p.codigo === barcode);
                         if (localProduct) {
                             localProduct.quantidade_contada = newQuantity;
                             localProduct.is_counted = true;
                         }
                     } else {
                         showToast('Produto no encontrado na lista importada.', 'warning');
                         return;
                     }
                 }

                 // Add scan record
                 const scanData = {
                     session_id: currentSession.id,
                     codigo: barcode,
                     descricao: product?.descricao || 'Produto no identificado',
                     quantidade: quantity,
                     scanned_at: new Date().toISOString()
                 };

                const { error: scanError } = await supabaseClient
                    .from('scans')
                    .insert([scanData]);

                 if (scanError) throw scanError;

                 // Update session counters
                 const countedItems = products.filter(p => p.is_counted).length;
                 const scannedItems = currentSession.scanned_items + 1;
                 
                const { error: sessionError } = await supabaseClient
                    .from('counting_sessions')
                    .update({ 
                        counted_items: countedItems,
                        scanned_items: scannedItems
                    })
                    .eq('id', currentSession.id);

                 if (sessionError) throw sessionError;

                 currentSession.counted_items = countedItems;
                 currentSession.scanned_items = scannedItems;

                 showToast(`Produto ${barcode} adicionado! Quantidade: ${quantity}`, 'success');
                 
                 // Clear inputs
                 if (barcodeInput) barcodeInput.value = '';
                 if (quantityInput) quantityInput.value = '1';
                 
                 await updateDashboardStats();
                renderProducts();
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao adicionar scan: ' + err.message, 'error');
             }
         }

        function renderProducts() {
            const productsList = document.getElementById('products-list');
            if (!productsList) return;

            if (products.length === 0) {
                productsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-boxes"></i>
                        <h3>Nenhum produto encontrado</h3>
                        <p>Importe um arquivo CSV para visualizar os produtos</p>
                    </div>
                `;
                return;
            }

            const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
            const productsHtml = products.map(product => `
                <div class="product-item ${product.is_counted ? 'counted' : ''}">
                    <div class="product-info">
                        <div class="product-code">${esc(product.codigo)}</div>
                        <div class="product-description">${esc(product.descricao)}</div>
                    </div>
                    <div class="product-quantities">
                        <span class="quantity-label">Atual: ${product.quantidade_atual}</span>
                        <span class="quantity-label counted">Contado: ${product.quantidade_contada}</span>
                    </div>
                    <div class="product-status">
                        ${product.is_counted ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-circle"></i>'}
                    </div>
                </div>
            `).join('');

            productsList.innerHTML = productsHtml;
        }

         async function exportData(format = 'csv', type = 'grouped') {
             if (!currentSession) return showToast('Nenhuma sesso ativa para exportar.', 'error');

             try {
                let data = [];
                const emp = (currentEmpresa?.nome || 'empresa').replace(/\s+/g, '_');
                const usr = (currentUser?.nome || 'usuario').replace(/\s+/g, '_');
                let filename = `contagem_${emp}_${usr}_${new Date().toISOString().split('T')[0]}`;

                 if (type === 'grouped') {
                    const { data: products } = await supabaseClient
                        .from('products')
                        .select('*')
                        .eq('session_id', currentSession.id);

                     data = products || [];
                     filename += '_agrupado';
                 } else {
                    const { data: scans } = await supabaseClient
                        .from('scans')
                        .select('*')
                        .eq('session_id', currentSession.id)
                        .order('scanned_at', { ascending: true });

                     data = scans || [];
                     filename += '_detalhado';
                 }

                 if (data.length === 0) {
                     return showToast('Nenhum dado para exportar.', 'warning');
                 }

                 let content = '';
                 if (format === 'csv') {
                     if (type === 'grouped') {
                         content = 'Codigo,Descricao,Quantidade_Atual,Quantidade_Contada,Diferenca\n';
                         content += data.map(item => 
                             `${item.codigo},"${item.descricao}",${item.quantidade_atual},${item.quantidade_contada},${item.quantidade_contada - item.quantidade_atual}`
                         ).join('\n');
                     } else {
                         content = 'Codigo,Descricao,Quantidade,Data_Hora\n';
                         content += data.map(item => 
                             `${item.codigo},"${item.descricao}",${item.quantidade},${new Date(item.scanned_at).toLocaleString()}`
                         ).join('\n');
                     }
                     filename += '.csv';
                 } else {
                     if (type === 'grouped') {
                         content = data.map(item => 
                             `${item.codigo}\t${item.descricao}\t${item.quantidade_atual}\t${item.quantidade_contada}\t${item.quantidade_contada - item.quantidade_atual}`
                         ).join('\n');
                     } else {
                         content = data.map(item => 
                             `${item.codigo}\t${item.descricao}\t${item.quantidade}\t${new Date(item.scanned_at).toLocaleString()}`
                         ).join('\n');
                     }
                     filename += '.txt';
                 }

                 const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = filename;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);

                 showToast(`Arquivo ${filename} exportado com sucesso!`, 'success');
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao exportar dados: ' + err.message, 'error');
             }
         }

         async function loadSessionHistory() {
            if (!supabaseClient || !currentUser) return;

            try {
                let query = supabaseClient
                    .from('counting_sessions')
                    .select('*')
                    .eq('id_empresa', currentEmpresa.id);
                if (currentUser?.role !== 'admin') {
                    query = query.eq('id_usuario', currentUser.id);
                }
                const { data: sessions } = await query
                    .order('created_at', { ascending: false })
                    .limit(50);

                 const historyList = document.getElementById('history-list');
                 if (!historyList) return;

                 if (!sessions || sessions.length === 0) {
                     historyList.innerHTML = `
                         <div class="empty-state">
                             <i class="fas fa-history"></i>
                             <h3>Nenhum histrico encontrado</h3>
                             <p>Suas sesses de contagem aparecero aqui</p>
                         </div>
                     `;
                     return;
                 }

                const historyHtml = sessions.map(session => `
                    <div class="history-item">
                        <div class="history-info">
                           <div class="history-device">
                               <i class="fas fa-folder"></i>
                                ${String(session.session_name || 'Sesso').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
                            </div>
                            <div class="history-type">${session.count_type === 'normal' ? 'Contagem com Arquivo' : 'Contagem Avulsa'}</div>
                            <div class="history-date">${new Date(session.created_at).toLocaleString()}</div>
                        </div>
                        <div class="history-stats">
                             <span class="stat">Total: ${session.total_items || 0}</span>
                             <span class="stat">Contados: ${session.counted_items || 0}</span>
                             <span class="stat">Scans: ${session.scanned_items || 0}</span>
                         </div>
                         <div class="history-status">
                             <span class="status ${session.status}">${session.status === 'active' ? 'Ativa' : 'Finalizada'}</span>
                         </div>
                         <div class="history-actions">
                             <button class="btn btn-sm btn-outline" onclick="viewSessionDetails('${session.id}')">
                                 <i class="fas fa-eye"></i> Ver
                             </button>
                             ${session.status === 'completed' ? `
                                 <button class="btn btn-sm btn-outline" onclick="exportSessionData('${session.id}')">
                                     <i class="fas fa-download"></i> Exportar
                                 </button>
                                 <button class="btn btn-sm btn-danger" onclick="deleteSession('${session.id}')">
                                     <i class="fas fa-trash"></i>
                                 </button>
                             ` : ''}
                         </div>
                     </div>
                 `).join('');

                 historyList.innerHTML = historyHtml;
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao carregar histrico: ' + err.message, 'error');
             }
         }

         async function viewSessionDetails(sessionId) {
             // Implementation for viewing session details
             showToast('Funcionalidade em desenvolvimento', 'info');
         }

         async function exportSessionData(sessionId) {
             // Implementation for exporting specific session data
             showToast('Funcionalidade em desenvolvimento', 'info');
         }



         // Variveis globais para sesses de contagem
         let allCountingSessions = [];
         let filteredSessions = [];
         let currentSessionsPage = 1;
         const sessionsPerPage = 10;

         // Funo closeNewSessionSidebar no escopo global
         function closeNewSessionSidebar() {
             const sidebar = document.getElementById('new-session-sidebar');
             sidebar.classList.remove('active');
         }

         // Funo getStatusText no escopo global
         function getStatusText(status) {
             const statusMap = {
                 'active': 'Ativa',
                 'completed': 'Concluda',
                 'paused': 'Pausada',
                 'waiting': 'Aguardando'
             };
             return statusMap[status] || status;
         }

         // Funo renderSessionsTable no escopo global
         function renderSessionsTable() {
               const tableBody = document.getElementById('sessions-tbody');
               const emptyState = document.getElementById('sessions-empty');
               const tableContainer = document.querySelector('.table-container');
               if (!tableBody) {
                   console.error('sessions-tbody no encontrado!');
                   return;
               }

             if (filteredSessions.length === 0) {
                 tableContainer?.classList.add('hidden');
                 emptyState?.classList.remove('hidden');
                 updateSessionsPagination();
                 return;
             }

             tableContainer?.classList.remove('hidden');
             emptyState?.classList.add('hidden');
             
             // Calculate pagination
             const totalSessions = filteredSessions.length;
             const totalPages = Math.ceil(totalSessions / sessionsPerPage);
             const startIndex = (currentSessionsPage - 1) * sessionsPerPage;
             const endIndex = startIndex + sessionsPerPage;
             const paginatedSessions = filteredSessions.slice(startIndex, endIndex);

            tableBody.innerHTML = paginatedSessions.map(session => {
                   const progress = session.total_items > 0 ? Math.round((session.counted_items / session.total_items) * 100) : 0;
                   const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
                   const userName = esc(session.user_name || '-');
                   const sessionName = esc(session.session_name || 'N/A');
                   const createdDate = new Date(session.created_at).toLocaleDateString('pt-BR');
                   const createdTime = new Date(session.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

               return `
                    <tr>
                        <td>${session.id}</td>
                        <td>${sessionName}</td>
                        <td>${userName}</td>
                         <td><span style="text-transform: capitalize;">${session.count_type}</span></td>
                         <td>
                             <span class="status-badge ${session.status}">
                                 <i class="fas fa-circle"></i>
                                 ${typeof getStatusText === 'function' ? getStatusText(session.status) : session.status}
                             </span>
                         </td>
                         <td>${session.total_items || 0}</td>
                         <td>${session.counted_items || 0}</td>
                         <td>
                             <div class="progress-container">
                                 <div class="progress-bar" style="width: ${progress}%"></div>
                             </div>
                             <div class="progress-text">${progress}%</div>
                         </td>
                         <td>
                             <div style="font-size: 0.85rem;">
                                 <div>${createdDate}</div>
                                 <div style="color: var(--text-light);">${createdTime}</div>
                             </div>
                         </td>
                         <td>
                             <div class="action-buttons">
                                 <button class="action-btn upload" onclick="uploadSessionFile('${session.id}')" title="Subir Arquivo">
                                     <i class="fas fa-upload"></i>
                                 </button>
                                 <button class="action-btn download" onclick="downloadSessionCSV('${session.id}')" title="Baixar Arquivo">
                                     <i class="fas fa-download"></i>
                                 </button>
                                 ${session.status === 'waiting' || session.status === 'active' ? `
                                 <button class="action-btn status" onclick="changeSessionStatus('${session.id}', '${session.status}')" title="${session.status === 'waiting' ? 'Iniciar Contagem' : 'Finalizar Contagem'}">
                                     <i class="fas fa-${session.status === 'waiting' ? 'play' : 'check'}"></i>
                                 </button>` : ''}

                                 <button class="action-btn delete" onclick="deleteSession('${session.id}')" title="Excluir">
                                     <i class="fas fa-trash"></i>
                                 </button>
                             </div>
                         </td>
                     </tr>
                 `;
             }).join('');
             
             updateSessionsPagination();
         }
         
         // Funo para atualizar a paginao das sesses
         function updateSessionsPagination() {
             const totalSessions = filteredSessions.length;
             const totalPages = Math.ceil(totalSessions / sessionsPerPage);
             const startIndex = (currentSessionsPage - 1) * sessionsPerPage;
             const endIndex = Math.min(startIndex + sessionsPerPage, totalSessions);
             
             // Update pagination info
             const paginationInfo = document.getElementById('sessions-pagination-info');
             if (paginationInfo) {
                 if (totalSessions === 0) {
                     paginationInfo.textContent = 'Mostrando 0 a 0 de 0 sesses';
                 } else {
                     paginationInfo.textContent = `Mostrando ${startIndex + 1} a ${endIndex} de ${totalSessions} sesses`;
                 }
             }
             
             // Update page info
             const pageInfo = document.getElementById('sessions-page-info');
             if (pageInfo) {
                 pageInfo.textContent = `Pgina ${currentSessionsPage} de ${Math.max(1, totalPages)}`;
             }
             
             // Update navigation buttons
             const prevBtn = document.getElementById('sessions-prev-btn');
             const nextBtn = document.getElementById('sessions-next-btn');
             
             if (prevBtn) {
                 prevBtn.disabled = currentSessionsPage <= 1;
             }
             
             if (nextBtn) {
                 nextBtn.disabled = currentSessionsPage >= totalPages || totalPages === 0;
             }
         }
         
         // Funo para navegar para a pgina anterior das sesses
         function goToSessionsPreviousPage() {
             if (currentSessionsPage > 1) {
                 currentSessionsPage--;
                 renderSessionsTable();
             }
         }
         
         // Funo para navegar para a prxima pgina das sesses
         function goToSessionsNextPage() {
             const totalPages = Math.ceil(filteredSessions.length / sessionsPerPage);
             if (currentSessionsPage < totalPages) {
                 currentSessionsPage++;
                 renderSessionsTable();
             }
         }

         // Funo loadCountingSessions no escopo global
         async function loadCountingSessions() {
            if (!supabaseClient) {
                console.error('Supabase not initialized');
                showToast('Erro: Supabase no inicializado', 'error');
                return;
            }

             const loadingState = document.getElementById('sessions-loading');
             const emptyState = document.getElementById('sessions-empty');
             const tableContainer = document.querySelector('.table-container');

             // Show loading
             loadingState?.classList.remove('hidden');
             emptyState?.classList.add('hidden');
             tableContainer?.classList.add('hidden');

             try {
                let query = supabaseClient
                    .from('counting_sessions')
                    .select('*')
                    .eq('id_empresa', currentEmpresa.id);
                if (currentUser?.role !== 'admin') {
                    query = query.eq('id_usuario', currentUser.id);
                }
                const { data, error } = await query
                    .order('created_at', { ascending: false });
                let sessions = data || [];
                if (error) {
                    const { data: sessionsRpc, error: rpcErr } = await supabaseClient.rpc('get_counting_sessions_for_current_user');
                    if (rpcErr) throw rpcErr;
                    sessions = sessionsRpc || [];
                }
                
                const userIds = Array.from(new Set((sessions || []).map(s => s.id_usuario).filter(Boolean)));
                let usersMap = {};
                if (userIds.length > 0) {
                    if (currentUser?.role === 'admin') {
                        const { data: usuariosRpc, error: rpcErr } = await supabaseClient.rpc('get_usuarios_da_empresa');
                        if (!rpcErr && usuariosRpc && usuariosRpc.length > 0) {
                            (usuariosRpc || []).forEach(u => { usersMap[u.id] = u.nome; });
                        }
                    } else {
                        usersMap[currentUser.id] = currentUser.nome;
                    }
                }
                
                allCountingSessions = (sessions || []).map(s => ({
                    ...s,
                    user_name: usersMap[s.id_usuario] || ''
                }));
                sessionsUsersMap = usersMap;
                filteredSessions = [...allCountingSessions];
                if (typeof loadUsersForFilter === 'function') loadUsersForFilter();
                if (typeof setupFilterEventListeners === 'function') setupFilterEventListeners();
                if (typeof renderSessionsTable === 'function') renderSessionsTable();

            } catch (error) {
                console.error('Erro ao carregar sesses:', error);
                 showToast('Erro ao carregar sesses de contagem', 'error');
             } finally {
                 loadingState?.classList.add('hidden');
             }
         }

         // Funo saveNewSession definida antes dos event listeners
         async function saveNewSession() {
             const form = document.getElementById('new-session-form');
            const formData = new FormData(form);
            
            let selectedUserId = formData.get('id_usuario') || currentUser?.id;
            if (currentUser?.role !== 'admin') {
                selectedUserId = currentUser?.id;
            }
            const sessionName = formData.get('session_name');
            const description = formData.get('description');
            const countType = formData.get('count_type');
            
            if (!sessionName || !countType) {
                showToast('Preencha todos os campos obrigatrios', 'error');
                return;
            }

            if (!supabaseClient) {
                console.error('Supabase no est disponvel');
                showToast('Erro de conexo com o banco de dados', 'error');
                return;
            }

            if (!currentUser || !currentEmpresa) {
                showToast('Voc precisa estar logado para criar uma sesso', 'error');
                return;
            }

            try {
                console.log('importedProductsCount:', importedProductsCount);
                
                // Verificar se j existe uma sesso de importao ativa
                const existingImportSession = allCountingSessions.find(session => 
                    session.session_name && session.session_name.includes('Importao CSV') && 
                    session.status === 'waiting' && 
                    session.total_items > 0
                );
                
                if (existingImportSession && importedProductsCount > 0) {
                    showToast('J existe uma sesso de importao ativa. Use a sesso existente ou exclua-a primeiro.', 'warning');
                    return;
                }
                
                const sessionData = {
                    id_usuario: parseInt(selectedUserId, 10) || currentUser.id,
                    id_empresa: currentEmpresa.id,
                    session_name: sessionName,
                    description: description || '',
                    count_type: countType,
                    total_items: 0, // Sempre iniciar com 0 para sesses manuais
                    counted_items: 0,
                    scanned_items: 0,
                    status: 'waiting'
                };
                
                console.log('Dados da sesso:', sessionData);

                 let insertResult = { data: null, error: null };
                 try {
                     insertResult = await supabaseClient
                         .rpc('create_counting_session', {
                             p_id_usuario: sessionData.id_usuario,
                             p_id_empresa: sessionData.id_empresa,
                             p_session_name: sessionData.session_name,
                             p_description: sessionData.description,
                             p_count_type: sessionData.count_type
                         })
                         .single();
                 } catch (e) {
                     insertResult = await supabaseClient
                         .from('counting_sessions')
                         .insert([sessionData])
                         .select()
                         .single();
                 }
                if (insertResult?.error) {
                    insertResult = await supabaseClient
                        .from('counting_sessions')
                        .insert([sessionData])
                        .select()
                        .single();
                }
                const { data: newSession, error } = insertResult;

                 if (error) throw error;

                 showToast('Nova sesso criada com sucesso!', 'success');
                 closeNewSessionSidebar();
                 loadCountingSessions();

             } catch (error) {
                 console.error('Erro ao criar sesso:', error);
                 showToast('Erro ao criar nova sesso', 'error');
             }
         }

        // Funes globais para aes do grid
        async function deleteSession(sessionId) {
            if (!confirm('Tem certeza que deseja excluir esta sesso? Esta ao no pode ser desfeita.')) {
                return;
            }

            try {
                const target = allCountingSessions.find(s => s.id === sessionId);
                if (target && currentUser && currentUser.role !== 'admin' && target.id_usuario !== currentUser.id) {
                    showToast('Voc no tem permisso para excluir esta sesso', 'error');
                    return;
                }
                const { error } = await supabaseClient
                    .from('counting_sessions')
                    .delete()
                    .eq('id', sessionId);

                if (error) {
                    const { error: rpcErr } = await supabaseClient.rpc('delete_counting_session', { p_session_id: sessionId });
                    if (rpcErr) throw rpcErr;
                }

                showToast('Sesso excluda com sucesso!', 'success');
                loadCountingSessions();

            } catch (error) {
                console.error('Erro ao excluir sesso:', error);
                showToast('Erro ao excluir sesso', 'error');
            }
        }

        // Funes de filtro globais
        function loadUsersForFilter() {
            const userFilter = document.getElementById('user-filter');
            if (!userFilter || !allCountingSessions) return;
            
            userFilter.innerHTML = '<option value="">Todos os Usurios</option>';
            if (currentUser?.role === 'admin') {
                const entries = Object.entries(sessionsUsersMap || {});
                entries.forEach(([id, name]) => {
                    const option = document.createElement('option');
                    option.value = String(id);
                    option.textContent = name || String(id);
                    userFilter.appendChild(option);
                });
            } else if (currentUser) {
                const option = document.createElement('option');
                option.value = String(currentUser.id);
                option.textContent = currentUser.nome;
                userFilter.appendChild(option);
            }
        }

        function setupFilterEventListeners() {
            // Search input
            const searchInput = document.getElementById('session-search');
            if (searchInput) {
                searchInput.removeEventListener('input', filterSessions);
                searchInput.addEventListener('input', filterSessions);
            }

            // Filter selects
            const userFilter = document.getElementById('user-filter');
            const statusFilter = document.getElementById('status-filter');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            
            if (statusFilter) {
                statusFilter.removeEventListener('change', filterSessions);
                statusFilter.addEventListener('change', filterSessions);
            }
            if (userFilter) {
                userFilter.removeEventListener('change', filterSessions);
                userFilter.addEventListener('change', filterSessions);
            }
            if (clearFiltersBtn) {
                clearFiltersBtn.removeEventListener('click', clearFilters);
                clearFiltersBtn.addEventListener('click', clearFilters);
            }
        }

        function filterSessions() {
            const searchTerm = document.getElementById('session-search')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('status-filter')?.value || '';
            const userFilterValue = document.getElementById('user-filter')?.value || '';

            filteredSessions = allCountingSessions.filter(session => {
                   const sessionName = session.session_name || '';
                   const userName = session.user_name || '';
                   
                   const matchesSearch = !searchTerm || 
                       sessionName.toLowerCase().includes(searchTerm) ||
                       userName.toLowerCase().includes(searchTerm);
                   
                   const matchesStatus = !statusFilter || session.status === statusFilter;
                   const matchesUser = !userFilterValue || String(session.id_usuario) === userFilterValue;
 
                   return matchesSearch && matchesStatus && matchesUser;
               });

            // Reset to first page when filters change
            currentSessionsPage = 1;
            renderSessionsTable();
        }

        function clearFilters() {
            const searchInput = document.getElementById('session-search');
            const statusFilter = document.getElementById('status-filter');
            const userFilter = document.getElementById('user-filter');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            if (userFilter) userFilter.value = '';
            

            currentSessionsPage = 1;
            filterSessions();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
             // Navigation event listeners
             document.querySelectorAll('.nav-item').forEach(item => {
                 item.addEventListener('click', (e) => {
                     e.preventDefault();
                     const page = item.getAttribute('data-page');
                     if (page) navigateToPage(page);
                 });
             });

             // Auth form event listeners
             document.getElementById('login-btn')?.addEventListener('click', handleLogin);
             document.getElementById('register-btn')?.addEventListener('click', handleRegister);
             document.getElementById('login-tab')?.addEventListener('click', () => switchAuthTab('login'));
             document.getElementById('register-tab')?.addEventListener('click', () => switchAuthTab('register'));

             // Main app event listeners
             document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
             document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
             document.getElementById('import-btn')?.addEventListener('click', handleImport);
             document.getElementById('start-session-btn')?.addEventListener('click', startCountingSession);
             document.getElementById('end-session-btn')?.addEventListener('click', endCountingSession);
             document.getElementById('add-scan-btn')?.addEventListener('click', addScan);
             
             // Export buttons
             document.getElementById('export-csv-grouped')?.addEventListener('click', () => exportData('csv', 'grouped'));
             document.getElementById('export-csv-detailed')?.addEventListener('click', () => exportData('csv', 'detailed'));
             document.getElementById('export-txt-grouped')?.addEventListener('click', () => exportData('txt', 'grouped'));
             document.getElementById('export-txt-detailed')?.addEventListener('click', () => exportData('txt', 'detailed'));

             // Barcode input enter key
             document.getElementById('barcode-input')?.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                     e.preventDefault();
                     addScan();
                 }
             });

             // New session form event listeners
             const newSessionForm = document.getElementById('new-session-form');
             if (newSessionForm) {
                 newSessionForm.addEventListener('submit', (e) => {
                     e.preventDefault();
                     if (typeof saveNewSession === 'function') {
                         saveNewSession();
                     }
                 });
             }
             
             // File input event listener for sidebar
             const productsFileInput = document.getElementById('products-file');
             if (productsFileInput) {
                 productsFileInput.addEventListener('change', handleFileSelect);
             }
             
             // Sidebar close button
             const closeSidebarBtn = document.getElementById('close-sidebar-btn');
             if (closeSidebarBtn) {
                 closeSidebarBtn.addEventListener('click', () => {
                     const sidebar = document.getElementById('new-session-sidebar');
                     if (sidebar) {
                         sidebar.classList.remove('active');
                     }
                 });
             }
             
             // Cancel session button
             const cancelSessionBtn = document.getElementById('cancel-session-btn');
             if (cancelSessionBtn) {
                 cancelSessionBtn.addEventListener('click', () => {
                     const sidebar = document.getElementById('new-session-sidebar');
                     if (sidebar) {
                         sidebar.classList.remove('active');
                     }
                 });
             }
             
             const saveSessionBtn = document.getElementById('save-session-btn');
             if (saveSessionBtn) {
                 saveSessionBtn.addEventListener('click', (e) => {
                     e.preventDefault();
                     if (typeof saveNewSession === 'function') {
                         saveNewSession();
                     } else {
                         console.error('saveNewSession function not found');
                     }
                 });
             } else {
                 console.error('Save button not found in DOM');
             }

             // Load history when navigating to history page
             const historyNavItem = document.querySelector('[data-page="historico"]');
             historyNavItem?.addEventListener('click', loadSessionHistory);

             // Initialize theme
             const savedTheme = localStorage.getItem('theme') || 'light';
             document.documentElement.setAttribute('data-theme', savedTheme);
             if (themeToggle) {
                 const icon = themeToggle.querySelector('i');
                 if (icon) {
                     icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                 }
             }

             // Check authentication state
            if (supabaseClient) {
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        // User signed in
                    } else if (event === 'SIGNED_OUT') {
                        showAuthSection();
                    }
                });

                 // ===== COUNTING SESSIONS CRUD FUNCTIONS =====
                 // Variveis e funo movidas para escopo global
                 // renderSessionsTable movida para escopo global

                 // getStatusText movida para escopo global



                // Variveis globais para a sidebar
                let availableUsers = [];
                let selectedFile = null;
                let importedProductsCount = 0;
                let sessionsUsersMap = {};







                function handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        selectedFile = file;
                        const fileNameElement = document.getElementById('file-name');
                        const fileSizeElement = document.getElementById('file-size');
                        const fileInfoElement = document.getElementById('file-info');
                        const importStatusElement = document.getElementById('import-status');
                        const importButton = document.getElementById('import-products-btn');
                        
                        if (fileNameElement) fileNameElement.textContent = file.name;
                        if (fileSizeElement) fileSizeElement.textContent = formatFileSize(file.size);
                        if (fileInfoElement) {
                            fileInfoElement.style.display = 'flex';
                            fileInfoElement.classList.remove('hidden');
                        }
                        if (importButton) {
                            importButton.style.display = 'block';
                            // Adicionar event listener se ainda no foi adicionado
                            if (!importButton.hasAttribute('data-listener-added')) {
                                importButton.addEventListener('click', () => {
                                    if (typeof importProducts === 'function') {
                                        importProducts();
                                    }
                                });
                                importButton.setAttribute('data-listener-added', 'true');
                            }
                        }
                        if (importStatusElement) {
                            importStatusElement.style.display = 'none';
                            importStatusElement.classList.add('hidden');
                        }
                        
                        // No modificar o campo session-name aqui, pois ser combinado na funo handleImport
                        // A lgica de combinao ser feita posteriormente
                    }
                }

                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                async function importProducts() {
                    if (!selectedFile) {
                        showToast('Selecione um arquivo primeiro', 'error');
                        return;
                    }

                    try {
                        const text = await selectedFile.text();
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        if (lines.length === 0) {
                            showToast('Arquivo vazio ou invlido', 'error');
                            return;
                        }

                        // Formato CSV: codigo,descricao,quantidade,localizacao
                        const products = [];
                        for (let i = 1; i < lines.length; i++) { // Pular cabealho
                            const cols = lines[i].split(',').map(s => s.trim());
                            const codigo = cols[0] || '';
                            const descricao = cols[1] || '';
                            const quantidade = cols[2] ? parseInt(cols[2]) || 0 : 0;
                            const localizacao = cols[3] || '';
                            
                            if (codigo && descricao) {
                                products.push({
                                    codigo,
                                    descricao,
                                    quantidade,
                                    localizacao
                                });
                            }
                        }

                        if (products.length === 0) {
                            showToast('Nenhum produto vlido encontrado no arquivo', 'error');
                            return;
                        }

                        // Tentar inserir no Supabase, se falhar usar localStorage
                        console.log('Produtos a serem inseridos:', products);
                        
                try {
                             // Obter nome do arquivo sem extenso
                             const fileName = file.name;
                             
                             // Verificar se o arquivo j foi uploaded antes (buscar em todas as sesses)
                            const { data: existingSessions, error: checkError } = await supabaseClient
                                .from('counting_sessions')
                                .select('id, session_name, arquivo_uploaded, id_usuario, id_empresa')
                                .eq('arquivo_uploaded', fileName)
                                .eq('id_empresa', currentEmpresa.id);
                             
                             if (checkError) {
                                 console.warn('Erro ao verificar arquivos duplicados:', checkError);
                             } else if (existingSessions && existingSessions.length > 0) {
                                 showToast(`Arquivo "${fileName}" j foi importado anteriormente na sesso "${existingSessions[0].session_name}". No  possvel importar o mesmo arquivo novamente.`, 'error');
                                 return;
                             }
                             
                             const nameWithoutExtension = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
                             
                             // Obter nome da sesso atual do campo
                             const sessionNameInput = document.getElementById('sidebar-session-name');
                             const currentSessionName = sessionNameInput?.value?.trim() || 'Importao CSV';
                             
                             // Criar nome da sesso SEM combinar com o nome do arquivo (isso ser feito no boto de ao)
                             const finalSessionName = currentSessionName;
                             
                             // Criar uma sesso de contagem
                             let sessionCreate = { data: null, error: null };
                             try {
                                 sessionCreate = await supabaseClient
                                     .rpc('create_counting_session', {
                                         p_id_usuario: currentUser.id,
                                         p_id_empresa: currentEmpresa.id,
                                         p_session_name: finalSessionName,
                                         p_description: 'Sesso criada automaticamente para importao de produtos',
                                         p_count_type: 'normal',
                                         p_arquivo_uploaded: fileName
                                     })
                                     .single();
                             } catch (e) {
                                 sessionCreate = await supabaseClient
                                     .from('counting_sessions')
                                     .insert({
                                         id_usuario: currentUser.id,
                                         id_empresa: currentEmpresa.id,
                                         session_name: finalSessionName,
                                         description: 'Sesso criada automaticamente para importao de produtos',
                                         count_type: 'normal',
                                         status: 'waiting',
                                         total_items: 0,
                                         arquivo_uploaded: fileName
                                     })
                                     .select()
                                     .single();
                             }
                             if (sessionCreate?.error) {
                                 sessionCreate = await supabaseClient
                                     .from('counting_sessions')
                                     .insert({
                                         id_usuario: currentUser.id,
                                         id_empresa: currentEmpresa.id,
                                         session_name: finalSessionName,
                                         description: 'Sesso criada automaticamente para importao de produtos',
                                         count_type: 'normal',
                                         status: 'waiting',
                                         total_items: 0,
                                         arquivo_uploaded: fileName
                                     })
                                     .select()
                                     .single();
                             }
                             const { data: sessionData, error: sessionError } = sessionCreate;

                             if (sessionError) {
                                 console.error('Erro ao criar sesso:', sessionError);
                                 throw sessionError;
                             }

                             const sessionId = sessionData.id;
                             console.log('Sesso criada com sucesso:', sessionId);

                             // Preparar dados dos produtos com session_id vlido
                             const supabaseProducts = products.map(p => ({
                                 codigo: p.codigo,
                                 descricao: p.descricao,
                                 localizacao: p.localizacao || null,
                                 session_id: sessionId,
                                 expected_qty: p.quantidade || 0
                             }));
                             
                             console.log('Dados que sero enviados ao Supabase:', supabaseProducts);
                             console.log('Produtos com localizao para Supabase:', supabaseProducts.filter(p => p.localizacao));
                             
                            const payload = supabaseProducts.map(p => ({
                                codigo: p.codigo,
                                descricao: p.descricao,
                                localizacao: p.localizacao,
                                expected_qty: p.expected_qty,
                                quantidade_atual: 0
                            }));
                            const { data, error } = await supabaseClient
                                .rpc('insert_products_for_session', {
                                    p_session_id: sessionId,
                                    p_products: payload
                                });

                             if (error) {
                                 console.error('Erro detalhado do Supabase:', error);
                                 console.error('Cdigo do erro:', error.code);
                                 console.error('Mensagem do erro:', error.message);
                                 console.error('Detalhes do erro:', error.details);
                                 throw error;
                             }

                             console.log('Dados inseridos com sucesso no Supabase:', data);
                             
                             // Atualizar a sesso com o total correto de itens
                             console.log('Atualizando sesso:', sessionId, 'com total_items:', data.length);
                           const { data: updateData, error: updateError } = await supabaseClient
                               .rpc('update_session_total', { p_session_id: sessionId });
                             
                             if (updateError) {
                                 console.error('Erro ao atualizar sesso:', updateError);
                                 console.error('Detalhes do erro de atualizao:', updateError.details);
                                 console.error('Cdigo do erro de atualizao:', updateError.code);
                             } else {
                                 console.log('Sesso atualizada com sucesso:', updateData);
                                 console.log('Total de itens confirmado:', updateData?.[0]?.total_items);
                             }
                             
                             // Salvar dados completos (com quantidade) no localStorage tambm
                             let existingProducts = JSON.parse(localStorage.getItem('products') || '[]');
                             products.forEach(newProduct => {
                                 const existingIndex = existingProducts.findIndex(p => p.codigo === newProduct.codigo);
                                 if (existingIndex >= 0) {
                                     existingProducts[existingIndex] = newProduct;
                                 } else {
                                     existingProducts.push(newProduct);
                                 }
                             });
                             localStorage.setItem('products', JSON.stringify(existingProducts));
                             
                             // Mostrar mensagem de sucesso para Supabase
                             showToast(`${products.length} produtos importados com sucesso!`, 'success');
                        } catch (supabaseError) {
                             console.warn('Falha no Supabase, usando localStorage:', supabaseError.message);
                             
                             // Fallback para localStorage
                             let existingProducts = JSON.parse(localStorage.getItem('products') || '[]');
                             
                             // Adicionar novos produtos (evitar duplicatas por cdigo)
                             products.forEach(newProduct => {
                                 const existingIndex = existingProducts.findIndex(p => p.codigo === newProduct.codigo);
                                 if (existingIndex >= 0) {
                                     existingProducts[existingIndex] = newProduct; // Atualizar
                                 } else {
                                     existingProducts.push(newProduct); // Adicionar
                                 }
                             });
                             
                             localStorage.setItem('products', JSON.stringify(existingProducts));
                             console.log('Produtos salvos no localStorage:', existingProducts.length);
                             
                             // Mostrar mensagem especfica sobre armazenamento local
                             showToast(`${products.length} produtos salvos localmente (banco indisponvel)`, 'warning');
                         }
                        importedProductsCount = products.length;
                        
                        // Atualizar indicador visual de produtos importados
                        const productsImportedCount = document.getElementById('products-imported-count');
                        const productsImportedIndicator = document.getElementById('products-imported-indicator');
                        
                        if (productsImportedCount) {
                            productsImportedCount.textContent = importedProductsCount;
                        }
                        if (productsImportedIndicator) {
                            productsImportedIndicator.style.display = 'inline';
                        }
                        
                        // Verificar se os elementos existem antes de definir propriedades
                        const importedCountEl = document.getElementById('imported-count');
                        const importStatusEl = document.getElementById('import-status');
                        
                        if (importedCountEl) {
                            importedCountEl.textContent = importedProductsCount;
                        }
                        if (importStatusEl) {
                            importStatusEl.style.display = 'flex';
                        }

                    } catch (error) {
                        console.error('Erro ao importar produtos:', error);
                        showToast('Erro ao importar produtos', 'error');
                    }
                }

                // Funo saveNewSession movida para antes do DOMContentLoaded

                async function editSession(sessionId) {
                    const session = allCountingSessions.find(s => s.id === sessionId);
                    if (!session) return;

                    const newName = prompt('Digite o novo nome da sesso:', session.session_name || '');
                    if (!newName || newName === session.session_name) return;

                    try {
                        if (currentUser && currentUser.role !== 'admin' && session.id_usuario !== currentUser.id) {
                            showToast('Voc no tem permisso para editar esta sesso', 'error');
                            return;
                        }
                        const { error } = await supabaseClient
                            .from('counting_sessions')
                            .update({ session_name: newName })
                            .eq('id', sessionId);

                        if (error) throw error;

                        showToast('Sesso atualizada com sucesso!', 'success');
                        loadCountingSessions();

                    } catch (error) {
                        console.error('Erro ao editar sesso:', error);
                        showToast('Erro ao editar sesso', 'error');
                    }
                }







                 // Manter funo original para compatibilidade
                function generateSessionCSV(session, countingItems) {
                    const sessionName = session.session_name || 'N/A';
                    const userName = currentUser?.nome || 'N/A';
                    const createdDate = new Date(session.created_at).toLocaleString('pt-BR');
                     
                     let csv = 'Relatrio de Sesso de Contagem\n\n';
                     csv += `Sesso:,${sessionName}\n`;
                     csv += `Usurio:,${userName}\n`;
                     csv += `Tipo:,${session.count_type}\n`;
                     csv += `Status:,${getStatusText(session.status)}\n`;
                     csv += `Total de Itens:,${session.total_items || 0}\n`;
                     csv += `Itens Contados:,${session.counted_items || 0}\n`;
                     csv += `Criado em:,${createdDate}\n\n`;
                     
                     if (countingItems && countingItems.length > 0) {
                         csv += 'Detalhes dos Itens:\n';
                         csv += 'ID,Cdigo,Quantidade,Data/Hora\n';
                         
                         countingItems.forEach(item => {
                             const itemDate = new Date(item.created_at).toLocaleString('pt-BR');
                             csv += `${item.id},${item.item_code || 'N/A'},${item.quantity || 0},${itemDate}\n`;
                         });
                     } else {
                         csv += 'Nenhum item de contagem encontrado.\n';
                     }
                     
                     return csv;
                 }



                 // Initialize counting page when it becomes active
                 const observer = new MutationObserver((mutations) => {
                     mutations.forEach((mutation) => {
                         if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                             const contagemPage = document.getElementById('contagem-page');
                             if (contagemPage && contagemPage.classList.contains('active')) {
                                 loadCountingSessions();
                             }
                         }
                     });
                 });

                 // Observe all pages for class changes
                 document.querySelectorAll('[data-page]').forEach(page => {
                     observer.observe(page, { attributes: true, attributeFilter: ['class'] });
                 });

                showAuthSection();
             } else {
                 showAuthSection();
             }

             // Setup event listeners after all functions are defined
             
             // Define functions
           async function loadAvailableUsers() {
                try {
                    if (!currentEmpresa || !supabaseClient) {
                        availableUsers = [];
                        return;
                    }
                    if (currentUser?.role === 'admin') {
                        const { data: usuarios, error } = await supabaseClient
                            .from('usuarios')
                            .select('id, nome, ativo')
                            .eq('id_empresa', currentEmpresa.id)
                            .eq('ativo', true)
                            .order('nome');
                        if (error || !usuarios || usuarios.length === 0) {
                            const { data: usuariosRpc, error: rpcErr } = await supabaseClient.rpc('get_usuarios_da_empresa');
                            if (!rpcErr && usuariosRpc && usuariosRpc.length > 0) {
                                availableUsers = usuariosRpc.map(u => ({ id: u.id, name: u.nome }));
                            } else {
                                availableUsers = [{ id: currentUser.id, name: currentUser.nome }];
                            }
                        } else {
                            availableUsers = (usuarios || []).map(u => ({ id: u.id, name: u.nome }));
                        }
                    } else {
                        availableUsers = [{ id: currentUser.id, name: currentUser.nome }];
                    }
                } catch (error) {
                    console.error('Erro ao carregar usurios:', error);
                    availableUsers = [];
                }
            }

             function openNewSessionSidebar() {
                 const sidebar = document.getElementById('new-session-sidebar');
                 const userSelect = document.getElementById('session-user');
                 
                 if (!sidebar) {
                     console.error('Elemento sidebar no encontrado!');
                     return;
                 }
                 
                 // Limpar formulrio
                 const form = document.getElementById('new-session-form');
                 if (form) {
                     form.reset();
                 }
                 selectedFile = null;
                 importedProductsCount = 0;
                 
                 const fileInfo = document.getElementById('file-info');
                 const importStatus = document.getElementById('import-status');
                 if (fileInfo) fileInfo.style.display = 'none';
                 if (importStatus) importStatus.style.display = 'none';
                 
                 // Preencher combo de usurios
                userSelect.innerHTML = '<option value="">Selecione um usurio</option>';
                availableUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    if (user.id === currentUser.id) {
                        option.selected = true;
                    }
                    userSelect.appendChild(option);
                });
                if (currentUser?.role !== 'admin') {
                    userSelect.disabled = true;
                } else {
                    userSelect.disabled = false;
                }
                 
                 sidebar.classList.add('active');
             }



         async function createNewSession() {
                 
                 // Verificar se j existe uma sesso de importao ativa
                 const existingImportSession = allCountingSessions.find(session => 
                     session.session_name && 
                     session.session_name.includes('Importao CSV') && 
                     session.status === 'waiting' &&
                     session.total_items > 0
                 );
                 
                 if (existingImportSession) {
                     showToast('J existe uma sesso de importao ativa. Complete ou exclua a sesso existente antes de criar uma nova.', 'warning');
                     return;
                 }
                 
                 try {
                     await loadAvailableUsers();
                     openNewSessionSidebar();
                 } catch (error) {
                     console.error('Erro em createNewSession:', error);
                 }
             }

             // New session button event listener
             const newSessionBtn = document.getElementById('new-session-btn');
             if (newSessionBtn) {
                 newSessionBtn.addEventListener('click', () => {
                     createNewSession();
                 });
             } else {
                 console.error('newSessionBtn no encontrado!');
             }

             // Refresh sessions button
             const refreshSessionsBtn = document.getElementById('refresh-sessions-btn');
             if (refreshSessionsBtn) {
                 refreshSessionsBtn.addEventListener('click', () => {
                     if (typeof loadCountingSessions === 'function') {
                         loadCountingSessions();
                     } else {
                         console.error('loadCountingSessions no  uma funo');
                     }
                 });
             }

             // Sidebar event listeners

             const cancelSidebarBtn = document.getElementById('cancel-session-btn');
             if (cancelSidebarBtn) {
                 cancelSidebarBtn.addEventListener('click', () => {
                     if (typeof closeNewSessionSidebar === 'function') {
                         closeNewSessionSidebar();
                     }
                 });
             }

             // Event listeners movidos para DOMContentLoaded

             const productFileInput = document.getElementById('products-file');
             if (productFileInput) {
                 productFileInput.addEventListener('change', (e) => {
                     if (typeof handleFileSelect === 'function') {
                         handleFileSelect(e);
                     }
                 });
             }

             const importProductsBtn = document.getElementById('import-products-btn');
             if (importProductsBtn) {
                 importProductsBtn.addEventListener('click', () => {

                     if (typeof importProducts === 'function') {
                         importProducts();
                     }
                 });
             }

             const fileUploadArea = document.getElementById('file-upload-area');
             if (fileUploadArea) {
                 fileUploadArea.addEventListener('click', () => {
                     const fileInput = document.getElementById('products-file');
                     if (fileInput) fileInput.click();
                 });
             }

             const sidebarOverlay = document.getElementById('sidebar-overlay');
             if (sidebarOverlay) {
                 sidebarOverlay.addEventListener('click', () => {
                     if (typeof closeNewSessionSidebar === 'function') {
                         closeNewSessionSidebar();
                     }
                 });
             }

             // Configurar event listeners para os formulrios de configurao
             const formContagens = document.getElementById('form-configurar-contagens');
             const formExportacoes = document.getElementById('form-configurar-exportacoes');

             if (formContagens) {
                 formContagens.addEventListener('submit', handleSaveConfigContagens);
             }

             if (formExportacoes) {
                 formExportacoes.addEventListener('submit', handleSaveConfigExportacoes);
             }

             // Carregar configuraes existentes ao inicializar
             loadExistingConfigurations();
         });

         // ===== FUNES DE CONFIGURAO =====

         // Funo para carregar configuraes de contagens
         async function loadConfiguracaoContagens() {
             await loadExistingConfigurations();
         }

         // Funo para carregar configuraes de exportaes
         async function loadConfiguracaoExportacoes() {
             await loadExistingConfigurations();
         }

         // Funo para carregar configuraes existentes
        async function loadExistingConfigurations() {
            try {
                if (!currentEmpresa) return;
                const { data, error } = await supabaseClient
                    .from('configuracao_estoque')
                    .select('*')
                    .eq('id_empresa', currentEmpresa.id)
                    .limit(1)
                    .single();

                 if (error && error.code !== 'PGRST116') {
                     console.error('Erro ao carregar configuraes:', error);
                     return;
                 }

                 if (data) {
                     populateConfigurationForms(data);
                 }
             } catch (error) {
                 console.error('Erro ao carregar configuraes:', error);
             }
         }

         // Funo para popular os formulrios com dados existentes
         function populateConfigurationForms(config) {
             // Formulrio de Contagens
             document.getElementById('tipo-contagem-padrao').value = config.tipo_contagem_padrao || 'normal';
             document.getElementById('tipo-importacao-padrao').value = config.tipo_importacao_padrao || 'csv';
             document.getElementById('importacao-descricao').checked = config.importacao_incluir_descricao || false;
             document.getElementById('importacao-localizacao').checked = config.importacao_incluir_localizacao || false;

             // Formulrio de Exportaes
             document.getElementById('tipo-exportacao').value = config.tipo_exportacao || 'detalhada';
             document.getElementById('tipo-exportacao-padrao').value = config.tipo_exportacao_padrao || 'csv';
             document.getElementById('exportacao-descricao').checked = config.exportacao_incluir_descricao || false;
             document.getElementById('exportacao-localizacao').checked = config.exportacao_incluir_localizacao || false;
         }

         // Funo para salvar configuraes de contagens
         async function handleSaveConfigContagens(event) {
             event.preventDefault();

             const formData = new FormData(event.target);
             const configData = {
                 tipo_contagem_padrao: formData.get('tipo_contagem_padrao'),
                 tipo_importacao_padrao: formData.get('tipo_importacao_padrao'),
                 importacao_incluir_codigo: true, // Sempre true
                 importacao_incluir_quantidade: true, // Sempre true
                 importacao_incluir_descricao: formData.has('importacao_incluir_descricao'),
                 importacao_incluir_localizacao: formData.has('importacao_incluir_localizacao')
             };

             await saveConfiguration(configData, 'message-contagens');
         }

         // Funo para salvar configuraes de exportaes
         async function handleSaveConfigExportacoes(event) {
             event.preventDefault();

             const formData = new FormData(event.target);
             const configData = {
                 tipo_exportacao: formData.get('tipo_exportacao'),
                 tipo_exportacao_padrao: formData.get('tipo_exportacao_padrao'),
                 exportacao_incluir_codigo: true, // Sempre true
                 exportacao_incluir_quantidade: true, // Sempre true
                 exportacao_incluir_descricao: formData.has('exportacao_incluir_descricao'),
                 exportacao_incluir_localizacao: formData.has('exportacao_incluir_localizacao')
             };

             await saveConfiguration(configData, 'message-exportacoes');
         }

         // Funo principal para salvar configurao
        async function saveConfiguration(configData, messageElementId) {
            const messageElement = document.getElementById(messageElementId);
             
            try {
                // Mostrar mensagem de carregamento
                showMessage(messageElement, 'Salvando configuraes...', 'info');

                // Verificar se j existe uma configurao
                if (!currentEmpresa) {
                    showMessage(messageElement, 'Nenhuma empresa selecionada', 'error');
                    return;
                }
                if (!currentUser || currentUser.role !== 'admin') {
                    showMessage(messageElement, 'Permisso negada', 'error');
                    return;
                }
                const { data: existingConfig, error: selectError } = await supabaseClient
                    .from('configuracao_estoque')
                    .select('id')
                    .eq('id_empresa', currentEmpresa.id)
                    .limit(1)
                    .single();

                 let result;
                 if (existingConfig) {
                     // Atualizar configurao existente
                    result = await supabaseClient
                        .from('configuracao_estoque')
                        .update({
                            ...configData,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingConfig.id);
                } else {
                    // Criar nova configurao
                    result = await supabaseClient
                        .from('configuracao_estoque')
                        .insert([{ ...configData, id_empresa: currentEmpresa.id }]);
                }

                 if (result.error) {
                     throw result.error;
                 }

                 showMessage(messageElement, 'Configuraes salvas com sucesso!', 'success');
                 
                 // Recarregar configuraes para sincronizar
                 setTimeout(() => {
                     loadExistingConfigurations();
                 }, 1000);

             } catch (error) {
                 console.error('Erro ao salvar configuraes:', error);
                 showMessage(messageElement, `Erro ao salvar configuraes: ${error.message}`, 'error');
             }
         }

         // Funo para mostrar mensagens
         function showMessage(element, message, type) {
             element.textContent = message;
             element.className = `message-area ${type}`;
             element.style.display = 'block';

             if (type === 'success' || type === 'info') {
                 setTimeout(() => {
                     element.style.display = 'none';
                 }, 5000);
             }
         }

         // Funo para resetar formulrio de contagens
         function resetFormContagens() {
             document.getElementById('tipo-contagem-padrao').value = 'normal';
             document.getElementById('tipo-importacao-padrao').value = 'csv';
             document.getElementById('importacao-descricao').checked = false;
             document.getElementById('importacao-localizacao').checked = false;
             
             const messageElement = document.getElementById('message-contagens');
             messageElement.style.display = 'none';
         }

         // Funo para resetar formulrio de exportaes
         function resetFormExportacoes() {
             document.getElementById('tipo-exportacao').value = 'detalhada';
             document.getElementById('tipo-exportacao-padrao').value = 'csv';
             document.getElementById('exportacao-descricao').checked = false;
             document.getElementById('exportacao-localizacao').checked = false;
             
             const messageElement = document.getElementById('message-exportacoes');
             messageElement.style.display = 'none';
         }

         // ===== PRODUTOS PAGE FUNCTIONS =====
         
         // Variveis globais para produtos
         let currentProductsPage = 1;
         let productsPerPage = 20;
         let totalProducts = 0;
         let currentProductsSort = { field: 'created_at', direction: 'desc' };
         let productsFilters = {
             search: '',
             session_id: '',
             is_counted: ''
         };

         // Carregar produtos do Supabase
         async function loadProducts() {
             try {
            if (!supabaseClient) {
                showToast('Conexo com banco de dados indisponvel', 'error');
                return;
            }
            if (!currentEmpresa) {
                showToast('Empresa no definida no contexto', 'error');
                return;
            }

                 // Construir query base
                let query = supabaseClient
                    .from('products')
                    .select('*, counting_sessions!inner(id_empresa)', { count: 'exact' })
                    .eq('counting_sessions.id_empresa', currentEmpresa.id);

                 // Aplicar filtros
                 if (productsFilters.search) {
                     query = query.or(`codigo.ilike.%${productsFilters.search}%,descricao.ilike.%${productsFilters.search}%`);
                 }

                 if (productsFilters.session_id) {
                     query = query.eq('session_id', productsFilters.session_id);
                 }

                 if (productsFilters.is_counted !== '') {
                     query = query.eq('is_counted', productsFilters.is_counted === 'true');
                 }

                 // Aplicar ordenao
                query = query.order(currentProductsSort.field, { ascending: currentProductsSort.direction === 'asc' });

                 // Aplicar paginao
                 const from = (currentProductsPage - 1) * productsPerPage;
                 const to = from + productsPerPage - 1;
                 query = query.range(from, to);

                const { data: products, error, count } = await query;

                if (error) {
                    console.error('Erro ao carregar produtos:', error);
                    const { data: productsRpc, error: rpcErr } = await supabaseClient.rpc('search_products_for_empresa', {
                        p_session_id: productsFilters.session_id || null,
                        p_search: productsFilters.search || null,
                        p_is_counted: productsFilters.is_counted === '' ? null : (productsFilters.is_counted === 'true')
                    });
                    if (rpcErr) {
                        showToast('Erro ao carregar produtos: ' + error.message, 'error');
                        return;
                    }
                    totalProducts = (productsRpc || []).length;
                    displayProducts(productsRpc || []);
                    updateProductsPagination();
                    return;
                }

                totalProducts = count || 0;
                displayProducts(products || []);
                updateProductsPagination();

             } catch (error) {
                 console.error('Erro ao carregar produtos:', error);
                 showToast('Erro ao carregar produtos', 'error');
             }
         }

         // Exibir produtos na tabela
        function displayProducts(products) {
            const tbody = document.getElementById('products-table-body');
            const emptyState = document.getElementById('products-empty-state');
            const tableContainer = document.querySelector('#produtos-page .table-container');

            if (!products || products.length === 0) {
                tbody.innerHTML = '';
                tableContainer.style.display = 'none';
                emptyState.classList.remove('hidden');
                return;
            }

            tableContainer.style.display = 'block';
            emptyState.classList.add('hidden');

            const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
            tbody.innerHTML = products.map(product => {
                const statusBadge = product.is_counted 
                    ? '<span class="badge badge-success">Contado</span>'
                    : '<span class="badge badge-warning">Pendente</span>';
                
                const createdAt = new Date(product.created_at).toLocaleDateString('pt-BR');
                const sessionName = 'Sesso ' + esc(product.session_id || 'N/A');

                return `
                    <tr>
                        <td><strong>${esc(product.codigo)}</strong></td>
                        <td>${esc(product.descricao)}</td>
                        <td>${esc(product.localizacao || '-')}</td>
                        <td class="text-center">${product.quantidade_atual || 0}</td>
                        <td class="text-center">${product.quantidade_contada || 0}</td>
                        <td class="text-center">${product.scanned_qty || 0}</td>
                        <td class="text-center">${statusBadge}</td>
                        <td class="text-center">${createdAt}</td>
                        <td class="text-center">
                            <div class="action-buttons">
                            <button class="action-btn view" onclick="viewProduct('${product.id}')" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editProduct('${product.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteProduct('${product.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
         }

         // Atualizar informaes de paginao
         function updateProductsPagination() {
             const totalPages = Math.ceil(totalProducts / productsPerPage);
             const startItem = totalProducts > 0 ? (currentProductsPage - 1) * productsPerPage + 1 : 0;
             const endItem = Math.min(currentProductsPage * productsPerPage, totalProducts);

             document.getElementById('products-pagination-info').textContent = 
                 `Mostrando ${startItem} a ${endItem} de ${totalProducts} produtos`;
             
             document.getElementById('products-page-info').textContent = 
                 `Pgina ${currentProductsPage} de ${totalPages}`;

             document.getElementById('products-prev-btn').disabled = currentProductsPage <= 1;
             document.getElementById('products-next-btn').disabled = currentProductsPage >= totalPages;
         }

         // Carregar sesses para o filtro
         async function loadSessionsForFilter() {
             try {
                if (!supabaseClient) return;

                let query = supabaseClient
                    .from('counting_sessions')
                    .select('id, session_name')
                    .eq('id_empresa', currentEmpresa.id);
                if (currentUser?.role !== 'admin') {
                    query = query.eq('id_usuario', currentUser.id);
                }
                const { data: sessions, error } = await query
                    .order('id', { ascending: false });

                if (error) {
                    const { data: sessionsRpc, error: rpcErr } = await supabaseClient.rpc('get_counting_sessions_for_current_user');
                    if (rpcErr) {
                        console.error('Erro ao carregar sesses:', error);
                        return;
                    }
                    const sessionFilter = document.getElementById('session-filter');
                    sessionFilter.innerHTML = '<option value="">Todas as Sesses</option>';
                    (sessionsRpc || []).forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.id;
                        option.textContent = session.session_name || `Sesso ${session.id}`;
                        sessionFilter.appendChild(option);
                    });
                    return;
                }

                const sessionFilter = document.getElementById('session-filter');
                sessionFilter.innerHTML = '<option value="">Todas as Sesses</option>';
                
                 sessions.forEach(session => {
                     const option = document.createElement('option');
                     option.value = session.id;
                     option.textContent = session.session_name || `Sesso ${session.id}`;
                     sessionFilter.appendChild(option);
                 });

             } catch (error) {
                 console.error('Erro ao carregar sesses:', error);
             }
         }

         // Aplicar filtros
         function applyProductsFilters() {
             productsFilters.search = document.getElementById('product-search').value.trim();
             productsFilters.session_id = document.getElementById('session-filter').value;
             productsFilters.is_counted = document.getElementById('counted-filter').value;
             
             currentProductsPage = 1;
             loadProducts();
         }

         // Limpar filtros
         function clearProductsFilters() {
             document.getElementById('product-search').value = '';
             document.getElementById('session-filter').value = '';
             document.getElementById('counted-filter').value = '';
             
             productsFilters = { search: '', session_id: '', is_counted: '' };
             currentProductsPage = 1;
             loadProducts();
         }

         // Ordenar produtos
         function sortProducts(field) {
             if (currentProductsSort.field === field) {
                 currentProductsSort.direction = currentProductsSort.direction === 'asc' ? 'desc' : 'asc';
             } else {
                 currentProductsSort.field = field;
                 currentProductsSort.direction = 'asc';
             }
             
             currentProductsPage = 1;
             loadProducts();
         }

         // Aes dos produtos
         // Funo para visualizar auditoria de scans do produto
        async function viewProduct(productId) {
            const sidebar = document.getElementById('scan-audit-sidebar');
            const tbody = document.getElementById('scan-audit-table-body');
            const infoDiv = document.getElementById('scan-audit-product-info');
            
            if (!sidebar || !tbody || !infoDiv) {
                console.error('Elementos da sidebar de auditoria no encontrados');
                return;
            }

            // Encontrar o produto na lista local
            let product = products.find(p => p.id === productId);
            
            if (!product) {
                 // Tentar buscar do banco se no achar localmente (fallback)
                 try {
                     const { data, error } = await supabaseClient
                        .from('products')
                        .select('*')
                        .eq('id', productId)
                        .single();
                     if (error) throw error;
                     product = data;
                 } catch(e) {
                     showToast('Produto no encontrado', 'error');
                     return;
                 }
            }

            // Preencher info bsica do produto
            const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
            infoDiv.innerHTML = `
                <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">${esc(product.descricao)}</h4>
                <div style="font-size: 0.9em; color: var(--text-secondary);">
                    <strong>Cdigo:</strong> ${esc(product.codigo)} <br>
                    <strong>Localizao:</strong> ${esc(product.localizacao || '-')} <br>
                    <strong>Total Contado:</strong> ${product.quantidade_contada || 0}
                </div>
            `;

            // Limpar tabela e mostrar loading
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center" style="padding: 2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando scans...
                    </td>
                </tr>
            `;

            // Abrir sidebar
            sidebar.classList.add('active');

            try {
                // Buscar scans do servidor
                const { data: scans, error } = await supabaseClient
                    .from('scans')
                    .select('*')
                    .eq('product_id', productId)
                    .order('scanned_at', { ascending: false });

                if (error) throw error;

                if (!scans || scans.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center" style="padding: 2rem; color: var(--text-secondary);">
                                <i class="fas fa-info-circle"></i> Nenhum registro de scan encontrado.
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Renderizar scans
                tbody.innerHTML = scans.map(scan => {
                    const date = new Date(scan.scanned_at);
                    const dateStr = date.toLocaleDateString('pt-BR');
                    const timeStr = date.toLocaleTimeString('pt-BR');
                    
                    const typeIcon = scan.scan_type === 'manual' 
                        ? '<i class="fas fa-keyboard" title="Manual"></i>' 
                        : '<i class="fas fa-barcode" title="Cdigo de Barras"></i>';

                    return `
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border);">
                                <div style="font-size: 0.9em;">${dateStr}</div>
                                <div style="font-size: 0.8em; color: var(--text-secondary);">${timeStr}</div>
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border);">
                                ${esc(scan.code)}
                            </td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border);">
                                <span class="badge ${scan.quantity > 0 ? 'badge-success' : 'badge-danger'}">
                                    ${scan.quantity > 0 ? '+' : ''}${scan.quantity}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border); color: var(--text-secondary);">
                                ${typeIcon}
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error('Erro ao carregar scans:', err);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger" style="padding: 2rem;">
                            Erro ao carregar dados: ${esc(err.message)}
                        </td>
                    </tr>
                `;
                showToast('Erro ao carregar histrico de scans', 'error');
            }
        }

        function closeAuditSidebar() {
            const sidebar = document.getElementById('scan-audit-sidebar');
            if (sidebar) {
                sidebar.classList.remove('active');
            }
        }

         function editProduct(productId) {
             showToast('Funcionalidade de edio em desenvolvimento', 'info');
         }

        async function deleteProduct(productId) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) {
                return;
            }

            try {
                if (!productId || !/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(productId))) {
                    showToast('ID do produto invlido. Recarregue a lista.', 'error');
                    return;
                }
                if (!currentUser || currentUser.role !== 'admin') {
                    showToast('Permisso negada', 'error');
                    return;
                }
                if (!supabaseClient) {
                    showToast('Conexo com banco de dados indisponvel', 'error');
                    return;
                }

                const { error } = await supabaseClient.rpc('delete_product', { p_product_id: productId });

                if (error) {
                    console.error('Erro ao excluir produto:', error);
                    showToast('Erro ao excluir produto: ' + error.message, 'error');
                    return;
                 }

                 showToast('Produto excludo com sucesso!', 'success');
                 loadProducts();

             } catch (error) {
                 console.error('Erro ao excluir produto:', error);
                 showToast('Erro ao excluir produto', 'error');
             }
         }

         // Exportar produtos
         async function exportProducts() {
             try {
            if (!supabaseClient) {
                showToast('Conexo com banco de dados indisponvel', 'error');
                return;
            }
            if (!currentEmpresa) {
                showToast('Empresa no definida no contexto', 'error');
                return;
            }

            // Buscar todos os produtos (sem paginao para exportao)
            let query = supabaseClient
                .from('products')
                .select('*, counting_sessions!inner(id_empresa)')
                .eq('counting_sessions.id_empresa', currentEmpresa.id);

             // Aplicar os mesmos filtros da visualizao
             if (productsFilters.search) {
                 query = query.or(`codigo.ilike.%${productsFilters.search}%,descricao.ilike.%${productsFilters.search}%`);
             }

                 if (productsFilters.session_id) {
                     query = query.eq('session_id', productsFilters.session_id);
                 }

                 if (productsFilters.is_counted !== '') {
                     query = query.eq('is_counted', productsFilters.is_counted === 'true');
                 }

                 query = query.order(currentProductsSort.field, { ascending: currentProductsSort.direction === 'asc' });

                 const { data: products, error } = await query;

                 if (error) {
                     console.error('Erro ao buscar produtos para exportao:', error);
                     showToast('Erro ao exportar produtos: ' + error.message, 'error');
                     return;
                 }

                 if (!products || products.length === 0) {
                     showToast('Nenhum produto encontrado para exportao', 'warning');
                     return;
                 }

                 // Gerar CSV
                 const headers = ['Cdigo', 'Descrio', 'Qtd. Atual', 'Qtd. Contada', 'Qtd. Bipada', 'Status', 'Sesso', 'Data Criao'];
                 let csv = headers.join(',') + '\n';

                 products.forEach(product => {
                     const row = [
                         `"${product.codigo}"`,
                         `"${product.descricao}"`,
                         product.quantidade_atual || 0,
                         product.quantidade_contada || 0,
                         product.scanned_qty || 0,
                         product.is_counted ? 'Contado' : 'Pendente',
                         `"Sesso ${product.session_id || 'N/A'}"`,
                         `"${new Date(product.created_at).toLocaleDateString('pt-BR')}"`
                     ];
                     csv += row.join(',') + '\n';
                 });

                 // Download do arquivo
                 const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                 const link = document.createElement('a');
                 const url = URL.createObjectURL(blob);
                 link.setAttribute('href', url);
                 link.setAttribute('download', `produtos_${new Date().toISOString().split('T')[0]}.csv`);
                 link.style.visibility = 'hidden';
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);

                 showToast(`${products.length} produtos exportados com sucesso!`, 'success');

             } catch (error) {
                 console.error('Erro ao exportar produtos:', error);
                 showToast('Erro ao exportar produtos', 'error');
             }
         }

         // Event listeners para pgina de produtos
         document.addEventListener('DOMContentLoaded', function() {
             // Filtros
             document.getElementById('product-search')?.addEventListener('input', debounce(applyProductsFilters, 500));
             document.getElementById('session-filter')?.addEventListener('change', applyProductsFilters);
             document.getElementById('counted-filter')?.addEventListener('change', applyProductsFilters);
             document.getElementById('clear-products-filters-btn')?.addEventListener('click', clearProductsFilters);

             // Botes de ao
             document.getElementById('refresh-products-btn')?.addEventListener('click', () => {
                 loadProducts();
                 loadSessionsForFilter();
             });
             document.getElementById('export-products-btn')?.addEventListener('click', exportProducts);

             // Paginao
             document.getElementById('products-prev-btn')?.addEventListener('click', () => {
                 if (currentProductsPage > 1) {
                     currentProductsPage--;
                     loadProducts();
                 }
             });
             document.getElementById('products-next-btn')?.addEventListener('click', () => {
                 const totalPages = Math.ceil(totalProducts / productsPerPage);
                 if (currentProductsPage < totalPages) {
                     currentProductsPage++;
                     loadProducts();
                 }
             });

             // Ordenao
             document.querySelectorAll('#products-table th[data-sort]').forEach(th => {
                 th.addEventListener('click', () => {
                     const field = th.getAttribute('data-sort');
                     sortProducts(field);
                 });
             });

             // Carregar dados quando a pgina de produtos for ativada
             const observer = new MutationObserver(function(mutations) {
                 mutations.forEach(function(mutation) {
                     if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                         const produtosPage = document.getElementById('produtos-page');
                         if (produtosPage && !produtosPage.classList.contains('hidden')) {
                             loadProducts();
                             loadSessionsForFilter();
                         }
                     }
                 });
             });

             const produtosPage = document.getElementById('produtos-page');
             if (produtosPage) {
                 observer.observe(produtosPage, { attributes: true });
             }
         });

         // Funo debounce para otimizar pesquisa
         function debounce(func, wait) {
             let timeout;
             return function executedFunction(...args) {
                 const later = () => {
                     clearTimeout(timeout);
                     func(...args);
                 };
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
             };
         }

         // Funo para gerar CSV de contagem
         function generateCountingCSV(session, countedProducts, config) {
             // Definir configuraes padro se no existirem
             const exportConfig = {
                 exportacao_incluir_codigo: true, // Sempre includo
                 exportacao_incluir_quantidade: true, // Sempre includo (quantidade_contada)
                 exportacao_incluir_descricao: config?.exportacao_incluir_descricao || false,
                 exportacao_incluir_localizacao: config?.exportacao_incluir_localizacao || false
             };

             // Construir cabealho do CSV baseado nas configuraes
             let headers = [];
             if (exportConfig.exportacao_incluir_codigo) headers.push('codigo');
             if (exportConfig.exportacao_incluir_quantidade) headers.push('quantidade_contada');
             if (exportConfig.exportacao_incluir_descricao) headers.push('descricao');
             if (exportConfig.exportacao_incluir_localizacao) headers.push('localizacao');

             let csv = headers.join(',') + '\n';

             // Processar produtos contados
             if (countedProducts && countedProducts.length > 0) {
                 countedProducts.forEach(product => {
                     let row = [];
                     
                     if (exportConfig.exportacao_incluir_codigo) {
                         row.push(product.codigo || ''); 
                     }
                     
                     if (exportConfig.exportacao_incluir_quantidade) {
                         // Usar a quantidade contada do produto
                         const totalQuantity = product.quantidade_contada || 0;
                         row.push(totalQuantity);
                     }
                     
                     if (exportConfig.exportacao_incluir_descricao) {
                         row.push(`"${product.descricao || ''}"`); 
                     }
                     
                     if (exportConfig.exportacao_incluir_localizacao) {
                         row.push(`"${product.localizacao || ''}"`); 
                     }
                     
                     csv += row.join(',') + '\n';
                 });
             }

             return csv;
         }

         // Funo para download de CSV da sesso
         async function downloadSessionCSV(sessionId) {
             try {
                 // Buscar dados da sesso
               const { data: session, error: sessionError } = await supabaseClient
                   .from('counting_sessions')
                   .select('*')
                   .eq('id', sessionId)
                   .single();

                if (sessionError) throw sessionError;

                // Buscar dados do usurio separadamente
               const { data: usuario, error: userError } = await supabaseClient
                   .from('usuarios')
                   .select('nome')
                   .eq('id', session.id_usuario)
                   .eq('id_empresa', session.id_empresa)
                   .single();

                // Adicionar nome do usurio  sesso (se encontrado)
                 if (usuario && !userError) {
                     session.user_name = usuario.nome;
                 }

                 // Buscar produtos contados da sesso com informaes completas
                const { data: countedProducts, error: productsError } = await supabaseClient
                    .from('products')
                    .select(`
                        codigo,
                        descricao,
                        quantidade_contada,
                        scanned_qty
                    `)
                    .eq('session_id', sessionId)
                    .gt('quantidade_contada', 0);

                 if (productsError) throw productsError;

                // Carregar configuraes de exportao
               const { data: config } = await supabaseClient
                   .from('configuracao_estoque')
                   .select('*')
                   .eq('id_empresa', session.id_empresa)
                   .limit(1)
                   .single();

                 // Gerar CSV com base nas configuraes
                 const csvContent = generateCountingCSV(session, countedProducts, config);
                 
                 // Criar nome do arquivo: Contagem-nome_da_sessao-data.csv
                 const sessionName = (session.session_name || 'Sessao').replace(/[^a-zA-Z0-9]/g, '_');
                 const date = new Date().toISOString().split('T')[0];
                 const filename = `Contagem-${sessionName}-${date}.csv`;

                 // Criar e baixar o arquivo com seletor de pasta
                 const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                 
                 // Verificar se o navegador suporta File System Access API
                 if ('showSaveFilePicker' in window) {
                     try {
                         const fileHandle = await window.showSaveFilePicker({
                             suggestedName: filename,
                             types: [{
                                 description: 'Arquivos CSV',
                                 accept: { 'text/csv': ['.csv'] }
                             }]
                         });
                         const writable = await fileHandle.createWritable();
                         await writable.write(blob);
                         await writable.close();
                     } catch (err) {
                         if (err.name !== 'AbortError') {
                             console.error('Erro ao salvar arquivo:', err);
                             // Fallback para download automtico
                             const link = document.createElement('a');
                             const url = URL.createObjectURL(blob);
                             link.setAttribute('href', url);
                             link.setAttribute('download', filename);
                             link.style.visibility = 'hidden';
                             document.body.appendChild(link);
                             link.click();
                             document.body.removeChild(link);
                         }
                     }
                 } else {
                     // Fallback para navegadores que no suportam File System Access API
                     const link = document.createElement('a');
                     const url = URL.createObjectURL(blob);
                     link.setAttribute('href', url);
                     link.setAttribute('download', filename);
                     link.style.visibility = 'hidden';
                     document.body.appendChild(link);
                     link.click();
                     document.body.removeChild(link);
                 }

                 showToast('Arquivo CSV baixado com sucesso!', 'success');
             } catch (error) {
                 console.error('Erro ao baixar CSV:', error);
                 showToast('Erro ao baixar arquivo CSV', 'error');
             }
         }

         // ===== ESTATSTICAS FUNCTIONS =====
         
         // Variveis globais para estatsticas
         let statisticsFilters = {
             session_id: '',
             status: ''
         };
         let currentStatisticsPage = 1;
         let statisticsPerPage = 20;
         let totalStatistics = 0;
         let currentStatisticsSort = { field: 'codigo', direction: 'asc' };

        // Carregar estatsticas
        async function loadStatistics() {
            try {
               if (!supabaseClient) {
                   showToast('Conexo com banco de dados indisponvel', 'error');
                   return;
               }
               if (!currentEmpresa) {
                   showToast('Empresa no definida no contexto', 'error');
                   return;
               }

               const isCountedParam = statisticsFilters.status === 'counted' ? true
                                     : statisticsFilters.status === 'not-counted' ? false
                                     : null;

               const { data: productsRpc, error: rpcErr } = await supabaseClient.rpc('search_products_for_empresa', {
                   p_session_id: statisticsFilters.session_id || null,
                   p_search: null,
                   p_is_counted: isCountedParam
               });
               if (rpcErr) {
                   console.error('Erro ao carregar estatsticas:', rpcErr);
                   showToast('Erro ao carregar estatsticas: ' + rpcErr.message, 'error');
                   return;
               }
               let productsAdapted = (productsRpc || []).map(p => ({
                   ...p,
                   counting_sessions: { session_name: p.counting_session_name }
               }));

               if (statisticsFilters.status === 'variance') {
                   productsAdapted = productsAdapted.filter(p => (p.quantidade_contada || 0) !== (p.expected_qty || 0));
               }

               // Ordenao
               const dir = currentStatisticsSort.direction === 'asc' ? 1 : -1;
               productsAdapted.sort((a, b) => {
                   const fa = a[currentStatisticsSort.field] ?? '';
                   const fb = b[currentStatisticsSort.field] ?? '';
                   return fa > fb ? dir : fa < fb ? -dir : 0;
               });

               // Paginao
               totalStatistics = productsAdapted.length;
               const from = (currentStatisticsPage - 1) * statisticsPerPage;
               const to = from + statisticsPerPage;
               const pageSlice = productsAdapted.slice(from, to);

               displayStatistics(pageSlice);
               updateStatisticsPagination();
               updateStatisticsSummary(productsAdapted);

            } catch (error) {
                console.error('Erro ao carregar estatsticas:', error);
                showToast('Erro ao carregar estatsticas', 'error');
            }
        }

         // Exibir estatsticas na tabela
         function displayStatistics(products) {
             const tbody = document.getElementById('statistics-table-body');
             const emptyState = document.getElementById('statistics-empty-state');
             const tableContainer = document.querySelector('#estatisticas-page .table-container');

             if (!tbody) return;

             if (!products || products.length === 0) {
                 tbody.innerHTML = '';
                 if (emptyState) emptyState.classList.remove('hidden');
                 if (tableContainer) tableContainer.style.display = 'none';
                 return;
             }

             if (emptyState) emptyState.classList.add('hidden');
             if (tableContainer) tableContainer.style.display = 'block';

             tbody.innerHTML = products.map(product => {
                 const expectedQty = product.expected_qty || 0;
                 const countedQty = product.quantidade_contada || 0;
                 const scannedQty = product.scanned_qty || 0;
                 const variance = countedQty - expectedQty;
                 const variancePercent = expectedQty > 0 ? ((variance / expectedQty) * 100).toFixed(2) : '0.00';
                 
                 const statusClass = product.is_counted ? 'success' : 'warning';
                 const statusText = product.is_counted ? 'Contado' : 'Pendente';
                 
                 const varianceClass = variance > 0 ? 'text-success' : variance < 0 ? 'text-danger' : 'text-muted';
                 const varianceIcon = variance > 0 ? 'fa-arrow-up' : variance < 0 ? 'fa-arrow-down' : 'fa-minus';

                 return `
                     <tr>
                         <td>${product.codigo || '-'}</td>
                         <td>${product.descricao || '-'}</td>
                         <td class="text-center">${expectedQty}</td>
                         <td class="text-center">${countedQty}</td>
                         <td class="text-center">${scannedQty}</td>
                         <td class="text-center ${varianceClass}">
                             <i class="fas ${varianceIcon}"></i> ${variance > 0 ? '+' : ''}${variance}
                         </td>
                         <td class="text-center ${varianceClass}">
                             ${variance > 0 ? '+' : ''}${variancePercent}%
                         </td>
                         <td class="text-center">
                             <span class="badge badge-${statusClass}">${statusText}</span>
                         </td>
                         <td>${product.counting_sessions?.session_name || '-'}</td>
                     </tr>
                 `;
             }).join('');
         }

         // Atualizar resumo das estatsticas
         function updateStatisticsSummary(products) {
             const totalProducts = products.length;
             const countedProducts = products.filter(p => p.is_counted).length;
             const varianceProducts = products.filter(p => {
                 const variance = (p.quantidade_contada || 0) - (p.expected_qty || 0);
                 return variance !== 0;
             }).length;
             const accuracy = totalProducts > 0 ? ((countedProducts / totalProducts) * 100).toFixed(1) : '0.0';

             // Atualizar cards de resumo
             const totalStat = document.getElementById('total-products-stat');
             const countedStat = document.getElementById('counted-products-stat');
             const varianceStat = document.getElementById('variance-products-stat');
             const accuracyStat = document.getElementById('accuracy-stat');

             if (totalStat) totalStat.textContent = totalProducts;
             if (countedStat) countedStat.textContent = countedProducts;
             if (varianceStat) varianceStat.textContent = varianceProducts;
             if (accuracyStat) accuracyStat.textContent = accuracy + '%';
         }

         // Atualizar paginao das estatsticas
         function updateStatisticsPagination() {
             const totalPages = Math.ceil(totalStatistics / statisticsPerPage);
             
             // Atualizar informaes de paginao
             const paginationInfo = document.getElementById('statistics-pagination-info');
             const pageInfo = document.getElementById('statistics-page-info');
             const prevBtn = document.getElementById('statistics-prev-btn');
             const nextBtn = document.getElementById('statistics-next-btn');

             if (paginationInfo) {
                 const start = (currentStatisticsPage - 1) * statisticsPerPage + 1;
                 const end = Math.min(currentStatisticsPage * statisticsPerPage, totalStatistics);
                 paginationInfo.textContent = `Mostrando ${start} a ${end} de ${totalStatistics} produtos`;
             }

             if (pageInfo) {
                 pageInfo.textContent = `Pgina ${currentStatisticsPage} de ${totalPages}`;
             }

             if (prevBtn) {
                 prevBtn.disabled = currentStatisticsPage <= 1;
             }

             if (nextBtn) {
                 nextBtn.disabled = currentStatisticsPage >= totalPages;
             }
         }

         // Carregar sesses para filtro de estatsticas
        async function loadStatisticsSessions() {
            try {
               const { data: sessionsRpc, error: rpcErr } = await supabaseClient.rpc('get_counting_sessions_for_current_user');
                let sessions = sessionsRpc || [];
                if (rpcErr) {
                    let query = supabaseClient
                        .from('counting_sessions')
                        .select('id, session_name')
                        .eq('id_empresa', currentEmpresa.id);
                    if (currentUser?.role !== 'admin') {
                        query = query.eq('id_usuario', currentUser.id);
                    }
                    const { data, error } = await query.order('created_at', { ascending: false });
                    if (error) throw error;
                    sessions = data || [];
                }

                const sessionFilter = document.getElementById('statistics-session-filter');
                if (sessionFilter) {
                    sessionFilter.innerHTML = '';
                    const optAll = document.createElement('option');
                    optAll.value = '';
                    optAll.textContent = 'Todas as Sesses';
                    sessionFilter.appendChild(optAll);
                    (sessions || []).forEach(session => {
                        const opt = document.createElement('option');
                        opt.value = session.id;
                        opt.textContent = String(session.session_name || `Sesso ${session.id}`);
                        sessionFilter.appendChild(opt);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar sesses:', error);
            }
        }

         // Event listeners para estatsticas
         function setupStatisticsEventListeners() {
             // Filtros
             const sessionFilter = document.getElementById('statistics-session-filter');
             const statusFilter = document.getElementById('statistics-status-filter');
             const clearFiltersBtn = document.getElementById('clear-statistics-filters-btn');
             const refreshBtn = document.getElementById('refresh-statistics-btn');

             if (sessionFilter) {
                 sessionFilter.addEventListener('change', (e) => {
                     statisticsFilters.session_id = e.target.value;
                     currentStatisticsPage = 1;
                     loadStatistics();
                 });
             }

             if (statusFilter) {
                 statusFilter.addEventListener('change', (e) => {
                     statisticsFilters.status = e.target.value;
                     currentStatisticsPage = 1;
                     loadStatistics();
                 });
             }

             if (clearFiltersBtn) {
                 clearFiltersBtn.addEventListener('click', () => {
                     statisticsFilters = { session_id: '', status: '' };
                     if (sessionFilter) sessionFilter.value = '';
                     if (statusFilter) statusFilter.value = '';
                     currentStatisticsPage = 1;
                     loadStatistics();
                 });
             }

             if (refreshBtn) {
                 refreshBtn.addEventListener('click', () => {
                     loadStatistics();
                 });
             }

             // Paginao
             const prevBtn = document.getElementById('statistics-prev-btn');
             const nextBtn = document.getElementById('statistics-next-btn');

             if (prevBtn) {
                 prevBtn.addEventListener('click', () => {
                     if (currentStatisticsPage > 1) {
                         currentStatisticsPage--;
                         loadStatistics();
                     }
                 });
             }

             if (nextBtn) {
                 nextBtn.addEventListener('click', () => {
                     const totalPages = Math.ceil(totalStatistics / statisticsPerPage);
                     if (currentStatisticsPage < totalPages) {
                         currentStatisticsPage++;
                         loadStatistics();
                     }
                 });
             }

             // Ordenao da tabela
             const statisticsTable = document.getElementById('statistics-table');
             if (statisticsTable) {
                 statisticsTable.addEventListener('click', (e) => {
                     const th = e.target.closest('th[data-sort]');
                     if (th) {
                         const field = th.getAttribute('data-sort');
                         if (currentStatisticsSort.field === field) {
                             currentStatisticsSort.direction = currentStatisticsSort.direction === 'asc' ? 'desc' : 'asc';
                         } else {
                             currentStatisticsSort.field = field;
                             currentStatisticsSort.direction = 'asc';
                         }
                         loadStatistics();
                     }
                 });
             }
         }

         // Inicializar estatsticas quando a pgina for carregada
         function initStatistics() {
             loadStatisticsSessions();
             loadStatistics();
             setupStatisticsEventListeners();
         }
     </script>

     <!-- Sidebar para Nova Contagem -->
     <div id="new-session-sidebar" class="sidebar-overlay">
         <div class="sidebar-content">
             <div class="sidebar-header">
                 <h3><i class="fas fa-plus-circle"></i> Nova Contagem</h3>
                 <button id="close-sidebar-btn" class="close-btn">
                     <i class="fas fa-times"></i>
                 </button>
             </div>
             
             <div class="sidebar-body">
                 <form id="new-session-form">
                     <div class="form-group">
                        <label for="session-user">Usurio da Sesso *</label>
                        <select id="session-user" name="id_usuario" class="form-control" required>
                             <option value="">Selecione um usurio</option>
                         </select>
                     </div>
                     
                     <div class="form-group">
                         <label for="sidebar-count-type">Tipo de Contagem *</label>
                         <select id="sidebar-count-type" name="count_type" class="form-control" required>
                             <option value="">Selecione o tipo</option>
                             <option value="normal">Contagem com Arquivo</option>
                             <option value="avulsa">Contagem Avulsa</option>
                         </select>
                     </div>
                     

                     
                     <div class="form-group">
                         <label for="sidebar-session-name">Nome da Sesso *</label>
                         <input type="text" id="sidebar-session-name" name="session_name" class="form-control" 
                                placeholder="Ex: Contagem Estoque Janeiro 2024" required>
                     </div>
                     
                     <div class="form-group">
                         <label for="session-description">Descrio</label>
                         <textarea id="session-description" name="description" class="form-control" rows="3" 
                                   placeholder="Descrio opcional da contagem..."></textarea>
                     </div>
                 </form>
             </div>
             
             <div class="sidebar-footer">
                 <button type="button" id="cancel-session-btn" class="btn btn-secondary">
                     <i class="fas fa-times"></i> Cancelar
                 </button>
                 <button type="submit" id="save-session-btn" class="btn btn-primary" form="new-session-form">
                     <i class="fas fa-save"></i> Salvar Contagem
                 </button>
             </div>
         </div>
     </div>

     <script>

     </script>
 </body>
 </html>
