<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServeAuto SmartCount 2.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --success-color: #10b981;
            --success-bg: #dcfce7;
            --danger: #ef4444;
            --error-color: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --light: #f8fafc;
            --dark: #0f172a;
            --background: #f1f5f9;
            --bg-secondary: #f8fafc;
            --surface: #ffffff;
            --card-bg: #ffffff;
            --text: #334155;
            --text-primary: #334155;
            --text-light: #64748b;
            --border: #e2e8f0;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 0.5rem;
            --sidebar-width: 280px;
            --header-height: 64px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark theme variables */
        [data-theme="dark"] {
            --background: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
            --dark: #f8fafc;
        }

        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition);
        }

        /* ===== LAYOUT STRUCTURE ===== */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--surface);
            border-right: 1px solid var(--border);
            transform: translateX(-100%);
            transition: var(--transition);
            z-index: 1000;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--primary);
            color: white;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }

        .sidebar-brand i {
            font-size: 2rem;
            color: var(--primary);
            min-width: 2rem;
        }

        .brand-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            line-height: 1.2;
            align-items: center;
        }

        .company-name {
            font-size: 1rem;
            font-weight: 700;
            color: #dc3545;
            background: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .app-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            background: #007bff;
            margin: 0.125rem 0;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
        }

        .app-description {
            font-size: 0.625rem;
            font-weight: 400;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.125rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
            flex: 1;
        }

        .nav-group {
            margin-bottom: 2rem;
        }

        .nav-group-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--text);
            text-decoration: none;
            transition: var(--transition);
            position: relative;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--light);
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: white;
        }

        .nav-item i {
            width: 20px;
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            min-width: 1.5rem;
            text-align: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
        }

        .copyright-info {
            text-align: center;
        }

        .copyright-info p {
            margin: 0.25rem 0;
            font-size: 0.75rem;
            color: var(--text-light);
            line-height: 1.2;
        }

        .copyright-info p:first-child {
            font-weight: 600;
            color: var(--text);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: var(--transition);
        }

        .main-content.sidebar-open {
            margin-left: var(--sidebar-width);
        }

        /* ===== HEADER ===== */
        .header {
            position: sticky;
            top: 0;
            height: var(--header-height);
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background: var(--light);
        }

        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breadcrumb-separator {
            color: var(--text-light);
        }

        .header-center {
            flex: 1;
            max-width: 500px;
            margin: 0 2rem;
        }

        .customer-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
        }

        .customer-info i {
            color: var(--primary);
            font-size: 1rem;
        }

        .customer-name {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--text);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--light);
        }

        .notifications {
            position: relative;
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--text);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .notifications:hover {
            background: var(--light);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-right: 1rem;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
        }

        /* ===== TABS ===== */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            background: var(--light);
            border: 1px solid var(--border);
            border-bottom: none;
            padding: 1rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 8px 8px 0 0;
            margin-right: 2px;
            position: relative;
            opacity: 0.7;
        }

        .tab-btn:hover {
            color: var(--primary);
            background: var(--white);
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-btn.active {
            color: var(--primary);
            background: var(--white);
            border-color: var(--primary);
            opacity: 1;
            font-weight: 600;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.2);
            z-index: 10;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--white);
            z-index: 11;
        }

        .tab-btn.active i {
            color: var(--primary);
            transform: scale(1.1);
        }

        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--light);
            padding: 0 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 8px 8px 0 0;
        }

        .tab-content {
            display: block;
            background: var(--white);
            border-radius: 0 0 8px 8px;
            position: relative;
        }

        .tab-content.hidden {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.hidden {
            display: none;
        }

        /* ===== EXPORT STYLES ===== */
        .export-section h4 {
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .export-section p {
            margin-bottom: 2rem;
            color: var(--text-light);
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .export-group h5 {
            margin-bottom: 1rem;
            color: var(--text);
            font-size: 1rem;
        }

        .export-group .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .export-info {
            background: var(--light);
            padding: 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .info-item {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text);
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        /* ===== CONTAGEM PAGE STYLES ===== */
        .page-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filters-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .search-group {
            position: relative;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .search-input-wrapper .form-input {
            padding-left: 2.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        /* ===== DATA TABLE ===== */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg);
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--light);
            font-weight: 600;
            color: var(--text);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table td {
            color: var(--text);
            font-size: 0.875rem;
        }

        .data-table tbody tr:hover {
            background: var(--light);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-badge.active {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.completed {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.paused {
            background: #fef3c7;
            color: #92400e;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container {
            width: 100px;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.75rem;
        }

        .action-btn.edit {
            background: #dbeafe;
            color: #1e40af;
        }

        .action-btn.edit:hover {
            background: #bfdbfe;
        }

        .action-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .action-btn.delete:hover {
            background: #fecaca;
        }

        .action-btn.status {
            background: #fef3c7;
            color: #92400e;
        }

        .action-btn.status:hover {
            background: #fde68a;
        }

        /* ===== LOADING AND EMPTY STATES ===== */
        .loading-state,
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
        }

        .loading-state i,
        .empty-state i {
            font-size: 3rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .loading-state span,
        .empty-state h3 {
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-light);
            margin: 0;
        }

        .loading-state.hidden,
        .empty-state.hidden {
            display: none;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .filters-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .page-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .data-table {
                font-size: 0.75rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
            }
        }

        /* ===== CONTENT AREA ===== */
        .content {
            padding: 2rem;
            min-height: calc(100vh - var(--header-height));
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-light);
            font-size: 1rem;
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-footer {
            padding: 1rem 1.5rem;
            background: var(--light);
            border-top: 1px solid var(--border);
        }

        /* ===== GRID SYSTEM ===== */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: var(--transition);
            background: var(--surface);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: var(--surface);
            cursor: pointer;
        }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-icon.primary {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .stat-icon.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-icon.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .stat-icon.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .stat-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* ===== PROGRESS BAR ===== */
        .progress {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .alert-info {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        /* ===== OVERLAY ===== */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }

        /* ===== RESPONSIVE ===== */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .sidebar-toggle {
                display: none;
            }

            .header-center {
                display: block;
            }

            .grid-md-2 { grid-template-columns: repeat(2, 1fr); }
            .grid-md-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-md-4 { grid-template-columns: repeat(4, 1fr); }
        }

        @media (max-width: 767px) {
            .content {
                padding: 1rem;
            }

            .header {
                padding: 0 1rem;
            }

            .header-center {
                display: none;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== SKELETON LOADING ===== */
        .skeleton {
            background: linear-gradient(90deg, var(--light) 25%, rgba(255,255,255,0.5) 50%, var(--light) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            padding: 1rem;
            min-width: 300px;
            transform: translateX(100%);
            transition: var(--transition);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .toast-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .toast-body {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* ===== AUTH STYLES ===== */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1rem;
        }

        .auth-card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo {
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-weight: 500;
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        /* ===== PRODUCT LIST ===== */
        .product-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .product-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .product-item:hover {
            background: var(--light);
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-info {
            flex: 1;
        }

        .product-code {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .product-desc {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .product-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.counted {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .count-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ===== SESSION LIST ===== */
        .session-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .session-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .session-item:hover {
            background: var(--light);
        }

        .session-item:last-child {
            border-bottom: none;
        }

        .session-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .session-name {
            font-weight: 600;
            color: var(--text);
        }

        .session-type {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .session-type.normal {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .session-type.avulsa {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .session-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .session-action-btn {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .empty-state-desc {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* ===== SCAN HISTORY ===== */
        .scan-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .scan-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .scan-item:last-child {
            border-bottom: none;
        }

        .scan-code {
            font-weight: 600;
            color: var(--text);
        }

        .scan-qty {
            background: var(--secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ===== COUNT TYPE INDICATOR ===== */
        .count-type-indicator {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--info);
        }

        .count-type-indicator.arquivo {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-color: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .count-type-indicator.avulsa {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border-color: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        /* ===== SYNC CONTROLS ===== */
        .sync-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .sync-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .sync-btn:hover {
            background: #059669;
        }

        .sync-btn:disabled {
            background: var(--secondary);
            cursor: not-allowed;
        }

        .sync-btn.syncing {
            background: var(--warning);
            color: var(--dark);
        }

        .sync-btn.syncing i {
            animation: spin 1s linear infinite;
        }

        .sync-status {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .sync-status.success {
            color: var(--success);
        }

        .sync-status.error {
            color: var(--danger);
        }

        /* ===== EXPORT FIELDS ===== */
        .export-fields-group {
            margin-top: 1.5rem;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--light);
        }

        .export-fields-group legend {
            font-weight: 600;
            padding: 0 0.5rem;
            color: var(--text);
        }

        .checkbox-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
        }

        /* Sidebar Styles */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            transition: right 0.3s ease-in-out;
            backdrop-filter: blur(4px);
        }

        .sidebar-overlay.active {
            right: 0;
        }

        .sidebar-content {
            position: absolute;
            right: 0;
            top: 0;
            width: 480px;
            max-width: 90vw;
            height: 100vh;
            background: var(--card-bg);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-overlay.active .sidebar-content {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            color: white;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sidebar-header h3 i {
            margin-right: 0.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-body {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            background: var(--bg-secondary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-control:required:invalid {
            border-color: var(--error-color);
        }

        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .file-upload-content i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .file-upload-content p {
            margin: 0.5rem 0;
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-upload-content small {
            color: var(--text-light);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--success-bg);
            border: 1px solid var(--success-color);
            border-radius: 6px;
            margin-top: 1rem;
        }

        .file-info i {
            color: var(--success-color);
        }

        .import-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--success-bg);
            border: 1px solid var(--success-color);
            border-radius: 6px;
            margin-top: 1rem;
            color: var(--success-color);
        }

        .form-info {
            background: #e0f2fe;
            border: 1px solid #0288d1;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            color: #01579b;
        }

        .form-info i {
            color: #0288d1;
            margin-right: 0.5rem;
        }

        .form-info code {
            background: #ffffff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            border: 1px solid #b3e5fc;
        }

        .form-info small {
            color: #0277bd;
            font-style: italic;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar-content {
                width: 100vw;
                max-width: 100vw;
            }
            
            .sidebar-header,
            .sidebar-body,
            .sidebar-footer {
                padding: 1rem;
            }
            
            .sidebar-footer {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* ===== CONFIGURATION FORMS STYLES ===== */
        .config-form {
            max-width: 100%;
            margin: 0;
        }

        .config-form .form-group {
            margin-bottom: 2rem;
        }

        .config-form .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .config-form .form-label i {
            color: var(--primary);
            font-size: 1.1rem;
        }

        .layout-config {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 0.5rem;
        }

        .field-group {
            margin-bottom: 1.5rem;
        }

        .field-group:last-child {
            margin-bottom: 0;
        }

        .field-group h4 {
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary);
            display: inline-block;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: var(--transition);
            position: relative;
        }

        .checkbox-item:hover:not(.disabled) {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .checkbox-item.disabled {
            background: var(--light);
            opacity: 0.8;
            cursor: not-allowed;
        }

        .checkbox-item input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .checkbox-item.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }

        .checkbox-item label {
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            flex: 1;
        }

        .checkbox-item.disabled label {
            cursor: not-allowed;
            color: var(--text-light);
        }

        .required-badge {
            background: var(--success);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .form-actions .btn {
            flex: 1;
            max-width: 200px;
        }

        .message-area {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--radius);
            display: none;
        }

        .message-area.success {
            background: var(--success-bg);
            border: 1px solid var(--success);
            color: var(--success);
            display: block;
        }

        .message-area.error {
            background: #fef2f2;
            border: 1px solid var(--danger);
            color: var(--danger);
            display: block;
        }

        .message-area.info {
            background: #f0f9ff;
            border: 1px solid var(--info);
            color: var(--info);
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                max-width: none;
            }
        }

        /* Messages Styles */
        .message-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-time {
            font-size: 0.75rem;
            color: #6c757d;
            min-width: 3rem;
            margin-right: 0.75rem;
        }

        .message-content {
            flex: 1;
        }

        .message-user {
            font-weight: 600;
            font-size: 0.875rem;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .message-text {
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* Chart Styles */
        .chart-container {
            position: relative;
            height: 200px;
            margin-bottom: 1rem;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Auth Section -->
        <div id="auth-section" class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h1 class="auth-title">ServeAuto SmartCount</h1>
                    <p class="auth-subtitle">Sistema Inteligente de Contagem de Estoque</p>
                </div>

                <div class="auth-tabs">
                    <div class="auth-tab active" id="login-tab">Login</div>
                    <div class="auth-tab" id="register-tab">Cadastro</div>
                </div>

                <div id="login-form">
                    <div class="form-group">
                        <label class="form-label" for="email">E-mail</label>
                        <input type="email" id="email" class="form-input" placeholder="Seu e-mail" />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">Senha</label>
                        <input type="password" id="password" class="form-input" placeholder="Sua senha" />
                    </div>
                    <button id="login-btn" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </div>

                <div id="register-form" class="hidden">
                    <div class="form-group">
                        <label class="form-label" for="reg-name">Nome Completo</label>
                        <input type="text" id="reg-name" class="form-input" placeholder="Seu nome completo" />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg-email">E-mail</label>
                        <input type="email" id="reg-email" class="form-input" placeholder="Seu e-mail" />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg-password">Senha</label>
                        <input type="password" id="reg-password" class="form-input" placeholder="Sua senha (mín. 6 caracteres)" />
                    </div>
                    <button id="register-btn" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-user-plus"></i> Cadastrar
                    </button>
                </div>

                <div id="auth-message" class="alert hidden"></div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="app-layout hidden">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-brand">
                        <i class="fas fa-boxes"></i>
                        <div class="brand-info">
                            <div class="company-name">ServeAuto</div>
                            <div class="app-name">SmartCount</div>
                            <div class="app-description">Contagem Inteligente de Estoque</div>
                        </div>
                    </div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-group">
                        <div class="nav-group-title">Dashboard</div>
                        <a href="#" class="nav-item active" data-page="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Visão Geral</span>
                        </a>
                    </div>
                    <div class="nav-group">
                        <div class="nav-group-title">Operações</div>
                        <a href="#" class="nav-item" data-page="configuracao">
                            <i class="fas fa-cog"></i>
                            <span>Configuração</span>
                        </a>
                        <a href="#" class="nav-item" data-page="contagem">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Contagem</span>
                            <span class="nav-badge" id="counting-badge" style="display: none;">1</span>
                        </a>

                        <a href="#" class="nav-item" data-page="produtos">
                            <i class="fas fa-boxes"></i>
                            <span>Produtos</span>
                            <span class="nav-badge" id="products-badge" style="display: none;">0</span>
                        </a>
                    </div>
                    <div class="nav-group">
                        <div class="nav-group-title">Relatórios</div>

                        <a href="#" class="nav-item" data-page="historico">
                            <i class="fas fa-history"></i>
                            <span>Histórico</span>
                        </a>
                    </div>
                    <div class="nav-group">
                        <div class="nav-group-title">Sistema</div>
                        <a href="#" class="nav-item" id="logout-nav">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sair</span>
                        </a>
                    </div>
                </nav>
                <div class="sidebar-footer">
                    <div class="copyright-info">
                        <p>ServeAuto SmartCount 1.0 © 2025</p>
                        <p>Contagem Inteligente de Estoque</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content" id="main-content">
                <!-- Header -->
                <header class="header">
                    <div class="header-left">
                        <button class="sidebar-toggle" id="sidebar-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="breadcrumbs" id="breadcrumbs">
                            <div class="breadcrumb-item">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard</span>
                            </div>
                        </div>
                    </div>
                    <div class="header-center">
                        <div class="customer-info">
                            <i class="fas fa-building"></i>
                            <span class="customer-name" id="customer-name">Cliente</span>
                        </div>
                    </div>
                    <div class="header-right">
                        <div class="user-info">
                            <span class="user-name" id="user-name">Usuário</span>
                        </div>
                        <button class="theme-toggle" id="theme-toggle" title="Alternar tema">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button class="notifications" id="notifications" title="Notificações">
                            <i class="fas fa-bell"></i>
                            <div class="notification-badge" id="notification-badge" style="display: none;"></div>
                        </button>
                        <div class="user-menu">
                            <div class="user-avatar" id="user-avatar" title="Menu do usuário">
                                <span id="user-initials">U</span>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Content Area -->
                <div class="content">
                    <!-- Dashboard Page -->
                    <div id="dashboard-page" class="page active">
                        <div class="page-header">
                            <h1 class="page-title">Dashboard</h1>
                            <p class="page-subtitle">Visão geral do sistema de contagem</p>
                        </div>

                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Total de Produtos</div>
                                    <div class="stat-icon primary">
                                        <i class="fas fa-boxes"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="dashboard-total-items">0</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Produtos importados</span>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Produtos Contados</div>
                                    <div class="stat-icon success">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="dashboard-counted-items">0</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Contagem realizada</span>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Itens Bipados</div>
                                    <div class="stat-icon warning">
                                        <i class="fas fa-barcode"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="dashboard-scanned-items">0</div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Bipagens realizadas</span>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Progresso</div>
                                    <div class="stat-icon primary">
                                        <i class="fas fa-chart-pie"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="dashboard-progress">0%</div>
                                <div class="progress">
                                    <div class="progress-bar" id="dashboard-progress-bar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="grid grid-cols-1 grid-md-2">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-comments"></i>
                                        Últimas Mensagens
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div id="latest-messages">
                                        <div class="message-item">
                                            <div class="message-time">14:30</div>
                                            <div class="message-content">
                                                <div class="message-user">Sistema</div>
                                                <div class="message-text">Sessão de contagem iniciada</div>
                                            </div>
                                        </div>
                                        <div class="message-item">
                                            <div class="message-time">14:25</div>
                                            <div class="message-content">
                                                <div class="message-user">João Silva</div>
                                                <div class="message-text">Produto ABC123 contado</div>
                                            </div>
                                        </div>
                                        <div class="message-item">
                                            <div class="message-time">14:20</div>
                                            <div class="message-content">
                                                <div class="message-user">Maria Santos</div>
                                                <div class="message-text">Arquivo CSV importado com sucesso</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-chart-bar"></i>
                                        Descrição da mensagem
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div id="sessions-users-chart">
                                        <div class="chart-container">
                                            <canvas id="sessionsUsersCanvas" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other pages will be added here -->
                    <div id="configuracao-page" class="page hidden">
                        <div class="page-header">
                            <h1 class="page-title">Configuração</h1>
                            <p class="page-subtitle">Configure sua sessão de contagem e exportações</p>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="tab-nav">
                                    <button class="tab-btn active" data-tab="contagens">
                                        <i class="fas fa-cog"></i> Configurar Contagens
                                    </button>
                                    <button class="tab-btn" data-tab="exportacoes">
                                        <i class="fas fa-file-export"></i> Configurar Exportações
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Tab: Configurar Contagens -->
                                <div id="contagens-tab" class="tab-content active">
                                    <form id="form-configurar-contagens" class="config-form">
                                        <!-- Tipo de Contagem Padrão -->
                                        <div class="form-group">
                                            <label for="tipo-contagem-padrao" class="form-label">
                                                <i class="fas fa-list-alt"></i> Tipo de Contagem Padrão
                                            </label>
                                            <select id="tipo-contagem-padrao" name="tipo_contagem_padrao" class="form-select" required>
                                                <option value="normal">Normal</option>
                                                <option value="avulsa">Avulsa</option>
                                            </select>
                                        </div>

                                        <!-- Layout do Arquivo de Importação -->
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-file-import"></i> Layout do Arquivo de Importação
                                            </label>
                                            <div class="layout-config">
                                                <div class="field-group">
                                                    <h4>Campos Obrigatórios</h4>
                                                    <div class="checkbox-group">
                                                        <div class="checkbox-item disabled">
                                                            <input type="checkbox" id="importacao-codigo" name="importacao_incluir_codigo" checked disabled>
                                                            <label for="importacao-codigo">Código</label>
                                                            <span class="required-badge">Obrigatório</span>
                                                        </div>
                                                        <div class="checkbox-item disabled">
                                                            <input type="checkbox" id="importacao-quantidade" name="importacao_incluir_quantidade" checked disabled>
                                                            <label for="importacao-quantidade">Quantidade</label>
                                                            <span class="required-badge">Obrigatório</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="field-group">
                                                    <h4>Campos Opcionais</h4>
                                                    <div class="checkbox-group">
                                                        <div class="checkbox-item">
                                                            <input type="checkbox" id="importacao-descricao" name="importacao_incluir_descricao">
                                                            <label for="importacao-descricao">Descrição</label>
                                                        </div>
                                                        <div class="checkbox-item">
                                                            <input type="checkbox" id="importacao-localizacao" name="importacao_incluir_localizacao">
                                                            <label for="importacao-localizacao">Localização</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-info">
                                                <i class="fas fa-info-circle"></i>
                                                <strong>Formato esperado do CSV:</strong>
                                                <code>codigo,descricao,quantidade,localizacao</code>
                                                <br><small>Exemplo: PROD001,Produto Teste,10,A1-B2</small>
                                            </div>
                                        </div>

                                        <!-- Tipo de Arquivo de Importação Padrão -->
                                        <div class="form-group">
                                            <label for="tipo-importacao-padrao" class="form-label">
                                                <i class="fas fa-file-alt"></i> Tipo de Arquivo de Importação Padrão
                                            </label>
                                            <select id="tipo-importacao-padrao" name="tipo_importacao_padrao" class="form-select" required>
                                                <option value="csv">CSV</option>
                                                <option value="txt">TXT</option>
                                            </select>
                                        </div>

                                        <!-- Botões de Ação -->
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> Salvar Configurações
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="resetFormContagens()">
                                                <i class="fas fa-undo"></i> Restaurar Padrões
                                            </button>
                                        </div>

                                        <!-- Área de Mensagens -->
                                        <div id="message-contagens" class="message-area"></div>
                                    </form>
                                </div>
                                
                                <!-- Tab: Configurar Exportações -->
                                <div id="exportacoes-tab" class="tab-content hidden">
                                    <form id="form-configurar-exportacoes" class="config-form">
                                        <!-- Tipo de Exportação -->
                                        <div class="form-group">
                                            <label for="tipo-exportacao" class="form-label">
                                                <i class="fas fa-chart-bar"></i> Tipo de Exportação
                                            </label>
                                            <select id="tipo-exportacao" name="tipo_exportacao" class="form-select" required>
                                                <option value="agrupada">Agrupada</option>
                                                <option value="detalhada">Detalhada</option>
                                            </select>
                                        </div>

                                        <!-- Layout do Arquivo de Exportação -->
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-file-export"></i> Layout do Arquivo de Exportação
                                            </label>
                                            <div class="layout-config">
                                                <div class="field-group">
                                                    <h4>Campos Obrigatórios</h4>
                                                    <div class="checkbox-group">
                                                        <div class="checkbox-item disabled">
                                                            <input type="checkbox" id="exportacao-codigo" name="exportacao_incluir_codigo" checked disabled>
                                                            <label for="exportacao-codigo">Código</label>
                                                            <span class="required-badge">Obrigatório</span>
                                                        </div>
                                                        <div class="checkbox-item disabled">
                                                            <input type="checkbox" id="exportacao-quantidade" name="exportacao_incluir_quantidade" checked disabled>
                                                            <label for="exportacao-quantidade">Quantidade</label>
                                                            <span class="required-badge">Obrigatório</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="field-group">
                                                    <h4>Campos Opcionais</h4>
                                                    <div class="checkbox-group">
                                                        <div class="checkbox-item">
                                                            <input type="checkbox" id="exportacao-descricao" name="exportacao_incluir_descricao">
                                                            <label for="exportacao-descricao">Descrição</label>
                                                        </div>
                                                        <div class="checkbox-item">
                                                            <input type="checkbox" id="exportacao-localizacao" name="exportacao_incluir_localizacao">
                                                            <label for="exportacao-localizacao">Localização</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tipo de Arquivo de Exportação Padrão -->
                                        <div class="form-group">
                                            <label for="tipo-exportacao-padrao" class="form-label">
                                                <i class="fas fa-file-alt"></i> Tipo de Arquivo de Exportação Padrão
                                            </label>
                                            <select id="tipo-exportacao-padrao" name="tipo_exportacao_padrao" class="form-select" required>
                                                <option value="csv">CSV</option>
                                                <option value="txt">TXT</option>
                                            </select>
                                        </div>

                                        <!-- Botões de Ação -->
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> Salvar Configurações
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="resetFormExportacoes()">
                                                <i class="fas fa-undo"></i> Restaurar Padrões
                                            </button>
                                        </div>

                                        <!-- Área de Mensagens -->
                                        <div id="message-exportacoes" class="message-area"></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contagem Page -->
                    <div id="contagem-page" class="page hidden" data-page="contagem">
                        <div class="page-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: baseline; gap: 1rem;">
                                <h1 class="page-title" style="margin: 0;">Gerenciar Contagens</h1>
                                <p class="page-subtitle" style="margin: 0; font-size: 0.9rem; color: var(--text-light);">Gerencie suas sessões de contagem</p>
                            </div>
                            <div class="page-actions">
                                <button id="new-session-btn" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Nova Contagem
                                </button>
                            </div>
                        </div>

                        <!-- Filters and Search -->
                        <div class="card">
                            <div class="card-body">
                                <div class="filters-row">
                                    <div class="search-group">
                                        <div class="search-input-wrapper">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="session-search" class="form-input" placeholder="Pesquisar por nome da sessão...">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <select id="status-filter" class="form-select">
                                            <option value="">Todos os Status</option>
                                            <option value="active">Ativas</option>
                                            <option value="completed">Concluídas</option>
                                            <option value="waiting">Aguardando</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <select id="user-filter" class="form-select">
                                            <option value="">Todos os Usuários</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <button id="clear-filters-btn" class="btn btn-outline">
                                            <i class="fas fa-times"></i> Limpar Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sessions Grid -->
                        <div class="card">
                            <div class="card-header" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem;">
                                <h3 style="margin: 0;">Sessões de Contagem</h3>
                                <div class="card-actions">
                                    <button id="refresh-sessions-btn" class="btn btn-outline">
                                        <i class="fas fa-sync-alt"></i> Atualizar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table id="sessions-table" class="data-table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nome da Sessão</th>
                                                <th>Usuário</th>
                                                <th>Tipo</th>
                                                <th>Status</th>
                                                <th>Total Itens</th>
                                                <th>Contados</th>
                                                <th>Progresso</th>
                                                <th>Criado em</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sessions-tbody">
                                            <!-- Sessions will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="sessions-loading" class="loading-state hidden">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Carregando sessões...</span>
                                </div>
                                <div id="sessions-empty" class="empty-state hidden">
                                    <i class="fas fa-clipboard-list"></i>
                                    <h3>Nenhuma sessão encontrada</h3>
                                    <p>Crie uma nova sessão de contagem para começar</p>
                                </div>
                                
                                <!-- Pagination -->
                                <div class="pagination-container">
                                    <div class="pagination-info">
                                        <span id="sessions-pagination-info">Mostrando 0 a 0 de 0 sessões</span>
                                    </div>
                                    <div class="pagination-controls">
                                        <button id="sessions-prev-btn" class="btn btn-outline" onclick="goToSessionsPreviousPage()" disabled>
                                             <i class="fas fa-chevron-left"></i> Anterior
                                         </button>
                                         <span id="sessions-page-info" class="page-info">Página 1 de 1</span>
                                         <button id="sessions-next-btn" class="btn btn-outline" onclick="goToSessionsNextPage()" disabled>
                                             Próxima <i class="fas fa-chevron-right"></i>
                                         </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Produtos Page -->
                    <div id="produtos-page" class="page hidden" data-page="produtos">
                        <div class="page-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: baseline; gap: 1rem;">
                                <h1 class="page-title" style="margin: 0;">Consultar Produtos</h1>
                                <p class="page-subtitle" style="margin: 0; font-size: 0.9rem; color: var(--text-light);">Visualize e gerencie os produtos cadastrados</p>
                            </div>
                            <div class="page-actions">
                                <button id="refresh-products-btn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt"></i> Atualizar
                                </button>
                            </div>
                        </div>

                        <!-- Filters and Search -->
                        <div class="card">
                            <div class="card-body">
                                <div class="filters-row">
                                    <div class="search-group">
                                        <div class="search-input-wrapper">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="product-search" class="form-input" placeholder="Pesquisar por código ou descrição...">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <select id="session-filter" class="form-select">
                                            <option value="">Todas as Sessões</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <select id="counted-filter" class="form-select">
                                            <option value="">Todos os Status</option>
                                            <option value="true">Contados</option>
                                            <option value="false">Não Contados</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <button id="clear-products-filters-btn" class="btn btn-outline">
                                            <i class="fas fa-times"></i> Limpar Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Products Grid -->
                        <div class="card">
                            <div class="card-header" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem;">
                                <h3 style="margin: 0;">Lista de Produtos</h3>
                                <div class="card-actions">
                                    <button id="export-products-btn" class="btn btn-outline">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table id="products-table" class="data-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="codigo">Código <i class="fas fa-sort"></i></th>
                                                <th data-sort="descricao">Descrição <i class="fas fa-sort"></i></th>
                                                <th data-sort="localizacao">Localização <i class="fas fa-sort"></i></th>
                                                <th data-sort="quantidade_atual">Qtd. Atual <i class="fas fa-sort"></i></th>
                                                <th data-sort="quantidade_contada">Qtd. Contada <i class="fas fa-sort"></i></th>
                                                <th data-sort="scanned_qty">Qtd. Bipada <i class="fas fa-sort"></i></th>
                                                <th data-sort="is_counted">Status <i class="fas fa-sort"></i></th>
                                                <th data-sort="created_at">Data Criação <i class="fas fa-sort"></i></th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="products-table-body">
                                            <!-- Products will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div class="pagination-container">
                                    <div class="pagination-info">
                                        <span id="products-pagination-info">Mostrando 0 de 0 produtos</span>
                                    </div>
                                    <div class="pagination-controls">
                                        <button id="products-prev-btn" class="btn btn-outline" disabled>
                                            <i class="fas fa-chevron-left"></i> Anterior
                                        </button>
                                        <span id="products-page-info">Página 1 de 1</span>
                                        <button id="products-next-btn" class="btn btn-outline" disabled>
                                            Próxima <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Empty State -->
                                <div id="products-empty-state" class="empty-state hidden">
                                    <i class="fas fa-boxes empty-state-icon"></i>
                                    <h3>Nenhum produto encontrado</h3>
                                    <p>Importe produtos ou ajuste os filtros de busca</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add other pages here... -->
                </div>
            </main>
        </div>

        <!-- Overlay -->
        <div class="overlay" id="overlay"></div>

        <!-- Toast Container -->
        <div class="toast-container" id="toast-container"></div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://dkpqjtbrmxozynpxdurv.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrcHFqdGJybXhvenlucHhkdXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjIyNDUsImV4cCI6MjA3MjIzODI0NX0.EVXv7iH70zDNb_vrILJMVb2ccBWFWA0sAU4CoPSRh54';
        
        const supabase = (window.supabase && window.supabase.createClient)
            ? window.supabase.createClient(supabaseUrl, supabaseAnonKey)
            : null;

        // App state
        let currentUser = null;
        let currentSession = null;
        let products = [];
        let scans = [];
        let userProfile = null;
        let syncInterval = null;

        // DOM elements
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.getElementById('main-content');
        const themeToggle = document.getElementById('theme-toggle');

        // Initialize app
        document.addEventListener('DOMContentLoaded', initApp);

        async function initApp() {
            setupEventListeners();
            
            if (!supabase) {
                showAuthSection();
                showToast('Falha ao carregar o SDK do Supabase', 'error');
                return;
            }

            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    const user = session.user;
                    const { data: profile } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();

                    if (profile && profile.authorized) {
                        currentUser = user;
                        userProfile = profile;
                        showMainApp();
                        updateUserInfo();
                        await loadUserData();
                        startAutoSync();
                        setupVisibilitySync();
                    } else {
                        await supabase.auth.signOut();
                        showAuthSection();
                    }
                } else {
                    showAuthSection();
                }
            } catch (err) {
                console.error(err);
                showAuthSection();
                showToast('Não foi possível inicializar a sessão', 'error');
            }
        }

        // Função uploadSessionFile no escopo global
        // Função para alterar status da sessão
                 async function changeSessionStatus(sessionId, currentStatus) {
                     try {
                         // Buscar informações da sessão
                         const session = allCountingSessions.find(s => s.id === sessionId);
                         if (!session) {
                             showToast('Sessão não encontrada', 'error');
                             return;
                         }

                         let newStatus;
                         let statusText;

                         // Definir transições de status permitidas
                         if (currentStatus === 'waiting') {
                             // De "Aguardando" para "Em andamento"
                             newStatus = 'active';
                             statusText = 'Em andamento';

                             // Validação para tipo normal: deve ter produtos importados
                             if (session.count_type === 'normal' && (!session.total_items || session.total_items === 0)) {
                                 showToast('Para iniciar uma contagem normal, é necessário importar produtos primeiro', 'warning');
                                 return;
                             }
                         } else if (currentStatus === 'active') {
                             // De "Em andamento" para "Finalizado"
                             newStatus = 'completed';
                             statusText = 'Finalizado';
                         } else {
                             showToast('Transição de status não permitida', 'warning');
                             return;
                         }

                         if (!confirm(`Alterar status para "${statusText}"?`)) return;

                         const { error } = await supabase
                             .from('counting_sessions')
                             .update({ status: newStatus })
                             .eq('id', sessionId);

                         if (error) throw error;

                         showToast(`Status alterado para "${statusText}"!`, 'success');
                         loadCountingSessions();

                     } catch (error) {
                         console.error('Erro ao alterar status:', error);
                         showToast('Erro ao alterar status da sessão', 'error');
                     }
                 }

                 async function uploadSessionFile(sessionId) {
            try {
                // Buscar informações da sessão
                const session = allCountingSessions.find(s => s.id === sessionId);
                if (!session) {
                    showToast('Sessão não encontrada', 'error');
                    return;
                }
                
                // Verificar se a sessão é do tipo "normal"
                if (session.count_type !== 'normal') {
                    showToast('Upload de arquivo só é permitido para sessões do tipo "normal"', 'warning');
                    return;
                }
                
                // Criar input de arquivo temporário
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.csv';
                fileInput.style.display = 'none';
                
                // Adicionar ao DOM temporariamente
                document.body.appendChild(fileInput);
                
                // Criar promise para aguardar seleção do arquivo
                const fileSelected = new Promise((resolve) => {
                    fileInput.addEventListener('change', (event) => {
                        const file = event.target.files[0];
                        resolve(file);
                    });
                });
                
                // Abrir dialog de seleção
                fileInput.click();
                
                // Aguardar seleção do arquivo
                const selectedFile = await fileSelected;
                
                // Remover input temporário
                document.body.removeChild(fileInput);
                
                if (!selectedFile) {
                    return; // Usuário cancelou
                }
                
                // Processar arquivo CSV
                const text = await selectedFile.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length === 0) {
                    showToast('Arquivo vazio ou inválido', 'error');
                    return;
                }

                // Formato CSV: codigo,descricao,quantidade,localizacao
                const products = [];
                for (let i = 1; i < lines.length; i++) { // Pular cabeçalho
                    const [codigo, descricao, quantidade, localizacao] = lines[i].split(',').map(s => s.trim());
                    if (codigo && descricao) {
                        products.push({
                            codigo,
                            descricao,
                            quantidade: quantidade ? parseInt(quantidade) || 0 : 0,
                            localizacao: localizacao || ''
                        });
                    }
                }

                if (products.length === 0) {
                    showToast('Nenhum produto válido encontrado no arquivo', 'error');
                    return;
                }

                // Preparar dados dos produtos para inserção
                const productsToInsert = products.map(p => ({
                    session_id: sessionId,
                    codigo: p.codigo,
                    descricao: p.descricao,
                    localizacao: p.localizacao || null,
                    quantidade_atual: p.quantidade,
                    quantidade_contada: 0,
                    is_counted: false,
                    expected_qty: p.quantidade
                }));

                // Inserir produtos no Supabase
                const { data, error } = await supabase
                    .from('products')
                    .insert(productsToInsert)
                    .select();

                if (error) {
                    console.error('Erro ao inserir produtos:', error);
                    showToast('Erro ao importar produtos: ' + error.message, 'error');
                    return;
                }

                // Atualizar total de itens na sessão
                const { error: updateError } = await supabase
                    .from('counting_sessions')
                    .update({ 
                        total_items: (session.total_items || 0) + products.length
                    })
                    .eq('id', sessionId);

                if (updateError) {
                    console.error('Erro ao atualizar sessão:', updateError);
                }

                showToast(`${products.length} produtos importados com sucesso para a sessão!`, 'success');
                
                // Recarregar dados das sessões
                if (typeof loadCountingSessions === 'function') {
                    loadCountingSessions();
                }
                
            } catch (error) {
                console.error('Erro ao fazer upload do arquivo:', error);
                showToast('Erro ao processar arquivo: ' + error.message, 'error');
            }
        }

        function setupEventListeners() {
            // Sidebar toggle
            sidebarToggle?.addEventListener('click', toggleSidebar);
            overlay?.addEventListener('click', closeSidebar);

            // Theme toggle
            themeToggle?.addEventListener('click', toggleTheme);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;
                    if (page) {
                        navigateToPage(page);
                    } else if (item.id === 'logout-nav') {
                        handleLogout();
                    }
                });
            });

            // Auth tabs
            document.getElementById('login-tab')?.addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('register-tab')?.addEventListener('click', () => switchAuthTab('register'));

            // Auth forms
            document.getElementById('login-btn')?.addEventListener('click', handleLogin);
            document.getElementById('register-btn')?.addEventListener('click', handleRegister);

            // Enter key for auth
            document.getElementById('password')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('login-btn')?.click();
            });
            document.getElementById('reg-password')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('register-btn')?.click();
            });

            // Quick actions
            document.getElementById('quick-start-counting')?.addEventListener('click', () => navigateToPage('contagem'));
            document.getElementById('quick-import-csv')?.addEventListener('click', () => navigateToPage('configuracao'));
            document.getElementById('quick-scan-product')?.addEventListener('click', () => navigateToPage('bipagem'));

            // Configuration tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = btn.dataset.tab;
                    switchConfigTab(tabName);
                });
            });

            // Configuration
            document.getElementById('count-type')?.addEventListener('change', toggleCountType);
            
            // Sidebar count type event listener
            document.getElementById('sidebar-count-type')?.addEventListener('change', toggleSidebarCountType);
            
            // Initialize file import group visibility - hide by default since sidebar-count-type starts empty
            const fileImportGroup = document.getElementById('file-import-group');
            if (fileImportGroup) {
                fileImportGroup.style.display = 'none';
            }
            document.getElementById('import-btn')?.addEventListener('click', handleImport);
            document.getElementById('csv-file')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const fileName = file.name.replace(/\.csv$/i, '');
                    document.getElementById('session-name').value = fileName;
                }
            });

            // Export buttons
            document.getElementById('export-csv-grouped')?.addEventListener('click', () => exportData('csv', 'grouped'));
            document.getElementById('export-csv-detailed')?.addEventListener('click', () => exportData('csv', 'detailed'));
            document.getElementById('export-excel-grouped')?.addEventListener('click', () => exportData('excel', 'grouped'));
            document.getElementById('export-excel-detailed')?.addEventListener('click', () => exportData('excel', 'detailed'));
            document.getElementById('export-pdf')?.addEventListener('click', () => exportData('pdf'));
            document.getElementById('export-session')?.addEventListener('click', () => {
                const sessionSelect = document.getElementById('session-select');
                if (sessionSelect && sessionSelect.value) {
                    exportSessionData(sessionSelect.value);
                }
            });
        }

        function toggleSidebar() {
            sidebar?.classList.toggle('open');
            overlay?.classList.toggle('active');
            mainContent?.classList.toggle('sidebar-open');
        }

        function closeSidebar() {
             sidebar?.classList.remove('open');
             overlay?.classList.remove('active');
             mainContent?.classList.remove('sidebar-open');
         }

         function toggleTheme() {
             const currentTheme = document.documentElement.getAttribute('data-theme');
             const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
             document.documentElement.setAttribute('data-theme', newTheme);
             localStorage.setItem('theme', newTheme);
             
             const icon = themeToggle?.querySelector('i');
             if (icon) {
                 icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
             }
         }

         function navigateToPage(pageName) {
             // Update navigation
             document.querySelectorAll('.nav-item').forEach(item => {
                 item.classList.remove('active');
             });
             document.querySelector(`[data-page="${pageName}"]`)?.classList.add('active');

             // Update pages
             document.querySelectorAll('.page').forEach(page => {
                 page.classList.remove('active');
                 page.classList.add('hidden');
             });
             const targetPage = document.getElementById(`${pageName}-page`);
             if (targetPage) {
                 targetPage.classList.remove('hidden');
                 targetPage.classList.add('active');
             }

             // Update breadcrumbs
             updateBreadcrumbs(pageName);

             // Activate first tab for configuration page
             if (pageName === 'configuracao') {
                 switchConfigTab('contagens');
             }

             // Close sidebar on mobile
             if (window.innerWidth < 768) {
                 closeSidebar();
             }
         }

         function updateBreadcrumbs(pageName) {
             const breadcrumbs = document.getElementById('breadcrumbs');
             if (!breadcrumbs) return;

             const pageMap = {
                 'dashboard': { icon: 'fas fa-tachometer-alt', title: 'Dashboard' },
                 'configuracao': { icon: 'fas fa-cog', title: 'Configuração' },
                 'contagem': { icon: 'fas fa-clipboard-list', title: 'Contagem' },
                 'bipagem': { icon: 'fas fa-barcode', title: 'Bipagem' },
                 'produtos': { icon: 'fas fa-boxes', title: 'Produtos' },
                 'exportar': { icon: 'fas fa-file-export', title: 'Exportar' },
                 'historico': { icon: 'fas fa-history', title: 'Histórico' }
             };

             const page = pageMap[pageName] || { icon: 'fas fa-home', title: 'Página' };
             breadcrumbs.innerHTML = `
                 <div class="breadcrumb-item">
                     <i class="${page.icon}"></i>
                     <span>${page.title}</span>
                 </div>
             `;
         }

         function switchAuthTab(tab) {
             const loginTab = document.getElementById('login-tab');
             const registerTab = document.getElementById('register-tab');
             const loginForm = document.getElementById('login-form');
             const registerForm = document.getElementById('register-form');
             const authMessage = document.getElementById('auth-message');

             if (tab === 'login') {
                 loginTab?.classList.add('active');
                 registerTab?.classList.remove('active');
                 loginForm?.classList.remove('hidden');
                 registerForm?.classList.add('hidden');
             } else {
                 registerTab?.classList.add('active');
                 loginTab?.classList.remove('active');
                 registerForm?.classList.remove('hidden');
                 loginForm?.classList.add('hidden');
             }
             authMessage?.classList.add('hidden');
         }

         function switchConfigTab(tabName) {
             // Update tab buttons
             document.querySelectorAll('.tab-btn').forEach(btn => {
                 btn.classList.remove('active');
             });
             document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');

             // Update tab content with animation
             document.querySelectorAll('.tab-content').forEach(content => {
                 content.classList.remove('active');
                 content.classList.add('hidden');
             });
             
             const targetTab = document.getElementById(`${tabName}-tab`);
             if (targetTab) {
                 targetTab.classList.remove('hidden');
                 targetTab.classList.add('active');
             }

             // Load existing configurations when switching tabs
             if (tabName === 'contagens') {
                 loadConfiguracaoContagens();
             } else if (tabName === 'exportacoes') {
                 loadConfiguracaoExportacoes();
             }
         }

         function showAuthSection() {
             authSection?.classList.remove('hidden');
             mainApp?.classList.add('hidden');
         }

         function showMainApp() {
             authSection?.classList.add('hidden');
             mainApp?.classList.remove('hidden');
             navigateToPage('dashboard');
         }

         function updateUserInfo() {
            if (currentUser && userProfile) {
                const userInitials = document.getElementById('user-initials');
                const userName = document.getElementById('user-name');
                const customerName = document.getElementById('customer-name');
                
                if (userInitials) {
                    const initials = (userProfile.name || userProfile.Costumer || 'Usuario')
                        .split(' ')
                        .map(n => n[0])
                        .join('')
                        .toUpperCase()
                        .substring(0, 2);
                    userInitials.textContent = initials;
                }
                
                if (userName) {
                    userName.textContent = userProfile.name || userProfile.Costumer || 'Usuário';
                }
                
                if (customerName) {
                    customerName.textContent = userProfile.costumer || userProfile.Costumer || 'Cliente';
                }
            }
        }

         async function handleLogin() {
             if (!supabase) return showToast('SDK do Supabase indisponível.', 'error');
             
             const email = document.getElementById('email')?.value.trim();
             const password = document.getElementById('password')?.value;
             
             if (!email || !password) {
                 return showAuthMessage('Por favor, preencha todos os campos.', 'error');
             }

             const loginBtn = document.getElementById('login-btn');
             if (loginBtn) {
                 loginBtn.innerHTML = '<div class="loading"></div> Entrando...';
                 loginBtn.disabled = true;
             }

             try {
                 const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                 if (error) throw error;

                 const { data: profile, error: profileError } = await supabase
                     .from('user_profiles')
                     .select('*')
                     .eq('id', data.user.id)
                     .single();

                 if (profileError || !profile || !profile.authorized) {
                     showAuthMessage('Usuário não autorizado. Entre em contato com o administrador.', 'error');
                     await supabase.auth.signOut();
                     return;
                 }

                 await supabase.from('session_logs').insert([{ user_id: data.user.id, action: 'login' }]);
                 currentUser = data.user;
                 userProfile = profile;
                 showMainApp();
                 updateUserInfo();
                 await loadUserData();
                 startAutoSync();
                 setupVisibilitySync();
             } catch (err) {
                 console.error(err);
                 showAuthMessage(err.message || 'Erro inesperado. Tente novamente.', 'error');
             } finally {
                 if (loginBtn) {
                     loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
                     loginBtn.disabled = false;
                 }
             }
         }

         async function handleRegister() {
             if (!supabase) return showToast('SDK do Supabase indisponível.', 'error');
             
             const name = document.getElementById('reg-name')?.value.trim();
             const email = document.getElementById('reg-email')?.value.trim();
             const password = document.getElementById('reg-password')?.value;
             
             if (!name || !email || !password) {
                 return showAuthMessage('Por favor, preencha todos os campos.', 'error');
             }
             if (password.length < 6) {
                 return showAuthMessage('A senha deve ter pelo menos 6 caracteres.', 'error');
             }

             const registerBtn = document.getElementById('register-btn');
             if (registerBtn) {
                 registerBtn.innerHTML = '<div class="loading"></div> Cadastrando...';
                 registerBtn.disabled = true;
             }

             try {
                 const { data, error } = await supabase.auth.signUp({
                     email,
                     password,
                     options: { data: { name } },
                 });
                 if (error) throw error;

                 const userId = data?.user?.id;
                 if (userId) {
                     const { error: profileError } = await supabase.from('user_profiles').insert([
                         { id: userId, name, authorized: false, import_limit: 10 },
                     ]);
                     if (profileError) throw profileError;
                 }
                 showAuthMessage('Cadastro realizado! Aguarde a autorização de um administrador.', 'success');
             } catch (err) {
                 console.error(err);
                 showAuthMessage(err.message || 'Erro inesperado. Tente novamente.', 'error');
             } finally {
                 if (registerBtn) {
                     registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Cadastrar';
                     registerBtn.disabled = false;
                 }
             }
         }

         async function handleLogout() {
             if (currentUser && supabase) {
                 await supabase.from('session_logs').insert([{ user_id: currentUser.id, action: 'logout' }]);
                 await supabase.auth.signOut();
             }
             stopAutoSync();
             currentUser = null;
             currentSession = null;
             userProfile = null;
             products = [];
             scans = [];
             showAuthSection();
         }

         function showAuthMessage(message, type) {
             const authMessage = document.getElementById('auth-message');
             if (authMessage) {
                 authMessage.textContent = message;
                 authMessage.className = `alert alert-${type}`;
                 authMessage.classList.remove('hidden');
             }
         }

         function showToast(message, type = 'info', duration = 5000) {
             const toastContainer = document.getElementById('toast-container');
             if (!toastContainer) return;

             const toast = document.createElement('div');
             toast.className = 'toast';
             
             const iconMap = {
                 success: 'fas fa-check-circle',
                 error: 'fas fa-exclamation-circle',
                 warning: 'fas fa-exclamation-triangle',
                 info: 'fas fa-info-circle'
             };

             toast.innerHTML = `
                 <div class="toast-header">
                     <div class="toast-title">
                         <i class="${iconMap[type] || iconMap.info}"></i>
                         ${type.charAt(0).toUpperCase() + type.slice(1)}
                     </div>
                     <button class="toast-close">&times;</button>
                 </div>
                 <div class="toast-body">${message}</div>
             `;

             toastContainer.appendChild(toast);

             // Show toast
             setTimeout(() => toast.classList.add('show'), 100);

             // Auto remove
             setTimeout(() => {
                 toast.classList.remove('show');
                 setTimeout(() => toast.remove(), 300);
             }, duration);

             // Manual close
             toast.querySelector('.toast-close')?.addEventListener('click', () => {
                 toast.classList.remove('show');
                 setTimeout(() => toast.remove(), 300);
             });
         }

         function toggleCountType() {
            const countType = document.getElementById('count-type')?.value;
            const fileImportSection = document.getElementById('file-import-section');
            
            // Para a seção principal de importação na janela de configuração
            if (countType === 'avulsa') {
                fileImportSection?.classList.add('hidden');
            } else {
                fileImportSection?.classList.remove('hidden');
            }
        }
        
        function toggleSidebarCountType() {
            const countType = document.getElementById('sidebar-count-type')?.value;
            const fileImportGroup = document.getElementById('file-import-group');
            
            // Para o grupo de arquivo na sidebar - só mostra se tipo for 'normal' (com arquivo)
            if (fileImportGroup) {
                if (countType === 'normal') {
                    fileImportGroup.style.display = 'block';
                } else {
                    // Ocultar para qualquer outro valor (incluindo vazio, 'avulsa', etc.)
                    fileImportGroup.style.display = 'none';
                    // Limpar arquivo selecionado quando ocultar
                    const fileInput = document.getElementById('products-file');
                    const fileInfo = document.getElementById('file-info');
                    const importStatus = document.getElementById('import-status');
                    if (fileInput) fileInput.value = '';
                    if (fileInfo) fileInfo.classList.add('hidden');
                    if (importStatus) importStatus.classList.add('hidden');
                }
            }
        }

         async function handleImport() {
             const fileInput = document.getElementById('csv-file');
             const file = fileInput?.files[0];
             
             if (!file) return showToast('Selecione um arquivo CSV para importar.', 'error');
             if (file.size > 5 * 1024 * 1024) return showToast('O arquivo deve ter no máximo 5MB.', 'error');
             if (file.type !== 'text/csv' && !file.name.toLowerCase().endsWith('.csv')) {
                 return showToast('O arquivo deve ser do tipo CSV.', 'error');
             }

             let importLimit = 10;
             let importConfig = { importacao_incluir_localizacao: true };
             
             if (supabase && currentUser) {
                 const { data: profile } = await supabase
                     .from('user_profiles')
                     .select('import_limit')
                     .eq('id', currentUser.id)
                     .single();
                 importLimit = profile?.import_limit ?? 10;

                 // Buscar configurações de importação
                 const { data: config, error: configError } = await supabase
                     .from('configuracao_estoque')
                     .select('importacao_incluir_localizacao')
                     .limit(1)
                     .single();
                 
                 console.log('Configuração carregada:', config, 'Erro:', configError);
                 
                 if (config) {
                     importConfig = config;
                 }
             }

             console.log('Configuração final:', importConfig);

             const reader = new FileReader();
             reader.onload = (e) => {
                 const content = e.target.result;
                 const lines = content.split(/\r?\n/).filter((line) => line.trim() !== '');
                 
                 console.log('Linhas do CSV:', lines);
                 
                 if (lines.length <= 1) return showToast('Arquivo CSV sem dados.', 'error');
                 if (lines.length - 1 > importLimit) {
                     return showToast(`Seu limite de importação é de ${importLimit} linhas. Arquivo contém ${lines.length - 1} linhas.`, 'error');
                 }

                 products = [];
                 for (let i = 1; i < lines.length; i++) {
                     const cols = lines[i].split(',');
                     const codigo = (cols[0] || '').trim();
                     const descricao = (cols[1] || '').trim();
                     const quantidade_atual = parseInt(cols[2], 10) || 0;
                     const localizacao = (cols[3] || '').trim();
                     
                     console.log(`Linha ${i}:`, { codigo, descricao, quantidade_atual, localizacao });
                     
                     if (codigo && descricao) {
                         const product = { 
                             codigo, 
                             descricao, 
                             quantidade_atual, 
                             quantidade_contada: 0, 
                             is_counted: false,
                             localizacao: localizacao
                         };
                         
                         console.log('Produto criado:', product);
                         products.push(product);
                     }
                 }
                 
                 console.log('Produtos finais:', products);
                
                // Verificar se algum produto tem localização
                const produtosComLocalizacao = products.filter(p => p.localizacao);
                console.log('Produtos com localização:', produtosComLocalizacao.length, produtosComLocalizacao);
                 
                 const importMessage = document.getElementById('import-message-area');
                 if (importMessage) {
                     importMessage.textContent = `Produtos importados: ${products.length}`;
                     importMessage.className = 'alert alert-success';
                     importMessage.classList.remove('hidden');
                 }
                 
                 showToast(`Importação concluída! ${products.length} produtos importados.`, 'success');
                 updateDashboardStats();
             };
             reader.readAsText(file);
         }

         async function updateDashboardStats() {
             const totalItems = document.getElementById('dashboard-total-items');
             const countedItems = document.getElementById('dashboard-counted-items');
             const scannedItems = document.getElementById('dashboard-scanned-items');
             const progress = document.getElementById('dashboard-progress');
             const progressBar = document.getElementById('dashboard-progress-bar');

             let total = 0;
             let counted = 0;
             let scanned = 0;

             if (supabase && currentUser) {
                 // Buscar todas as sessões ativas
                 const { data: activeSessions } = await supabase
                     .from('counting_sessions')
                     .select('*')
                     .eq('status', 'active');

                 if (activeSessions && activeSessions.length > 0) {
                     // Somar dados de todas as sessões ativas
                     for (const session of activeSessions) {
                         total += session.total_items || 0;
                         counted += session.counted_items || 0;
                         scanned += session.scanned_items || 0;
                     }
                 }
             } else {
                 // Fallback para dados locais se não houver conexão
                 total = currentSession?.total_items || products.length || 0;
                 counted = currentSession?.counted_items || products.filter(p => p.is_counted).length || 0;
                 scanned = currentSession?.scanned_items || 0;
             }

             const progressPercent = total > 0 ? Math.round((counted / total) * 100) : 0;

             if (totalItems) totalItems.textContent = total;
             if (countedItems) countedItems.textContent = counted;
             if (scannedItems) scannedItems.textContent = scanned;
             if (progress) progress.textContent = `${progressPercent}%`;
             if (progressBar) progressBar.style.width = `${progressPercent}%`;
         }

         async function loadUserData() {
             if (!supabase || !currentUser) return;
             
             // Load active sessions
             const { data: activeSessions } = await supabase
                 .from('counting_sessions')
                 .select('*')
                 .eq('user_id', currentUser.id)
                 .eq('status', 'active')
                 .order('created_at', { ascending: false })
                 .limit(1);

             if (activeSessions && activeSessions.length > 0) {
                 currentSession = activeSessions[0];
                 
                 const { data: sessionProducts } = await supabase
                     .from('products')
                     .select('*')
                     .eq('session_id', currentSession.id);

                 if (sessionProducts && sessionProducts.length > 0) {
                     products = sessionProducts.map(p => ({
                         codigo: p.codigo,
                         descricao: p.descricao,
                         quantidade_atual: p.quantidade_atual,
                         quantidade_contada: p.quantidade_contada,
                         is_counted: p.is_counted
                     }));
                 }
             }
             
             await updateDashboardStats();
         }

         async function syncData() {
             if (!currentUser || !supabase) return;
             await loadUserData();
         }

         function startAutoSync() {
             if (syncInterval) clearInterval(syncInterval);
             syncInterval = setInterval(async () => {
                 if (currentUser && supabase) {
                     await syncData();
                 }
             }, 30000);
         }

         function stopAutoSync() {
             if (syncInterval) {
                 clearInterval(syncInterval);
                 syncInterval = null;
             }
         }

         function setupVisibilitySync() {
             document.addEventListener('visibilitychange', async () => {
                 if (!document.hidden && currentUser && supabase) {
                     await syncData();
                 }
             });

             window.addEventListener('focus', async () => {
                 if (currentUser && supabase) {
                     await syncData();
                 }
             });
         }

         // Additional functions from original app
         async function startCountingSession() {
             if (!supabase || !currentUser) return showToast('Usuário não autenticado.', 'error');
             
             const countType = document.getElementById('count-type')?.value;
             const deviceId = document.getElementById('device-id')?.value.trim();
             
             if (!deviceId) return showToast('Por favor, informe o ID do dispositivo.', 'error');
             if (countType === 'completa' && products.length === 0) {
                 return showToast('Importe um arquivo CSV antes de iniciar a contagem completa.', 'error');
             }

             try {
                 const { data: existingSession } = await supabase
                     .from('counting_sessions')
                     .select('*')
                     .eq('user_id', currentUser.id)
                     .eq('device_id', deviceId)
                     .eq('status', 'active')
                     .single();

                 if (existingSession) {
                     return showToast('Já existe uma sessão ativa para este dispositivo.', 'error');
                 }

                 const sessionData = {
                     user_id: currentUser.id,
                     device_id: deviceId,
                     session_name: `Contagem ${countType} - ${new Date().toLocaleDateString('pt-BR')}`,
                     count_type: countType,
                     total_items: countType === 'completa' ? products.length : 0,
                     counted_items: 0,
                     scanned_items: 0,
                     status: 'active'
                 };

                 // Tentar criar sessão usando função RPC personalizada primeiro
                 const { data: rpcSession, error: rpcError } = await supabase
                     .rpc('admin_create_session', {
                         p_user_id: finalUserId,
                         p_session_name: sessionName,
                         p_description: description || '',
                         p_count_type: countType,
                         p_total_items: importedProductsCount || 0,
                         p_counted_items: 0,
                         p_scanned_items: 0,
                         p_status: 'waiting'
                     });
                 
                 let newSession, error;
                 
                 if (rpcError) {
                     // Se RPC falhar, tentar inserção direta
                     const result = await supabase
                         .from('counting_sessions')
                         .insert([sessionData])
                         .select()
                         .single();
                     
                     newSession = result.data;
                     error = result.error;
                     
                     // Se ainda falhar devido ao RLS, criar para o usuário atual
                     if (error && error.code === '42501') {
                         sessionData.user_id = user.id;
                         
                         const fallbackResult = await supabase
                             .from('counting_sessions')
                             .insert([sessionData])
                             .select()
                             .single();
                         
                         newSession = fallbackResult.data;
                         error = fallbackResult.error;
                         
                         if (!error && finalUserId !== user.id) {
                             showToast('Sessão criada para você devido às políticas de segurança do banco de dados', 'warning');
                         }
                     }
                 } else {
                     newSession = rpcSession;
                     error = null;
                 }

                 if (error) throw error;

                 currentSession = newSession;

                 if (countType === 'completa' && products.length > 0) {
                     const productsToInsert = products.map(p => ({
                         session_id: newSession.id,
                         codigo: p.codigo,
                         descricao: p.descricao,
                         localizacao: p.localizacao || null,
                         quantidade_atual: p.quantidade_atual,
                         quantidade_contada: 0,
                         is_counted: false
                     }));

                     const { error: productsError } = await supabase
                         .from('products')
                         .insert(productsToInsert);

                     if (productsError) throw productsError;
                 }

                 showToast('Sessão de contagem iniciada com sucesso!', 'success');
                 await updateDashboardStats();
                 navigateToPage('bipagem');
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao iniciar sessão: ' + err.message, 'error');
             }
         }

         async function endCountingSession() {
             if (!currentSession || !supabase) return showToast('Nenhuma sessão ativa encontrada.', 'error');
             
             const deviceId = document.getElementById('device-id')?.value.trim();
             if (!deviceId || deviceId !== currentSession.device_id) {
                 return showToast('ID do dispositivo não confere com a sessão ativa.', 'error');
             }

             try {
                 const { error } = await supabase
                     .from('counting_sessions')
                     .update({ status: 'completed', ended_at: new Date().toISOString() })
                     .eq('id', currentSession.id);

                 if (error) throw error;

                 currentSession = null;
                 products = [];
                 scans = [];
                 
                 showToast('Sessão de contagem finalizada com sucesso!', 'success');
                await updateDashboardStats();
                navigateToPage('dashboard');
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao finalizar sessão: ' + err.message, 'error');
             }
         }

         async function addScan() {
             if (!currentSession) return showToast('Nenhuma sessão ativa.', 'error');
             
             const barcodeInput = document.getElementById('barcode-input');
             const quantityInput = document.getElementById('quantity-input');
             
             const barcode = barcodeInput?.value.trim();
             const quantity = parseInt(quantityInput?.value) || 1;
             
             if (!barcode) return showToast('Digite ou escaneie um código de barras.', 'error');

             try {
                 let product = null;
                 
                 if (currentSession.count_type === 'completa') {
                     const { data: foundProduct } = await supabase
                         .from('products')
                         .select('*')
                         .eq('session_id', currentSession.id)
                         .eq('codigo', barcode)
                         .single();
                     
                     if (foundProduct) {
                         product = foundProduct;
                         const newQuantity = product.quantidade_contada + quantity;
                         
                         const { error } = await supabase
                             .from('products')
                             .update({ 
                                 quantidade_contada: newQuantity, 
                                 is_counted: true 
                             })
                             .eq('id', product.id);
                         
                         if (error) {
                            console.error('Erro detalhado do Supabase:', error);
                            console.error('Código do erro:', error.code);
                            console.error('Mensagem do erro:', error.message);
                            console.error('Detalhes do erro:', error.details);
                            throw error;
                        }

                        console.log('Dados inseridos com sucesso:', data);
                         
                         // Update local products array
                         const localProduct = products.find(p => p.codigo === barcode);
                         if (localProduct) {
                             localProduct.quantidade_contada = newQuantity;
                             localProduct.is_counted = true;
                         }
                     } else {
                         showToast('Produto não encontrado na lista importada.', 'warning');
                         return;
                     }
                 }

                 // Add scan record
                 const scanData = {
                     session_id: currentSession.id,
                     codigo: barcode,
                     descricao: product?.descricao || 'Produto não identificado',
                     quantidade: quantity,
                     scanned_at: new Date().toISOString()
                 };

                 const { error: scanError } = await supabase
                     .from('scans')
                     .insert([scanData]);

                 if (scanError) throw scanError;

                 // Update session counters
                 const countedItems = products.filter(p => p.is_counted).length;
                 const scannedItems = currentSession.scanned_items + 1;
                 
                 const { error: sessionError } = await supabase
                     .from('counting_sessions')
                     .update({ 
                         counted_items: countedItems,
                         scanned_items: scannedItems
                     })
                     .eq('id', currentSession.id);

                 if (sessionError) throw sessionError;

                 currentSession.counted_items = countedItems;
                 currentSession.scanned_items = scannedItems;

                 showToast(`Produto ${barcode} adicionado! Quantidade: ${quantity}`, 'success');
                 
                 // Clear inputs
                 if (barcodeInput) barcodeInput.value = '';
                 if (quantityInput) quantityInput.value = '1';
                 
                 await updateDashboardStats();
                renderProducts();
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao adicionar scan: ' + err.message, 'error');
             }
         }

         function renderProducts() {
             const productsList = document.getElementById('products-list');
             if (!productsList) return;

             if (products.length === 0) {
                 productsList.innerHTML = `
                     <div class="empty-state">
                         <i class="fas fa-boxes"></i>
                         <h3>Nenhum produto encontrado</h3>
                         <p>Importe um arquivo CSV para visualizar os produtos</p>
                     </div>
                 `;
                 return;
             }

             const productsHtml = products.map(product => `
                 <div class="product-item ${product.is_counted ? 'counted' : ''}">
                     <div class="product-info">
                         <div class="product-code">${product.codigo}</div>
                         <div class="product-description">${product.descricao}</div>
                     </div>
                     <div class="product-quantities">
                         <span class="quantity-label">Atual: ${product.quantidade_atual}</span>
                         <span class="quantity-label counted">Contado: ${product.quantidade_contada}</span>
                     </div>
                     <div class="product-status">
                         ${product.is_counted ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-circle"></i>'}
                     </div>
                 </div>
             `).join('');

             productsList.innerHTML = productsHtml;
         }

         async function exportData(format = 'csv', type = 'grouped') {
             if (!currentSession) return showToast('Nenhuma sessão ativa para exportar.', 'error');

             try {
                 let data = [];
                 let filename = `contagem_${currentSession.device_id}_${new Date().toISOString().split('T')[0]}`;

                 if (type === 'grouped') {
                     const { data: products } = await supabase
                         .from('products')
                         .select('*')
                         .eq('session_id', currentSession.id);

                     data = products || [];
                     filename += '_agrupado';
                 } else {
                     const { data: scans } = await supabase
                         .from('scans')
                         .select('*')
                         .eq('session_id', currentSession.id)
                         .order('scanned_at', { ascending: true });

                     data = scans || [];
                     filename += '_detalhado';
                 }

                 if (data.length === 0) {
                     return showToast('Nenhum dado para exportar.', 'warning');
                 }

                 let content = '';
                 if (format === 'csv') {
                     if (type === 'grouped') {
                         content = 'Codigo,Descricao,Quantidade_Atual,Quantidade_Contada,Diferenca\n';
                         content += data.map(item => 
                             `${item.codigo},"${item.descricao}",${item.quantidade_atual},${item.quantidade_contada},${item.quantidade_contada - item.quantidade_atual}`
                         ).join('\n');
                     } else {
                         content = 'Codigo,Descricao,Quantidade,Data_Hora\n';
                         content += data.map(item => 
                             `${item.codigo},"${item.descricao}",${item.quantidade},${new Date(item.scanned_at).toLocaleString()}`
                         ).join('\n');
                     }
                     filename += '.csv';
                 } else {
                     if (type === 'grouped') {
                         content = data.map(item => 
                             `${item.codigo}\t${item.descricao}\t${item.quantidade_atual}\t${item.quantidade_contada}\t${item.quantidade_contada - item.quantidade_atual}`
                         ).join('\n');
                     } else {
                         content = data.map(item => 
                             `${item.codigo}\t${item.descricao}\t${item.quantidade}\t${new Date(item.scanned_at).toLocaleString()}`
                         ).join('\n');
                     }
                     filename += '.txt';
                 }

                 const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = filename;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);

                 showToast(`Arquivo ${filename} exportado com sucesso!`, 'success');
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao exportar dados: ' + err.message, 'error');
             }
         }

         async function loadSessionHistory() {
             if (!supabase || !currentUser) return;

             try {
                 const { data: sessions } = await supabase
                     .from('counting_sessions')
                     .select('*')
                     .eq('user_id', currentUser.id)
                     .order('created_at', { ascending: false })
                     .limit(50);

                 const historyList = document.getElementById('history-list');
                 if (!historyList) return;

                 if (!sessions || sessions.length === 0) {
                     historyList.innerHTML = `
                         <div class="empty-state">
                             <i class="fas fa-history"></i>
                             <h3>Nenhum histórico encontrado</h3>
                             <p>Suas sessões de contagem aparecerão aqui</p>
                         </div>
                     `;
                     return;
                 }

                 const historyHtml = sessions.map(session => `
                     <div class="history-item">
                         <div class="history-info">
                             <div class="history-device">
                                 <i class="fas fa-mobile-alt"></i>
                                 ${session.device_id}
                             </div>
                             <div class="history-type">${session.count_type === 'completa' ? 'Contagem Completa' : 'Contagem Avulsa'}</div>
                             <div class="history-date">${new Date(session.created_at).toLocaleString()}</div>
                         </div>
                         <div class="history-stats">
                             <span class="stat">Total: ${session.total_items || 0}</span>
                             <span class="stat">Contados: ${session.counted_items || 0}</span>
                             <span class="stat">Scans: ${session.scanned_items || 0}</span>
                         </div>
                         <div class="history-status">
                             <span class="status ${session.status}">${session.status === 'active' ? 'Ativa' : 'Finalizada'}</span>
                         </div>
                         <div class="history-actions">
                             <button class="btn btn-sm btn-outline" onclick="viewSessionDetails('${session.id}')">
                                 <i class="fas fa-eye"></i> Ver
                             </button>
                             ${session.status === 'completed' ? `
                                 <button class="btn btn-sm btn-outline" onclick="exportSessionData('${session.id}')">
                                     <i class="fas fa-download"></i> Exportar
                                 </button>
                                 <button class="btn btn-sm btn-danger" onclick="deleteSession('${session.id}')">
                                     <i class="fas fa-trash"></i>
                                 </button>
                             ` : ''}
                         </div>
                     </div>
                 `).join('');

                 historyList.innerHTML = historyHtml;
             } catch (err) {
                 console.error(err);
                 showToast('Erro ao carregar histórico: ' + err.message, 'error');
             }
         }

         async function viewSessionDetails(sessionId) {
             // Implementation for viewing session details
             showToast('Funcionalidade em desenvolvimento', 'info');
         }

         async function exportSessionData(sessionId) {
             // Implementation for exporting specific session data
             showToast('Funcionalidade em desenvolvimento', 'info');
         }



         // Variáveis globais para sessões de contagem
         let allCountingSessions = [];
         let filteredSessions = [];
         let currentSessionsPage = 1;
         const sessionsPerPage = 10;

         // Função closeNewSessionSidebar no escopo global
         function closeNewSessionSidebar() {
             const sidebar = document.getElementById('new-session-sidebar');
             sidebar.classList.remove('active');
         }

         // Função getStatusText no escopo global
         function getStatusText(status) {
             const statusMap = {
                 'active': 'Ativa',
                 'completed': 'Concluída',
                 'paused': 'Pausada',
                 'waiting': 'Aguardando'
             };
             return statusMap[status] || status;
         }

         // Função renderSessionsTable no escopo global
         function renderSessionsTable() {
               const tableBody = document.getElementById('sessions-tbody');
               const emptyState = document.getElementById('sessions-empty');
               const tableContainer = document.querySelector('.table-container');
               if (!tableBody) {
                   console.error('sessions-tbody não encontrado!');
                   return;
               }

             if (filteredSessions.length === 0) {
                 tableContainer?.classList.add('hidden');
                 emptyState?.classList.remove('hidden');
                 updateSessionsPagination();
                 return;
             }

             tableContainer?.classList.remove('hidden');
             emptyState?.classList.add('hidden');
             
             // Calculate pagination
             const totalSessions = filteredSessions.length;
             const totalPages = Math.ceil(totalSessions / sessionsPerPage);
             const startIndex = (currentSessionsPage - 1) * sessionsPerPage;
             const endIndex = startIndex + sessionsPerPage;
             const paginatedSessions = filteredSessions.slice(startIndex, endIndex);

             tableBody.innerHTML = paginatedSessions.map(session => {
                    const progress = session.total_items > 0 ? Math.round((session.counted_items / session.total_items) * 100) : 0;
                    const userName = session.user_profiles?.name || 'N/A';
                    const sessionName = session.session_name || session.device_id || 'N/A';
                    const createdDate = new Date(session.created_at).toLocaleDateString('pt-BR');
                    const createdTime = new Date(session.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                 return `
                     <tr>
                         <td>${session.id}</td>
                         <td>${sessionName}</td>
                         <td>${userName}</td>
                         <td><span style="text-transform: capitalize;">${session.count_type}</span></td>
                         <td>
                             <span class="status-badge ${session.status}">
                                 <i class="fas fa-circle"></i>
                                 ${typeof getStatusText === 'function' ? getStatusText(session.status) : session.status}
                             </span>
                         </td>
                         <td>${session.total_items || 0}</td>
                         <td>${session.counted_items || 0}</td>
                         <td>
                             <div class="progress-container">
                                 <div class="progress-bar" style="width: ${progress}%"></div>
                             </div>
                             <div class="progress-text">${progress}%</div>
                         </td>
                         <td>
                             <div style="font-size: 0.85rem;">
                                 <div>${createdDate}</div>
                                 <div style="color: var(--text-light);">${createdTime}</div>
                             </div>
                         </td>
                         <td>
                             <div class="action-buttons">
                                 <button class="action-btn upload" onclick="uploadSessionFile('${session.id}')" title="Subir Arquivo">
                                     <i class="fas fa-upload"></i>
                                 </button>
                                 <button class="action-btn download" onclick="downloadSessionCSV('${session.id}')" title="Baixar Arquivo">
                                     <i class="fas fa-download"></i>
                                 </button>
                                 ${session.status === 'waiting' || session.status === 'active' ? `
                                 <button class="action-btn status" onclick="changeSessionStatus('${session.id}', '${session.status}')" title="${session.status === 'waiting' ? 'Iniciar Contagem' : 'Finalizar Contagem'}">
                                     <i class="fas fa-${session.status === 'waiting' ? 'play' : 'check'}"></i>
                                 </button>` : ''}

                                 <button class="action-btn delete" onclick="deleteSession('${session.id}')" title="Excluir">
                                     <i class="fas fa-trash"></i>
                                 </button>
                             </div>
                         </td>
                     </tr>
                 `;
             }).join('');
             
             updateSessionsPagination();
         }
         
         // Função para atualizar a paginação das sessões
         function updateSessionsPagination() {
             const totalSessions = filteredSessions.length;
             const totalPages = Math.ceil(totalSessions / sessionsPerPage);
             const startIndex = (currentSessionsPage - 1) * sessionsPerPage;
             const endIndex = Math.min(startIndex + sessionsPerPage, totalSessions);
             
             // Update pagination info
             const paginationInfo = document.getElementById('sessions-pagination-info');
             if (paginationInfo) {
                 if (totalSessions === 0) {
                     paginationInfo.textContent = 'Mostrando 0 a 0 de 0 sessões';
                 } else {
                     paginationInfo.textContent = `Mostrando ${startIndex + 1} a ${endIndex} de ${totalSessions} sessões`;
                 }
             }
             
             // Update page info
             const pageInfo = document.getElementById('sessions-page-info');
             if (pageInfo) {
                 pageInfo.textContent = `Página ${currentSessionsPage} de ${Math.max(1, totalPages)}`;
             }
             
             // Update navigation buttons
             const prevBtn = document.getElementById('sessions-prev-btn');
             const nextBtn = document.getElementById('sessions-next-btn');
             
             if (prevBtn) {
                 prevBtn.disabled = currentSessionsPage <= 1;
             }
             
             if (nextBtn) {
                 nextBtn.disabled = currentSessionsPage >= totalPages || totalPages === 0;
             }
         }
         
         // Função para navegar para a página anterior das sessões
         function goToSessionsPreviousPage() {
             if (currentSessionsPage > 1) {
                 currentSessionsPage--;
                 renderSessionsTable();
             }
         }
         
         // Função para navegar para a próxima página das sessões
         function goToSessionsNextPage() {
             const totalPages = Math.ceil(filteredSessions.length / sessionsPerPage);
             if (currentSessionsPage < totalPages) {
                 currentSessionsPage++;
                 renderSessionsTable();
             }
         }

         // Função loadCountingSessions no escopo global
         async function loadCountingSessions() {
             if (!supabase) {
                 console.error('Supabase not initialized');
                 showToast('Erro: Supabase não inicializado', 'error');
                 return;
             }

             const loadingState = document.getElementById('sessions-loading');
             const emptyState = document.getElementById('sessions-empty');
             const tableContainer = document.querySelector('.table-container');

             // Show loading
             loadingState?.classList.remove('hidden');
             emptyState?.classList.add('hidden');
             tableContainer?.classList.add('hidden');

             try {
                  
                  // Estratégia 1: Tentar buscar todas as sessões diretamente
                  let { data: sessions, error } = await supabase
                      .from('counting_sessions')
                      .select('*')
                      .order('created_at', { ascending: false });
                  
                  // Estratégia 2: Se RLS está limitando, tentar com diferentes abordagens
                  if (sessions && sessions.length > 0) {
                      const uniqueUsers = [...new Set(sessions.map(s => s.user_id))];
                      if (uniqueUsers.length === 1 && uniqueUsers[0] === currentUser?.id) {
                          
                          // Tentar buscar todos os usuários primeiro
                          const { data: allUsers } = await supabase
                              .from('user_profiles')
                              .select('id, name');
                          
                          if (allUsers && allUsers.length > 0) {
                              // Tentar buscar sessões para cada usuário
                              const allSessions = [];
                              for (const user of allUsers) {
                                  try {
                                      const { data: userSessions } = await supabase
                                          .from('counting_sessions')
                                          .select('*')
                                          .eq('user_id', user.id)
                                          .order('created_at', { ascending: false });
                                      
                                      if (userSessions) {
                                          allSessions.push(...userSessions);
                                      }
                                  } catch (userError) {
                                      // Erro silencioso ao buscar sessões do usuário
                                  }
                              }
                              
                              if (allSessions.length > sessions.length) {
                                  sessions = allSessions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                              }
                          }
                      }
                  }
                  

                  
                  // Verificar se RLS está limitando os resultados
                  if (sessions && sessions.length > 0) {
                      const uniqueUsers = [...new Set(sessions.map(s => s.user_id))];

                      
                      // Se só tem sessões do usuário atual, RLS pode estar ativo
                      if (uniqueUsers.length === 1 && uniqueUsers[0] === currentUser?.id) {
                          showToast('Aviso: Apenas suas sessões estão sendo exibidas devido às políticas de segurança do banco de dados.', 'warning');
                      }
                  }

                 // Buscar nomes dos usuários separadamente
                 if (sessions && sessions.length > 0) {
                     const userIds = [...new Set(sessions.map(s => s.user_id))];
                     const { data: userProfiles } = await supabase
                         .from('user_profiles')
                         .select('id, name')
                         .in('id', userIds);

                     // Adicionar nomes dos usuários às sessões
                     sessions.forEach(session => {
                         const userProfile = userProfiles?.find(u => u.id === session.user_id);
                         session.user_profiles = userProfile ? { name: userProfile.name } : null;
                     });
                 }

                 console.log('Resultado da consulta:', { sessions, error });
                 if (error) throw error;

                 allCountingSessions = sessions || [];
                 filteredSessions = [...allCountingSessions];
                 console.log('Sessions carregadas:', allCountingSessions.length);
                 if (typeof loadUsersForFilter === 'function') loadUsersForFilter();
                 if (typeof setupFilterEventListeners === 'function') setupFilterEventListeners();
                 if (typeof renderSessionsTable === 'function') renderSessionsTable();

             } catch (error) {
                 console.error('Erro ao carregar sessões:', error);
                 showToast('Erro ao carregar sessões de contagem', 'error');
             } finally {
                 loadingState?.classList.add('hidden');
             }
         }

         // Função saveNewSession definida antes dos event listeners
         async function saveNewSession() {
             const form = document.getElementById('new-session-form');
             const formData = new FormData(form);
             
             const userId = formData.get('user_id');
             const sessionName = formData.get('session_name');
             const description = formData.get('description');
             const countType = formData.get('count_type');
             
             if (!userId || !sessionName || !countType) {
                 showToast('Preencha todos os campos obrigatórios', 'error');
                 return;
             }

             if (!supabase) {
                 console.error('Supabase não está disponível');
                 showToast('Erro de conexão com o banco de dados', 'error');
                 return;
             }

             // Verificar se o usuário está autenticado
             const { data: { user }, error: authError } = await supabase.auth.getUser();
             if (authError || !user) {
                 console.error('Usuário não autenticado:', authError);
                 showToast('Você precisa estar logado para criar uma sessão', 'error');
                 return;
             }

             // Usar o userId selecionado no formulário
             let finalUserId = userId;
             
             if (!finalUserId) {
                 showToast('Por favor, selecione um usuário para a sessão', 'error');
                 return;
             }

             try {
                 console.log('importedProductsCount:', importedProductsCount);
                 
                 // Verificar se já existe uma sessão de importação ativa
                 const existingImportSession = allCountingSessions.find(session => 
                     session.session_name && session.session_name.includes('Importação CSV') && 
                     session.status === 'waiting' && 
                     session.total_items > 0
                 );
                 
                 if (existingImportSession && importedProductsCount > 0) {
                     showToast('Já existe uma sessão de importação ativa. Use a sessão existente ou exclua-a primeiro.', 'warning');
                     return;
                 }
                 
                 const sessionData = {
                     user_id: finalUserId,
                     session_name: sessionName,
                     description: description || '',
                     count_type: countType,
                     total_items: 0, // Sempre iniciar com 0 para sessões manuais
                     counted_items: 0,
                     scanned_items: 0,
                     status: 'waiting'
                 };
                 
                 console.log('Dados da sessão:', sessionData);

                 const { data: newSession, error } = await supabase
                     .from('counting_sessions')
                     .insert([sessionData])
                     .select()
                     .single();

                 if (error) throw error;

                 showToast('Nova sessão criada com sucesso!', 'success');
                 closeNewSessionSidebar();
                 loadCountingSessions();

             } catch (error) {
                 console.error('Erro ao criar sessão:', error);
                 showToast('Erro ao criar nova sessão', 'error');
             }
         }

        // Funções globais para ações do grid
        async function deleteSession(sessionId) {
            if (!confirm('Tem certeza que deseja excluir esta sessão? Esta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('counting_sessions')
                    .delete()
                    .eq('id', sessionId);

                if (error) throw error;

                showToast('Sessão excluída com sucesso!', 'success');
                loadCountingSessions();

            } catch (error) {
                console.error('Erro ao excluir sessão:', error);
                showToast('Erro ao excluir sessão', 'error');
            }
        }

        // Funções de filtro globais
        function loadUsersForFilter() {
            const userFilter = document.getElementById('user-filter');
            if (!userFilter || !allCountingSessions) return;

            // Usar Map para garantir usuários únicos por ID
            const usersMap = new Map();
            
            allCountingSessions
                .filter(session => session.user_profiles?.name && session.user_id)
                .forEach(session => {
                    if (!usersMap.has(session.user_id)) {
                        usersMap.set(session.user_id, {
                            id: session.user_id,
                            name: session.user_profiles.name
                        });
                    }
                });
            
            // Converter Map para array e ordenar por nome
            const uniqueUsers = Array.from(usersMap.values())
                .sort((a, b) => a.name.localeCompare(b.name));
            
            // Limpar opções existentes (exceto "Todos os Usuários")
            userFilter.innerHTML = '<option value="">Todos os Usuários</option>';
            
            // Adicionar opções de usuários
            uniqueUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userFilter.appendChild(option);
            });
        }

        function setupFilterEventListeners() {
            // Search input
            const searchInput = document.getElementById('session-search');
            if (searchInput) {
                searchInput.removeEventListener('input', filterSessions);
                searchInput.addEventListener('input', filterSessions);
            }

            // Filter selects
            const userFilter = document.getElementById('user-filter');
            const statusFilter = document.getElementById('status-filter');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            
            if (statusFilter) {
                statusFilter.removeEventListener('change', filterSessions);
                statusFilter.addEventListener('change', filterSessions);
            }
            if (userFilter) {
                userFilter.removeEventListener('change', filterSessions);
                userFilter.addEventListener('change', filterSessions);
            }
            if (clearFiltersBtn) {
                clearFiltersBtn.removeEventListener('click', clearFilters);
                clearFiltersBtn.addEventListener('click', clearFilters);
            }
        }

        function filterSessions() {
            const searchTerm = document.getElementById('session-search')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('status-filter')?.value || '';
            const userFilter = document.getElementById('user-filter')?.value || '';

            filteredSessions = allCountingSessions.filter(session => {
                   const sessionName = session.session_name || session.device_id || '';
                   const userName = session.user_profiles?.name || '';
                   
                   const matchesSearch = !searchTerm || 
                       sessionName.toLowerCase().includes(searchTerm) ||
                       userName.toLowerCase().includes(searchTerm);
                   
                   const matchesStatus = !statusFilter || session.status === statusFilter;
                   const matchesUser = !userFilter || session.user_id === userFilter;
 
                   return matchesSearch && matchesStatus && matchesUser;
               });

            // Reset to first page when filters change
            currentSessionsPage = 1;
            renderSessionsTable();
        }

        function clearFilters() {
            const searchInput = document.getElementById('session-search');
            const statusFilter = document.getElementById('status-filter');
            const userFilter = document.getElementById('user-filter');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            if (userFilter) userFilter.value = '';
            

            currentSessionsPage = 1;
            filterSessions();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
             // Navigation event listeners
             document.querySelectorAll('.nav-item').forEach(item => {
                 item.addEventListener('click', (e) => {
                     e.preventDefault();
                     const page = item.getAttribute('data-page');
                     if (page) navigateToPage(page);
                 });
             });

             // Auth form event listeners
             document.getElementById('login-btn')?.addEventListener('click', handleLogin);
             document.getElementById('register-btn')?.addEventListener('click', handleRegister);
             document.getElementById('login-tab')?.addEventListener('click', () => switchAuthTab('login'));
             document.getElementById('register-tab')?.addEventListener('click', () => switchAuthTab('register'));

             // Main app event listeners
             document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
             document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
             document.getElementById('import-btn')?.addEventListener('click', handleImport);
             document.getElementById('start-session-btn')?.addEventListener('click', startCountingSession);
             document.getElementById('end-session-btn')?.addEventListener('click', endCountingSession);
             document.getElementById('add-scan-btn')?.addEventListener('click', addScan);
             
             // Export buttons
             document.getElementById('export-csv-grouped')?.addEventListener('click', () => exportData('csv', 'grouped'));
             document.getElementById('export-csv-detailed')?.addEventListener('click', () => exportData('csv', 'detailed'));
             document.getElementById('export-txt-grouped')?.addEventListener('click', () => exportData('txt', 'grouped'));
             document.getElementById('export-txt-detailed')?.addEventListener('click', () => exportData('txt', 'detailed'));

             // Barcode input enter key
             document.getElementById('barcode-input')?.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                     e.preventDefault();
                     addScan();
                 }
             });

             // New session form event listeners
             const newSessionForm = document.getElementById('new-session-form');
             if (newSessionForm) {
                 newSessionForm.addEventListener('submit', (e) => {
                     e.preventDefault();
                     if (typeof saveNewSession === 'function') {
                         saveNewSession();
                     }
                 });
             }
             
             // File input event listener for sidebar
             const productsFileInput = document.getElementById('products-file');
             if (productsFileInput) {
                 productsFileInput.addEventListener('change', handleFileSelect);
             }
             
             // Sidebar close button
             const closeSidebarBtn = document.getElementById('close-sidebar-btn');
             if (closeSidebarBtn) {
                 closeSidebarBtn.addEventListener('click', () => {
                     const sidebar = document.getElementById('new-session-sidebar');
                     if (sidebar) {
                         sidebar.classList.remove('active');
                     }
                 });
             }
             
             // Cancel session button
             const cancelSessionBtn = document.getElementById('cancel-session-btn');
             if (cancelSessionBtn) {
                 cancelSessionBtn.addEventListener('click', () => {
                     const sidebar = document.getElementById('new-session-sidebar');
                     if (sidebar) {
                         sidebar.classList.remove('active');
                     }
                 });
             }
             
             const saveSessionBtn = document.getElementById('save-session-btn');
             if (saveSessionBtn) {
                 saveSessionBtn.addEventListener('click', (e) => {
                     e.preventDefault();
                     if (typeof saveNewSession === 'function') {
                         saveNewSession();
                     } else {
                         console.error('saveNewSession function not found');
                     }
                 });
             } else {
                 console.error('Save button not found in DOM');
             }

             // Load history when navigating to history page
             const historyNavItem = document.querySelector('[data-page="historico"]');
             historyNavItem?.addEventListener('click', loadSessionHistory);

             // Initialize theme
             const savedTheme = localStorage.getItem('theme') || 'light';
             document.documentElement.setAttribute('data-theme', savedTheme);
             if (themeToggle) {
                 const icon = themeToggle.querySelector('i');
                 if (icon) {
                     icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                 }
             }

             // Check authentication state
             if (supabase) {
                 supabase.auth.onAuthStateChange((event, session) => {
                     if (event === 'SIGNED_IN' && session) {
                         // User signed in
                     } else if (event === 'SIGNED_OUT') {
                         showAuthSection();
                     }
                 });

                 // ===== COUNTING SESSIONS CRUD FUNCTIONS =====
                 // Variáveis e função movidas para escopo global
                 // renderSessionsTable movida para escopo global

                 // getStatusText movida para escopo global



                 // Variáveis globais para a sidebar
                let availableUsers = [];
                let selectedFile = null;
                let importedProductsCount = 0;







                function handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        selectedFile = file;
                        const fileNameElement = document.getElementById('file-name');
                        const fileSizeElement = document.getElementById('file-size');
                        const fileInfoElement = document.getElementById('file-info');
                        const importStatusElement = document.getElementById('import-status');
                        const importButton = document.getElementById('import-products-btn');
                        
                        if (fileNameElement) fileNameElement.textContent = file.name;
                        if (fileSizeElement) fileSizeElement.textContent = formatFileSize(file.size);
                        if (fileInfoElement) {
                            fileInfoElement.style.display = 'flex';
                            fileInfoElement.classList.remove('hidden');
                        }
                        if (importButton) {
                            importButton.style.display = 'block';
                            // Adicionar event listener se ainda não foi adicionado
                            if (!importButton.hasAttribute('data-listener-added')) {
                                importButton.addEventListener('click', () => {
                                    if (typeof importProducts === 'function') {
                                        importProducts();
                                    }
                                });
                                importButton.setAttribute('data-listener-added', 'true');
                            }
                        }
                        if (importStatusElement) {
                            importStatusElement.style.display = 'none';
                            importStatusElement.classList.add('hidden');
                        }
                        
                        // Sugerir nome da sessão baseado no nome do arquivo (sem extensão)
                        const sessionNameInput = document.getElementById('sidebar-session-name');
                        if (sessionNameInput && !sessionNameInput.value.trim()) {
                            const fileName = file.name;
                            const nameWithoutExtension = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
                            sessionNameInput.value = nameWithoutExtension;
                        }
                    }
                }

                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                async function importProducts() {
                    if (!selectedFile) {
                        showToast('Selecione um arquivo primeiro', 'error');
                        return;
                    }

                    try {
                        const text = await selectedFile.text();
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        if (lines.length === 0) {
                            showToast('Arquivo vazio ou inválido', 'error');
                            return;
                        }

                        // Formato CSV: codigo,descricao,quantidade,localizacao
                        const products = [];
                        for (let i = 1; i < lines.length; i++) { // Pular cabeçalho
                            const cols = lines[i].split(',').map(s => s.trim());
                            const codigo = cols[0] || '';
                            const descricao = cols[1] || '';
                            const quantidade = cols[2] ? parseInt(cols[2]) || 0 : 0;
                            const localizacao = cols[3] || '';
                            
                            if (codigo && descricao) {
                                products.push({
                                    codigo,
                                    descricao,
                                    quantidade,
                                    localizacao
                                });
                            }
                        }

                        if (products.length === 0) {
                            showToast('Nenhum produto válido encontrado no arquivo', 'error');
                            return;
                        }

                        // Tentar inserir no Supabase, se falhar usar localStorage
                        console.log('Produtos a serem inseridos:', products);
                        
                        try {
                             // Primeiro, obter o usuário atual
                             const { data: { user } } = await supabase.auth.getUser();
                             
                             // Criar uma sessão de contagem
                             const { data: sessionData, error: sessionError } = await supabase
                                 .from('counting_sessions')
                                 .insert({
                                     user_id: user?.id || crypto.randomUUID(),
                                     session_name: 'Importação CSV - ' + new Date().toLocaleString(),
                                     description: 'Sessão criada automaticamente para importação de produtos',
                                     count_type: 'normal',
                                     status: 'waiting',
                                     total_items: 0
                                 })
                                 .select()
                                 .single();

                             if (sessionError) {
                                 console.error('Erro ao criar sessão:', sessionError);
                                 throw sessionError;
                             }

                             const sessionId = sessionData.id;
                             console.log('Sessão criada com sucesso:', sessionId);

                             // Preparar dados dos produtos com session_id válido
                             const supabaseProducts = products.map(p => ({
                                 codigo: p.codigo,
                                 descricao: p.descricao,
                                 localizacao: p.localizacao || null,
                                 session_id: sessionId,
                                 expected_qty: p.quantidade || 0
                             }));
                             
                             console.log('Dados que serão enviados ao Supabase:', supabaseProducts);
                             console.log('Produtos com localização para Supabase:', supabaseProducts.filter(p => p.localizacao));
                             
                             const { data, error } = await supabase
                                 .from('products')
                                 .insert(supabaseProducts)
                                 .select();

                             if (error) {
                                 console.error('Erro detalhado do Supabase:', error);
                                 console.error('Código do erro:', error.code);
                                 console.error('Mensagem do erro:', error.message);
                                 console.error('Detalhes do erro:', error.details);
                                 throw error;
                             }

                             console.log('Dados inseridos com sucesso no Supabase:', data);
                             
                             // Atualizar a sessão com o total correto de itens
                             console.log('Atualizando sessão:', sessionId, 'com total_items:', data.length);
                             const { data: updateData, error: updateError } = await supabase
                                 .from('counting_sessions')
                                 .update({ 
                                     total_items: data.length,
                                     status: 'waiting'
                                 })
                                 .eq('id', sessionId)
                                 .select();
                             
                             if (updateError) {
                                 console.error('Erro ao atualizar sessão:', updateError);
                                 console.error('Detalhes do erro de atualização:', updateError.details);
                                 console.error('Código do erro de atualização:', updateError.code);
                             } else {
                                 console.log('Sessão atualizada com sucesso:', updateData);
                                 console.log('Total de itens confirmado:', updateData?.[0]?.total_items);
                             }
                             
                             // Salvar dados completos (com quantidade) no localStorage também
                             let existingProducts = JSON.parse(localStorage.getItem('products') || '[]');
                             products.forEach(newProduct => {
                                 const existingIndex = existingProducts.findIndex(p => p.codigo === newProduct.codigo);
                                 if (existingIndex >= 0) {
                                     existingProducts[existingIndex] = newProduct;
                                 } else {
                                     existingProducts.push(newProduct);
                                 }
                             });
                             localStorage.setItem('products', JSON.stringify(existingProducts));
                             
                             // Mostrar mensagem de sucesso para Supabase
                             showToast(`${products.length} produtos importados com sucesso!`, 'success');
                        } catch (supabaseError) {
                             console.warn('Falha no Supabase, usando localStorage:', supabaseError.message);
                             
                             // Fallback para localStorage
                             let existingProducts = JSON.parse(localStorage.getItem('products') || '[]');
                             
                             // Adicionar novos produtos (evitar duplicatas por código)
                             products.forEach(newProduct => {
                                 const existingIndex = existingProducts.findIndex(p => p.codigo === newProduct.codigo);
                                 if (existingIndex >= 0) {
                                     existingProducts[existingIndex] = newProduct; // Atualizar
                                 } else {
                                     existingProducts.push(newProduct); // Adicionar
                                 }
                             });
                             
                             localStorage.setItem('products', JSON.stringify(existingProducts));
                             console.log('Produtos salvos no localStorage:', existingProducts.length);
                             
                             // Mostrar mensagem específica sobre armazenamento local
                             showToast(`${products.length} produtos salvos localmente (banco indisponível)`, 'warning');
                         }
                        importedProductsCount = products.length;
                        
                        // Atualizar indicador visual de produtos importados
                        const productsImportedCount = document.getElementById('products-imported-count');
                        const productsImportedIndicator = document.getElementById('products-imported-indicator');
                        
                        if (productsImportedCount) {
                            productsImportedCount.textContent = importedProductsCount;
                        }
                        if (productsImportedIndicator) {
                            productsImportedIndicator.style.display = 'inline';
                        }
                        
                        // Verificar se os elementos existem antes de definir propriedades
                        const importedCountEl = document.getElementById('imported-count');
                        const importStatusEl = document.getElementById('import-status');
                        
                        if (importedCountEl) {
                            importedCountEl.textContent = importedProductsCount;
                        }
                        if (importStatusEl) {
                            importStatusEl.style.display = 'flex';
                        }

                    } catch (error) {
                        console.error('Erro ao importar produtos:', error);
                        showToast('Erro ao importar produtos', 'error');
                    }
                }

                // Função saveNewSession movida para antes do DOMContentLoaded

                 async function editSession(sessionId) {
                     const session = allCountingSessions.find(s => s.id === sessionId);
                     if (!session) return;

                     const newDeviceId = prompt('Digite o novo ID do dispositivo:', session.device_id);
                     if (!newDeviceId || newDeviceId === session.device_id) return;

                     try {
                         const { error } = await supabase
                             .from('counting_sessions')
                             .update({ device_id: newDeviceId })
                             .eq('id', sessionId);

                         if (error) throw error;

                         showToast('Sessão atualizada com sucesso!', 'success');
                         loadCountingSessions();

                     } catch (error) {
                         console.error('Erro ao editar sessão:', error);
                         showToast('Erro ao editar sessão', 'error');
                     }
                 }







                 // Manter função original para compatibilidade
                 function generateSessionCSV(session, countingItems) {
                     const sessionName = session.session_name || session.device_id || 'N/A';
                     const userName = session.user_profiles?.name || 'N/A';
                     const createdDate = new Date(session.created_at).toLocaleString('pt-BR');
                     
                     let csv = 'Relatório de Sessão de Contagem\n\n';
                     csv += `Sessão:,${sessionName}\n`;
                     csv += `Usuário:,${userName}\n`;
                     csv += `Tipo:,${session.count_type}\n`;
                     csv += `Status:,${getStatusText(session.status)}\n`;
                     csv += `Total de Itens:,${session.total_items || 0}\n`;
                     csv += `Itens Contados:,${session.counted_items || 0}\n`;
                     csv += `Criado em:,${createdDate}\n\n`;
                     
                     if (countingItems && countingItems.length > 0) {
                         csv += 'Detalhes dos Itens:\n';
                         csv += 'ID,Código,Quantidade,Data/Hora\n';
                         
                         countingItems.forEach(item => {
                             const itemDate = new Date(item.created_at).toLocaleString('pt-BR');
                             csv += `${item.id},${item.item_code || 'N/A'},${item.quantity || 0},${itemDate}\n`;
                         });
                     } else {
                         csv += 'Nenhum item de contagem encontrado.\n';
                     }
                     
                     return csv;
                 }



                 // Initialize counting page when it becomes active
                 const observer = new MutationObserver((mutations) => {
                     mutations.forEach((mutation) => {
                         if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                             const contagemPage = document.getElementById('contagem-page');
                             if (contagemPage && contagemPage.classList.contains('active')) {
                                 loadCountingSessions();
                             }
                         }
                     });
                 });

                 // Observe all pages for class changes
                 document.querySelectorAll('[data-page]').forEach(page => {
                     observer.observe(page, { attributes: true, attributeFilter: ['class'] });
                 });

                 // Check if user is already logged in
                 supabase.auth.getSession().then(({ data: { session } }) => {
                     if (session) {
                         currentUser = session.user;
                         showMainApp();
                         loadUserData();
                         startAutoSync();
                         setupVisibilitySync();
                     } else {
                         showAuthSection();
                     }
                 });
             } else {
                 showAuthSection();
             }

             // Setup event listeners after all functions are defined
             
             // Define functions
             async function loadAvailableUsers() {
                 try {
                     const { data: userProfiles, error } = await supabase
                         .from('user_profiles')
                         .select('id, name')
                         .eq('authorized', true)
                         .order('name');

                     if (error) throw error;
                     availableUsers = userProfiles || [];
                 } catch (error) {
                     console.error('Erro ao carregar usuários:', error);
                     availableUsers = [];
                 }
             }

             function openNewSessionSidebar() {
                 const sidebar = document.getElementById('new-session-sidebar');
                 const userSelect = document.getElementById('session-user');
                 
                 if (!sidebar) {
                     console.error('Elemento sidebar não encontrado!');
                     return;
                 }
                 
                 // Limpar formulário
                 const form = document.getElementById('new-session-form');
                 if (form) {
                     form.reset();
                 }
                 selectedFile = null;
                 importedProductsCount = 0;
                 
                 const fileInfo = document.getElementById('file-info');
                 const importStatus = document.getElementById('import-status');
                 if (fileInfo) fileInfo.style.display = 'none';
                 if (importStatus) importStatus.style.display = 'none';
                 
                 // Preencher combo de usuários
                 userSelect.innerHTML = '<option value="">Selecione um usuário</option>';
                 availableUsers.forEach(user => {
                     const option = document.createElement('option');
                     option.value = user.id;
                     option.textContent = user.name;
                     if (user.id === currentUser.id) {
                         option.selected = true;
                     }
                     userSelect.appendChild(option);
                 });
                 
                 sidebar.classList.add('active');
             }



         async function createNewSession() {
                 
                 // Verificar se já existe uma sessão de importação ativa
                 const existingImportSession = allCountingSessions.find(session => 
                     session.session_name && 
                     session.session_name.includes('Importação CSV') && 
                     session.status === 'waiting' &&
                     session.total_items > 0
                 );
                 
                 if (existingImportSession) {
                     showToast('Já existe uma sessão de importação ativa. Complete ou exclua a sessão existente antes de criar uma nova.', 'warning');
                     return;
                 }
                 
                 try {
                     await loadAvailableUsers();
                     openNewSessionSidebar();
                 } catch (error) {
                     console.error('Erro em createNewSession:', error);
                 }
             }

             // New session button event listener
             const newSessionBtn = document.getElementById('new-session-btn');
             if (newSessionBtn) {
                 newSessionBtn.addEventListener('click', () => {
                     createNewSession();
                 });
             } else {
                 console.error('newSessionBtn não encontrado!');
             }

             // Refresh sessions button
             const refreshSessionsBtn = document.getElementById('refresh-sessions-btn');
             if (refreshSessionsBtn) {
                 refreshSessionsBtn.addEventListener('click', () => {
                     if (typeof loadCountingSessions === 'function') {
                         loadCountingSessions();
                     } else {
                         console.error('loadCountingSessions não é uma função');
                     }
                 });
             }

             // Sidebar event listeners

             const cancelSidebarBtn = document.getElementById('cancel-session-btn');
             if (cancelSidebarBtn) {
                 cancelSidebarBtn.addEventListener('click', () => {
                     if (typeof closeNewSessionSidebar === 'function') {
                         closeNewSessionSidebar();
                     }
                 });
             }

             // Event listeners movidos para DOMContentLoaded

             const productFileInput = document.getElementById('products-file');
             if (productFileInput) {
                 productFileInput.addEventListener('change', (e) => {
                     if (typeof handleFileSelect === 'function') {
                         handleFileSelect(e);
                     }
                 });
             }

             const importProductsBtn = document.getElementById('import-products-btn');
             if (importProductsBtn) {
                 importProductsBtn.addEventListener('click', () => {

                     if (typeof importProducts === 'function') {
                         importProducts();
                     }
                 });
             }

             const fileUploadArea = document.getElementById('file-upload-area');
             if (fileUploadArea) {
                 fileUploadArea.addEventListener('click', () => {
                     const fileInput = document.getElementById('products-file');
                     if (fileInput) fileInput.click();
                 });
             }

             const sidebarOverlay = document.getElementById('sidebar-overlay');
             if (sidebarOverlay) {
                 sidebarOverlay.addEventListener('click', () => {
                     if (typeof closeNewSessionSidebar === 'function') {
                         closeNewSessionSidebar();
                     }
                 });
             }

             // Configurar event listeners para os formulários de configuração
             const formContagens = document.getElementById('form-configurar-contagens');
             const formExportacoes = document.getElementById('form-configurar-exportacoes');

             if (formContagens) {
                 formContagens.addEventListener('submit', handleSaveConfigContagens);
             }

             if (formExportacoes) {
                 formExportacoes.addEventListener('submit', handleSaveConfigExportacoes);
             }

             // Carregar configurações existentes ao inicializar
             loadExistingConfigurations();
         });

         // ===== FUNÇÕES DE CONFIGURAÇÃO =====

         // Função para carregar configurações de contagens
         async function loadConfiguracaoContagens() {
             await loadExistingConfigurations();
         }

         // Função para carregar configurações de exportações
         async function loadConfiguracaoExportacoes() {
             await loadExistingConfigurations();
         }

         // Função para carregar configurações existentes
         async function loadExistingConfigurations() {
             try {
                 const { data, error } = await supabase
                     .from('configuracao_estoque')
                     .select('*')
                     .limit(1)
                     .single();

                 if (error && error.code !== 'PGRST116') {
                     console.error('Erro ao carregar configurações:', error);
                     return;
                 }

                 if (data) {
                     populateConfigurationForms(data);
                 }
             } catch (error) {
                 console.error('Erro ao carregar configurações:', error);
             }
         }

         // Função para popular os formulários com dados existentes
         function populateConfigurationForms(config) {
             // Formulário de Contagens
             document.getElementById('tipo-contagem-padrao').value = config.tipo_contagem_padrao || 'normal';
             document.getElementById('tipo-importacao-padrao').value = config.tipo_importacao_padrao || 'csv';
             document.getElementById('importacao-descricao').checked = config.importacao_incluir_descricao || false;
             document.getElementById('importacao-localizacao').checked = config.importacao_incluir_localizacao || false;

             // Formulário de Exportações
             document.getElementById('tipo-exportacao').value = config.tipo_exportacao || 'detalhada';
             document.getElementById('tipo-exportacao-padrao').value = config.tipo_exportacao_padrao || 'csv';
             document.getElementById('exportacao-descricao').checked = config.exportacao_incluir_descricao || false;
             document.getElementById('exportacao-localizacao').checked = config.exportacao_incluir_localizacao || false;
         }

         // Função para salvar configurações de contagens
         async function handleSaveConfigContagens(event) {
             event.preventDefault();

             const formData = new FormData(event.target);
             const configData = {
                 tipo_contagem_padrao: formData.get('tipo_contagem_padrao'),
                 tipo_importacao_padrao: formData.get('tipo_importacao_padrao'),
                 importacao_incluir_codigo: true, // Sempre true
                 importacao_incluir_quantidade: true, // Sempre true
                 importacao_incluir_descricao: formData.has('importacao_incluir_descricao'),
                 importacao_incluir_localizacao: formData.has('importacao_incluir_localizacao')
             };

             await saveConfiguration(configData, 'message-contagens');
         }

         // Função para salvar configurações de exportações
         async function handleSaveConfigExportacoes(event) {
             event.preventDefault();

             const formData = new FormData(event.target);
             const configData = {
                 tipo_exportacao: formData.get('tipo_exportacao'),
                 tipo_exportacao_padrao: formData.get('tipo_exportacao_padrao'),
                 exportacao_incluir_codigo: true, // Sempre true
                 exportacao_incluir_quantidade: true, // Sempre true
                 exportacao_incluir_descricao: formData.has('exportacao_incluir_descricao'),
                 exportacao_incluir_localizacao: formData.has('exportacao_incluir_localizacao')
             };

             await saveConfiguration(configData, 'message-exportacoes');
         }

         // Função principal para salvar configuração
         async function saveConfiguration(configData, messageElementId) {
             const messageElement = document.getElementById(messageElementId);
             
             try {
                 // Mostrar mensagem de carregamento
                 showMessage(messageElement, 'Salvando configurações...', 'info');

                 // Verificar se já existe uma configuração
                 const { data: existingConfig, error: selectError } = await supabase
                     .from('configuracao_estoque')
                     .select('id')
                     .limit(1)
                     .single();

                 let result;
                 if (existingConfig) {
                     // Atualizar configuração existente
                     result = await supabase
                         .from('configuracao_estoque')
                         .update({
                             ...configData,
                             updated_at: new Date().toISOString()
                         })
                         .eq('id', existingConfig.id);
                 } else {
                     // Criar nova configuração
                     result = await supabase
                         .from('configuracao_estoque')
                         .insert([configData]);
                 }

                 if (result.error) {
                     throw result.error;
                 }

                 showMessage(messageElement, 'Configurações salvas com sucesso!', 'success');
                 
                 // Recarregar configurações para sincronizar
                 setTimeout(() => {
                     loadExistingConfigurations();
                 }, 1000);

             } catch (error) {
                 console.error('Erro ao salvar configurações:', error);
                 showMessage(messageElement, `Erro ao salvar configurações: ${error.message}`, 'error');
             }
         }

         // Função para mostrar mensagens
         function showMessage(element, message, type) {
             element.textContent = message;
             element.className = `message-area ${type}`;
             element.style.display = 'block';

             if (type === 'success' || type === 'info') {
                 setTimeout(() => {
                     element.style.display = 'none';
                 }, 5000);
             }
         }

         // Função para resetar formulário de contagens
         function resetFormContagens() {
             document.getElementById('tipo-contagem-padrao').value = 'normal';
             document.getElementById('tipo-importacao-padrao').value = 'csv';
             document.getElementById('importacao-descricao').checked = false;
             document.getElementById('importacao-localizacao').checked = false;
             
             const messageElement = document.getElementById('message-contagens');
             messageElement.style.display = 'none';
         }

         // Função para resetar formulário de exportações
         function resetFormExportacoes() {
             document.getElementById('tipo-exportacao').value = 'detalhada';
             document.getElementById('tipo-exportacao-padrao').value = 'csv';
             document.getElementById('exportacao-descricao').checked = false;
             document.getElementById('exportacao-localizacao').checked = false;
             
             const messageElement = document.getElementById('message-exportacoes');
             messageElement.style.display = 'none';
         }

         // ===== PRODUTOS PAGE FUNCTIONS =====
         
         // Variáveis globais para produtos
         let currentProductsPage = 1;
         let productsPerPage = 20;
         let totalProducts = 0;
         let currentProductsSort = { field: 'created_at', direction: 'desc' };
         let productsFilters = {
             search: '',
             session_id: '',
             is_counted: ''
         };

         // Carregar produtos do Supabase
         async function loadProducts() {
             try {
                 if (!supabase) {
                     showToast('Conexão com banco de dados indisponível', 'error');
                     return;
                 }

                 // Construir query base
                 let query = supabase
                     .from('products')
                     .select('*', { count: 'exact' });

                 // Aplicar filtros
                 if (productsFilters.search) {
                     query = query.or(`codigo.ilike.%${productsFilters.search}%,descricao.ilike.%${productsFilters.search}%`);
                 }

                 if (productsFilters.session_id) {
                     query = query.eq('session_id', productsFilters.session_id);
                 }

                 if (productsFilters.is_counted !== '') {
                     query = query.eq('is_counted', productsFilters.is_counted === 'true');
                 }

                 // Aplicar ordenação
                 query = query.order(currentProductsSort.field, { ascending: currentProductsSort.direction === 'asc' });

                 // Aplicar paginação
                 const from = (currentProductsPage - 1) * productsPerPage;
                 const to = from + productsPerPage - 1;
                 query = query.range(from, to);

                 const { data: products, error, count } = await query;

                 if (error) {
                     console.error('Erro ao carregar produtos:', error);
                     showToast('Erro ao carregar produtos: ' + error.message, 'error');
                     return;
                 }

                 totalProducts = count || 0;
                 displayProducts(products || []);
                 updateProductsPagination();

             } catch (error) {
                 console.error('Erro ao carregar produtos:', error);
                 showToast('Erro ao carregar produtos', 'error');
             }
         }

         // Exibir produtos na tabela
         function displayProducts(products) {
             const tbody = document.getElementById('products-table-body');
             const emptyState = document.getElementById('products-empty-state');
             const tableContainer = document.querySelector('#produtos-page .table-container');

             if (!products || products.length === 0) {
                 tbody.innerHTML = '';
                 tableContainer.style.display = 'none';
                 emptyState.classList.remove('hidden');
                 return;
             }

             tableContainer.style.display = 'block';
             emptyState.classList.add('hidden');

             tbody.innerHTML = products.map(product => {
                 const statusBadge = product.is_counted 
                     ? '<span class="badge badge-success">Contado</span>'
                     : '<span class="badge badge-warning">Pendente</span>';
                 
                 const createdAt = new Date(product.created_at).toLocaleDateString('pt-BR');
                 const sessionName = 'Sessão ' + (product.session_id || 'N/A');

                 return `
                     <tr>
                         <td><strong>${product.codigo}</strong></td>
                         <td>${product.descricao}</td>
                         <td>${product.localizacao || '-'}</td>
                         <td class="text-center">${product.quantidade_atual || 0}</td>
                         <td class="text-center">${product.quantidade_contada || 0}</td>
                         <td class="text-center">${product.scanned_qty || 0}</td>
                         <td class="text-center">${statusBadge}</td>
                         <td class="text-center">${createdAt}</td>
                         <td class="text-center">
                             <div class="action-buttons">
                                 <button class="action-btn view" onclick="viewProduct('${product.id}')" title="Visualizar">
                                     <i class="fas fa-eye"></i>
                                 </button>
                                 <button class="action-btn edit" onclick="editProduct('${product.id}')" title="Editar">
                                     <i class="fas fa-edit"></i>
                                 </button>
                                 <button class="action-btn delete" onclick="deleteProduct('${product.id}')" title="Excluir">
                                     <i class="fas fa-trash"></i>
                                 </button>
                             </div>
                         </td>
                     </tr>
                 `;
             }).join('');
         }

         // Atualizar informações de paginação
         function updateProductsPagination() {
             const totalPages = Math.ceil(totalProducts / productsPerPage);
             const startItem = totalProducts > 0 ? (currentProductsPage - 1) * productsPerPage + 1 : 0;
             const endItem = Math.min(currentProductsPage * productsPerPage, totalProducts);

             document.getElementById('products-pagination-info').textContent = 
                 `Mostrando ${startItem} a ${endItem} de ${totalProducts} produtos`;
             
             document.getElementById('products-page-info').textContent = 
                 `Página ${currentProductsPage} de ${totalPages}`;

             document.getElementById('products-prev-btn').disabled = currentProductsPage <= 1;
             document.getElementById('products-next-btn').disabled = currentProductsPage >= totalPages;
         }

         // Carregar sessões para o filtro
         async function loadSessionsForFilter() {
             try {
                 if (!supabase) return;

                 const { data: sessions, error } = await supabase
                     .from('counting_sessions')
                     .select('id, session_name')
                     .order('id', { ascending: false });

                 if (error) {
                     console.error('Erro ao carregar sessões:', error);
                     return;
                 }

                 const sessionFilter = document.getElementById('session-filter');
                 sessionFilter.innerHTML = '<option value="">Todas as Sessões</option>';
                 
                 sessions.forEach(session => {
                     const option = document.createElement('option');
                     option.value = session.id;
                     option.textContent = session.session_name || `Sessão ${session.id}`;
                     sessionFilter.appendChild(option);
                 });

             } catch (error) {
                 console.error('Erro ao carregar sessões:', error);
             }
         }

         // Aplicar filtros
         function applyProductsFilters() {
             productsFilters.search = document.getElementById('product-search').value.trim();
             productsFilters.session_id = document.getElementById('session-filter').value;
             productsFilters.is_counted = document.getElementById('counted-filter').value;
             
             currentProductsPage = 1;
             loadProducts();
         }

         // Limpar filtros
         function clearProductsFilters() {
             document.getElementById('product-search').value = '';
             document.getElementById('session-filter').value = '';
             document.getElementById('counted-filter').value = '';
             
             productsFilters = { search: '', session_id: '', is_counted: '' };
             currentProductsPage = 1;
             loadProducts();
         }

         // Ordenar produtos
         function sortProducts(field) {
             if (currentProductsSort.field === field) {
                 currentProductsSort.direction = currentProductsSort.direction === 'asc' ? 'desc' : 'asc';
             } else {
                 currentProductsSort.field = field;
                 currentProductsSort.direction = 'asc';
             }
             
             currentProductsPage = 1;
             loadProducts();
         }

         // Ações dos produtos
         function viewProduct(productId) {
             showToast('Funcionalidade de visualização em desenvolvimento', 'info');
         }

         function editProduct(productId) {
             showToast('Funcionalidade de edição em desenvolvimento', 'info');
         }

         async function deleteProduct(productId) {
             if (!confirm('Tem certeza que deseja excluir este produto?')) {
                 return;
             }

             try {
                 if (!supabase) {
                     showToast('Conexão com banco de dados indisponível', 'error');
                     return;
                 }

                 const { error } = await supabase
                     .from('products')
                     .delete()
                     .eq('id', productId);

                 if (error) {
                     console.error('Erro ao excluir produto:', error);
                     showToast('Erro ao excluir produto: ' + error.message, 'error');
                     return;
                 }

                 showToast('Produto excluído com sucesso!', 'success');
                 loadProducts();

             } catch (error) {
                 console.error('Erro ao excluir produto:', error);
                 showToast('Erro ao excluir produto', 'error');
             }
         }

         // Exportar produtos
         async function exportProducts() {
             try {
                 if (!supabase) {
                     showToast('Conexão com banco de dados indisponível', 'error');
                     return;
                 }

                 // Buscar todos os produtos (sem paginação para exportação)
                 let query = supabase
                     .from('products')
                     .select('*');

                 // Aplicar os mesmos filtros da visualização
                 if (productsFilters.search) {
                     query = query.or(`codigo.ilike.%${productsFilters.search}%,descricao.ilike.%${productsFilters.search}%`);
                 }

                 if (productsFilters.session_id) {
                     query = query.eq('session_id', productsFilters.session_id);
                 }

                 if (productsFilters.is_counted !== '') {
                     query = query.eq('is_counted', productsFilters.is_counted === 'true');
                 }

                 query = query.order(currentProductsSort.field, { ascending: currentProductsSort.direction === 'asc' });

                 const { data: products, error } = await query;

                 if (error) {
                     console.error('Erro ao buscar produtos para exportação:', error);
                     showToast('Erro ao exportar produtos: ' + error.message, 'error');
                     return;
                 }

                 if (!products || products.length === 0) {
                     showToast('Nenhum produto encontrado para exportação', 'warning');
                     return;
                 }

                 // Gerar CSV
                 const headers = ['Código', 'Descrição', 'Qtd. Atual', 'Qtd. Contada', 'Qtd. Bipada', 'Status', 'Sessão', 'Data Criação'];
                 let csv = headers.join(',') + '\n';

                 products.forEach(product => {
                     const row = [
                         `"${product.codigo}"`,
                         `"${product.descricao}"`,
                         product.quantidade_atual || 0,
                         product.quantidade_contada || 0,
                         product.scanned_qty || 0,
                         product.is_counted ? 'Contado' : 'Pendente',
                         `"Sessão ${product.session_id || 'N/A'}"`,
                         `"${new Date(product.created_at).toLocaleDateString('pt-BR')}"`
                     ];
                     csv += row.join(',') + '\n';
                 });

                 // Download do arquivo
                 const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                 const link = document.createElement('a');
                 const url = URL.createObjectURL(blob);
                 link.setAttribute('href', url);
                 link.setAttribute('download', `produtos_${new Date().toISOString().split('T')[0]}.csv`);
                 link.style.visibility = 'hidden';
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);

                 showToast(`${products.length} produtos exportados com sucesso!`, 'success');

             } catch (error) {
                 console.error('Erro ao exportar produtos:', error);
                 showToast('Erro ao exportar produtos', 'error');
             }
         }

         // Event listeners para página de produtos
         document.addEventListener('DOMContentLoaded', function() {
             // Filtros
             document.getElementById('product-search')?.addEventListener('input', debounce(applyProductsFilters, 500));
             document.getElementById('session-filter')?.addEventListener('change', applyProductsFilters);
             document.getElementById('counted-filter')?.addEventListener('change', applyProductsFilters);
             document.getElementById('clear-products-filters-btn')?.addEventListener('click', clearProductsFilters);

             // Botões de ação
             document.getElementById('refresh-products-btn')?.addEventListener('click', () => {
                 loadProducts();
                 loadSessionsForFilter();
             });
             document.getElementById('export-products-btn')?.addEventListener('click', exportProducts);

             // Paginação
             document.getElementById('products-prev-btn')?.addEventListener('click', () => {
                 if (currentProductsPage > 1) {
                     currentProductsPage--;
                     loadProducts();
                 }
             });
             document.getElementById('products-next-btn')?.addEventListener('click', () => {
                 const totalPages = Math.ceil(totalProducts / productsPerPage);
                 if (currentProductsPage < totalPages) {
                     currentProductsPage++;
                     loadProducts();
                 }
             });

             // Ordenação
             document.querySelectorAll('#products-table th[data-sort]').forEach(th => {
                 th.addEventListener('click', () => {
                     const field = th.getAttribute('data-sort');
                     sortProducts(field);
                 });
             });

             // Carregar dados quando a página de produtos for ativada
             const observer = new MutationObserver(function(mutations) {
                 mutations.forEach(function(mutation) {
                     if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                         const produtosPage = document.getElementById('produtos-page');
                         if (produtosPage && !produtosPage.classList.contains('hidden')) {
                             loadProducts();
                             loadSessionsForFilter();
                         }
                     }
                 });
             });

             const produtosPage = document.getElementById('produtos-page');
             if (produtosPage) {
                 observer.observe(produtosPage, { attributes: true });
             }
         });

         // Função debounce para otimizar pesquisa
         function debounce(func, wait) {
             let timeout;
             return function executedFunction(...args) {
                 const later = () => {
                     clearTimeout(timeout);
                     func(...args);
                 };
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
             };
         }

         // Função para gerar CSV de contagem
         function generateCountingCSV(session, countedProducts, config) {
             // Definir configurações padrão se não existirem
             const exportConfig = {
                 exportacao_incluir_codigo: true, // Sempre incluído
                 exportacao_incluir_quantidade: true, // Sempre incluído (quantidade_contada)
                 exportacao_incluir_descricao: config?.exportacao_incluir_descricao || false,
                 exportacao_incluir_localizacao: config?.exportacao_incluir_localizacao || false
             };

             // Construir cabeçalho do CSV baseado nas configurações
             let headers = [];
             if (exportConfig.exportacao_incluir_codigo) headers.push('codigo');
             if (exportConfig.exportacao_incluir_quantidade) headers.push('quantidade_contada');
             if (exportConfig.exportacao_incluir_descricao) headers.push('descricao');
             if (exportConfig.exportacao_incluir_localizacao) headers.push('localizacao');

             let csv = headers.join(',') + '\n';

             // Processar produtos contados
             if (countedProducts && countedProducts.length > 0) {
                 countedProducts.forEach(product => {
                     let row = [];
                     
                     if (exportConfig.exportacao_incluir_codigo) {
                         row.push(product.codigo || ''); 
                     }
                     
                     if (exportConfig.exportacao_incluir_quantidade) {
                         // Usar a quantidade contada do produto
                         const totalQuantity = product.quantidade_contada || 0;
                         row.push(totalQuantity);
                     }
                     
                     if (exportConfig.exportacao_incluir_descricao) {
                         row.push(`"${product.descricao || ''}"`); 
                     }
                     
                     if (exportConfig.exportacao_incluir_localizacao) {
                         row.push(`"${product.localizacao || ''}"`); 
                     }
                     
                     csv += row.join(',') + '\n';
                 });
             }

             return csv;
         }

         // Função para download de CSV da sessão
         async function downloadSessionCSV(sessionId) {
             try {
                 // Buscar dados da sessão
                const { data: session, error: sessionError } = await supabase
                    .from('counting_sessions')
                    .select('*')
                    .eq('id', sessionId)
                    .single();

                if (sessionError) throw sessionError;

                // Buscar dados do usuário separadamente
                const { data: userProfile, error: userError } = await supabase
                    .from('user_profiles')
                    .select('name')
                    .eq('id', session.user_id)
                    .single();

                // Adicionar nome do usuário à sessão (se encontrado)
                 if (userProfile && !userError) {
                     session.user_name = userProfile.name;
                 }

                 // Buscar produtos contados da sessão com informações completas
                 const { data: countedProducts, error: productsError } = await supabase
                     .from('products')
                     .select(`
                         codigo,
                         descricao,
                         quantidade_contada,
                         scanned_qty
                     `)
                     .eq('session_id', sessionId)
                     .gt('quantidade_contada', 0);

                 if (productsError) throw productsError;

                 // Carregar configurações de exportação
                 const { data: config } = await supabase
                     .from('configuracao_estoque')
                     .select('*')
                     .limit(1)
                     .single();

                 // Gerar CSV com base nas configurações
                 const csvContent = generateCountingCSV(session, countedProducts, config);
                 
                 // Criar nome do arquivo: Contagem-nome_da_sessao-data.csv
                 const sessionName = (session.session_name || 'Sessao').replace(/[^a-zA-Z0-9]/g, '_');
                 const date = new Date().toISOString().split('T')[0];
                 const filename = `Contagem-${sessionName}-${date}.csv`;

                 // Criar e baixar o arquivo com seletor de pasta
                 const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                 
                 // Verificar se o navegador suporta File System Access API
                 if ('showSaveFilePicker' in window) {
                     try {
                         const fileHandle = await window.showSaveFilePicker({
                             suggestedName: filename,
                             types: [{
                                 description: 'Arquivos CSV',
                                 accept: { 'text/csv': ['.csv'] }
                             }]
                         });
                         const writable = await fileHandle.createWritable();
                         await writable.write(blob);
                         await writable.close();
                     } catch (err) {
                         if (err.name !== 'AbortError') {
                             console.error('Erro ao salvar arquivo:', err);
                             // Fallback para download automático
                             const link = document.createElement('a');
                             const url = URL.createObjectURL(blob);
                             link.setAttribute('href', url);
                             link.setAttribute('download', filename);
                             link.style.visibility = 'hidden';
                             document.body.appendChild(link);
                             link.click();
                             document.body.removeChild(link);
                         }
                     }
                 } else {
                     // Fallback para navegadores que não suportam File System Access API
                     const link = document.createElement('a');
                     const url = URL.createObjectURL(blob);
                     link.setAttribute('href', url);
                     link.setAttribute('download', filename);
                     link.style.visibility = 'hidden';
                     document.body.appendChild(link);
                     link.click();
                     document.body.removeChild(link);
                 }

                 showToast('Arquivo CSV baixado com sucesso!', 'success');
             } catch (error) {
                 console.error('Erro ao baixar CSV:', error);
                 showToast('Erro ao baixar arquivo CSV', 'error');
             }
         }
     </script>

     <!-- Sidebar para Nova Contagem -->
     <div id="new-session-sidebar" class="sidebar-overlay">
         <div class="sidebar-content">
             <div class="sidebar-header">
                 <h3><i class="fas fa-plus-circle"></i> Nova Contagem</h3>
                 <button id="close-sidebar-btn" class="close-btn">
                     <i class="fas fa-times"></i>
                 </button>
             </div>
             
             <div class="sidebar-body">
                 <form id="new-session-form">
                     <div class="form-group">
                         <label for="session-user">Usuário da Sessão *</label>
                         <select id="session-user" name="user_id" class="form-control" required>
                             <option value="">Selecione um usuário</option>
                         </select>
                     </div>
                     
                     <div class="form-group">
                         <label for="sidebar-count-type">Tipo de Contagem *</label>
                         <select id="sidebar-count-type" name="count_type" class="form-control" required>
                             <option value="">Selecione o tipo</option>
                             <option value="normal">Contagem com Arquivo</option>
                             <option value="avulsa">Contagem Avulsa</option>
                         </select>
                     </div>
                     

                     
                     <div class="form-group">
                         <label for="sidebar-session-name">Nome da Sessão *</label>
                         <input type="text" id="sidebar-session-name" name="session_name" class="form-control" 
                                placeholder="Ex: Contagem Estoque Janeiro 2024" required>
                     </div>
                     
                     <div class="form-group">
                         <label for="session-description">Descrição</label>
                         <textarea id="session-description" name="description" class="form-control" rows="3" 
                                   placeholder="Descrição opcional da contagem..."></textarea>
                     </div>
                 </form>
             </div>
             
             <div class="sidebar-footer">
                 <button type="button" id="cancel-session-btn" class="btn btn-secondary">
                     <i class="fas fa-times"></i> Cancelar
                 </button>
                 <button type="submit" id="save-session-btn" class="btn btn-primary" form="new-session-form">
                     <i class="fas fa-save"></i> Salvar Contagem
                 </button>
             </div>
         </div>
     </div>

     <script>

     </script>
 </body>
 </html>